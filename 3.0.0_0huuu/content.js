function performAutomaticAutopinTest(){try{manuallyUnpinnedNodes.clear();const e=document.querySelectorAll('[data-test-id*="node"], .node-default, [class*="node-"]');if(0===e.length)return;let t={codeNodes:0,httpNodes:0,aiNodes:0,otherNodes:0,totalNodes:e.length,testsPassed:0,testsFailed:0};if(e.forEach(((e,n)=>{try{const n=getNodeType(e);if("code"===n){t.codeNodes++;try{pinNodeExecution(e,n),t.testsPassed++}catch(e){t.testsFailed++}}else"http"===n?t.httpNodes++:"ai"===n?t.aiNodes++:t.otherNodes++}catch(e){t.testsFailed++}})),t.codeNodes>0){const e=`🧪 Autopin Test: ${t.codeNodes} Code nodes found, ${t.testsPassed} tests passed, ${t.testsFailed} failed`;showNotificationInPage("success",e)}}catch(e){showNotificationInPage("error","🧪 Autopin test failed to run")}}function exportFromIndexedDBDirect(e,t){return new Promise(((n,o)=>{const a=indexedDB.open(e);a.onerror=()=>{o(new Error(`Failed to open ${e}: ${a.error?.message||"Unknown error"}`))},a.onsuccess=()=>{const i=a.result;if(!i.objectStoreNames.contains(t))return void n([]);const r=i.transaction([t],"readonly"),s=r.objectStore(t).getAll();s.onsuccess=()=>{const e=s.result;n(e)},s.onerror=()=>{o(new Error(`Failed to read from ${e}.${t}: ${s.error?.message||"Unknown error"}`))},r.onerror=()=>{o(new Error(`Transaction failed for ${e}.${t}: ${r.error?.message||"Unknown error"}`))}},a.onupgradeneeded=()=>{n([])}}))}function importToIndexedDBDirect(e,t,n){return new Promise(((o,a)=>{const i=indexedDB.open(e);i.onerror=()=>{a(new Error(`Failed to open ${e}: ${i.error?.message||"Unknown error"}`))},i.onsuccess=()=>{const r=i.result;if(!r.objectStoreNames.contains(t))return void o(0);const s=r.transaction([t],"readwrite"),d=s.objectStore(t),l=d.clear();l.onsuccess=()=>{if(0===n.length)return void o(0);let e=0,t=!1;n.forEach(((i,r)=>{const s=d.add(i);s.onsuccess=()=>{e++,e!==n.length||t||o(e)},s.onerror=()=>{t=!0,a(new Error(`Failed to import item ${r}: ${s.error?.message||"Unknown error"}`))}}))},l.onerror=()=>{a(new Error(`Failed to clear ${e}.${t}: ${l.error?.message||"Unknown error"}`))},s.onerror=()=>{a(new Error(`Transaction failed for ${e}.${t}: ${s.error?.message||"Unknown error"}`))}},i.onupgradeneeded=()=>{a(new Error(`Database ${e} structure is incompatible`))}}))}function initializeTemplatesLinkReplacement(){startTemplatesLinkMonitoring(),chrome.storage.onChanged.addListener(((e,t)=>{"local"===t&&e.showTemplates&&(e.showTemplates.newValue?(replaceWorkflowLinks(),startTemplatesLinkMonitoring()):(restoreOriginalLinks(),stopTemplatesLinkMonitoring()))})),chrome.storage.local.get(["showTemplates"]).then((e=>{e.showTemplates&&replaceWorkflowLinks()})).catch((e=>{}))}function startTemplatesLinkMonitoring(){window.templatesLinkObserver||(window.templatesLinkObserver=new MutationObserver((e=>{let t=!1;e.forEach((e=>{"childList"===e.type&&e.addedNodes.length>0&&e.addedNodes.forEach((e=>{e.nodeType===Node.ELEMENT_NODE&&("A"===e.tagName||e.querySelector&&e.querySelector('a[href*="n8n.io/workflows"]'))&&(t=!0)}))})),t&&setTimeout((()=>{replaceWorkflowLinks()}),100)})),window.templatesLinkObserver.observe(document.body,{childList:!0,subtree:!0}),window.templatesLinkInterval=setInterval((()=>{replaceWorkflowLinks()}),5e3))}function stopTemplatesLinkMonitoring(){window.templatesLinkObserver&&(window.templatesLinkObserver.disconnect(),window.templatesLinkObserver=null),window.templatesLinkInterval&&(clearInterval(window.templatesLinkInterval),window.templatesLinkInterval=null)}function replaceWorkflowLinks(){try{const e=document.querySelectorAll('a[href^="https://n8n.io/workflows"]');if(0===e.length)return;e.forEach(((e,t)=>{e.dataset.originalHref||(e.dataset.originalHref=e.href);const n="https://github.com/djeknet/n8n-master-workflows";e.href!==n&&(e.href=n,e.dataset.templatesModified||(e.dataset.templatesModified="true",e.style.borderLeft="3px solid #4a90e2",e.style.paddingLeft="8px",e.title="Link redirected to N8N Master Templates (GitHub)"))}))}catch(e){}}function restoreOriginalLinks(){try{const e=document.querySelectorAll('a[data-templates-modified="true"]');if(0===e.length)return;e.forEach(((e,t)=>{e.dataset.originalHref&&(e.href=e.dataset.originalHref,delete e.dataset.templatesModified,delete e.dataset.originalHref,e.style.borderLeft="",e.style.paddingLeft="",e.title="")}))}catch(e){}}window.checkN8nMaster=function(){const e=document.getElementById("n8n-master-chat-widget");document.getElementById("n8n-node-count");return{loaded:!0,chatWidget:!!e,nodeCount:getTotalNodeCount(),n8nStore:!(!window.n8n||!window.n8n.store)}},window.quickTestWorkflow=function(){if(getTotalNodeCount()>0&&window.n8n&&window.n8n.store&&window.n8n.store.state&&window.n8n.store.state.workflows&&window.n8n.store.state.workflows.workflow){return window.n8n.store.state.workflows.workflow}return null},setTimeout((()=>{}),1e3),function(){"use strict";let isN8nPage=!1,isActivated=!1,chatWidget=null,floatingButton=null,autoSaveObserver=null,autoPinObserver=null,nodeCountInterval=null,lastExecutionState=new Map,manuallyUnpinnedNodes=new Set,historyMonitoringActive=!1,currentURL=window.location.href,isCurrentlyActive=!1;async function checkActivationAndInit(){try{if(window.n8nMasterCleanup||setupSPANavigation(),!detectN8nPage())return;const e=window.location.origin,{activatedSites:t=[]}=await chrome.storage.local.get("activatedSites");t.includes(e)?(isCurrentlyActive=!0,init()):isCurrentlyActive=!1}catch(e){}}window.n8nMasterLoaded=!0,document.addEventListener("contextmenu",(function(e){window.n8nMasterContextTarget=e.target,setTimeout((()=>{window.n8nMasterContextTarget===e.target&&(window.n8nMasterContextTarget=null)}),1e4)}));try{"loading"===document.readyState?document.addEventListener("DOMContentLoaded",checkActivationAndInit):checkActivationAndInit()}catch(e){}async function init(){if(detectN8nPage()){setTimeout((()=>{getTotalNodeCount();extractCurrentWorkflow().then((e=>{})).catch((e=>{}))}),2e3);try{window.I18nManager&&(await window.I18nManager.init(),document.addEventListener("languageChanged",(e=>{updateContentLocalization()})),setTimeout((()=>{updateContentLocalization()}),1e3)),await initializeChatWidget(),initializeAutoSave(),initializeNodeCreatorAutoClose(),initializeAutoPin(),await initializeLocalProjects(),await initializeLocalVariables(),initializeWorkflowHistory(),startNodeCountMonitoring(),addExportCurlButtons(),window.TestStepMonitor&&window.TestStepMonitor.ErrorAnalyzer&&setTimeout((()=>{window.TestStepMonitor.ErrorAnalyzer.init()}),2e3),chrome.storage.onChanged.addListener(((e,t)=>{"local"===t&&e.showTemplates&&checkAndCreateTemplatesButton(),"local"===t&&e.aiErrorTrigger&&window.TestStepMonitor&&window.TestStepMonitor.ErrorAnalyzer&&(e.aiErrorTrigger.newValue?window.TestStepMonitor.ErrorAnalyzer.init():window.TestStepMonitor.ErrorAnalyzer.stop()),"local"===t&&e.workflowExecution&&(e.workflowExecution.newValue?initializeWorkflowExecutionCopy():cleanupWorkflowExecutionCopy())})),chrome.storage.local.get(["workflowExecution"]).then((e=>{e.workflowExecution&&initializeWorkflowExecutionCopy()})).catch((e=>{})),initializeTemplatesLinkReplacement(),window.addMessageToChat=addMessageToChat,window.showChatWidget=showChatWidget,window.removeMessageFromChat=removeMessageFromChat,document.addEventListener("n8nMasterShowAnalyzing",(e=>{if(e.detail&&e.detail.sender&&e.detail.message){const t=e.detail.isLoading||!1;addMessageToChat(e.detail.sender,e.detail.message,t)}})),document.addEventListener("n8nMasterAIResponse",(e=>{e.detail&&e.detail.sender&&e.detail.message&&addMessageToChat(e.detail.sender,e.detail.message)})),chrome.runtime.onMessage.addListener(((e,t,n)=>{"languageChanged"===e.action&&window.I18nManager&&window.I18nManager.setLanguage(e.language).then((()=>{setTimeout((()=>{updateContentLocalization()}),100)}))}))}catch(e){}}}function getLocalizedChatPlaceholder(){return window.I18nManager?window.I18nManager.getMessage("createWorkflow"):"Create a workflow..."}function updateAllChatPlaceholders(){const e=getLocalizedChatPlaceholder(),t=document.querySelector("#n8n-master-chat-input");t&&(t.placeholder=e);document.querySelectorAll('input[placeholder*="workflow"], input[placeholder*="Create a workflow"]').forEach((t=>{("n8n-master-chat-input"===t.id||t.placeholder.includes("Create a workflow"))&&(t.placeholder=e)}))}function updateContentLocalization(){try{updateAllChatPlaceholders(),"function"==typeof updateCopyButtonTexts&&updateCopyButtonTexts();const e=document.querySelector("#templates-search-input");e&&window.I18nManager&&(e.placeholder=window.I18nManager.getMessage("templatesSearch")),updateChatWidgetLocalization(),updateTemplatesWidgetLocalization(),window.LocalProjectsManager&&window.LocalProjectsManager.updateLocalization&&window.LocalProjectsManager.updateLocalization(),window.LocalVariablesManager&&window.LocalVariablesManager.updateLocalization&&window.LocalVariablesManager.updateLocalization(),window.I18nManager&&window.I18nManager.localizeDOM&&window.I18nManager.localizeDOM()}catch(e){}}function updateChatWidgetLocalization(){if(window.I18nManager)try{const e=document.querySelector("#n8n-chat-messages");if(e){const t=e.querySelector(".welcome-message");t&&(t.innerHTML=`\n            👋 ${window.I18nManager.getMessage("chatWelcome")}\n            <br><br>\n            ${window.I18nManager.getMessage("chatWelcome2")}\n          `)}const t=document.querySelector("#n8n-chat-fullscreen");t&&(t.title=window.I18nManager.getMessage("chatFullscreen"));const n=document.querySelector("#n8n-chat-clear");n&&(n.title=window.I18nManager.getMessage("chatClearHistory"))}catch(e){}}function updateTemplatesWidgetLocalization(){if(window.I18nManager)try{const e=document.querySelector("#templates-title");if(e){const t=e.textContent.match(/\((\d+)\)/),n=t?t[1]:"0";e.textContent=`${window.I18nManager.getMessage("templatesTitle")} (${n})`}const t=document.querySelector("#templates-search-btn");t&&(t.title=window.I18nManager.getMessage("templatesSearchTitle"));const n=document.querySelector("#templates-content");if(n){const e=n.querySelector('div[style*="text-align: center"]');e&&e.textContent.includes("Loading")&&(e.textContent=window.I18nManager.getMessage("templatesLoading"))}}catch(e){}}function detectN8nPage(){window.location.href;const e=window.location.hostname,t=window.location.pathname,n=e.includes("n8n.cloud")||e.includes("n8n.io"),o="localhost"===e||"127.0.0.1"===e,a=document.querySelector("#app")||document.querySelector("[data-test-id]")||document.title.includes("n8n"),i=document.title.toLowerCase().includes("n8n"),r=t.includes("/workflow/");return(n||o&&a||i)&&r}async function initializeChatWidget(){try{const e=await chrome.storage.local.get(["aiProvider","apiKeys"]);if(!e.apiKeys||!e.apiKeys[e.aiProvider])return;createFloatingButton(),addExportCurlButtons(),initializeAutoSave(),initializeAutoPin(),initializeWorkflowHistory(),await initializeDialogManager()}catch(e){}}async function initializeDialogManager(){try{if("undefined"==typeof DialogManager)return;await DialogManager.init();if(await DialogManager.isRememberDialogEnabled()){const e=getCurrentWorkflowId();e&&await loadChatHistory(e)}}catch(e){}}async function loadChatHistory(e){try{if(!e||"undefined"==typeof DialogManager)return;const t=await DialogManager.loadDialog(e);if(t&&t.length>0){const e=document.getElementById("n8n-chat-messages");e&&(e.innerHTML="");let n=0;t.forEach((e=>{addMessageToChatDisplay(e.sender,e.message)&&n++})),e&&(e.scrollTop=e.scrollHeight)}}catch(e){}}async function saveChatMessage(e,t){try{if("undefined"==typeof DialogManager)return;const n=getCurrentWorkflowId();if(!n)return;await DialogManager.addMessage(n,e,t)}catch(e){}}function addMessageToChatDisplay(e,t){const n=document.getElementById("n8n-chat-messages");if(!n)return null;const o=`msg-${e}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,a=document.createElement("div");if(a.id=o,a.setAttribute("data-message-id",o),a.style.cssText=`\n      padding: 12px;\n      border-radius: 8px;\n      font-size: 14px;\n      line-height: 1.4;\n      max-width: 85%;\n      word-wrap: break-word;\n      ${"user"===e?"background: #ff4757; color: white; margin-left: auto; text-align: right; border: 1px solid #ff6b7a;":"background: #3a3a3a; color: #cccccc; margin-right: auto; border: 1px solid #444444;"}\n    `,"assistant"===e){const e=markdownToHtml(t);a.innerHTML=`<div class="message-content">${e}</div>`}else a.innerHTML=`<div class="message-content">${t}</div>`;return n.appendChild(a),o}function createFloatingButton(){if(!floatingButton){floatingButton=document.createElement("div"),floatingButton.id="n8n-master-floating-btn";try{const e=chrome.runtime.getURL("icons/icon16.png"),t=window.I18nManager?window.I18nManager.getMessage("askN8nMaster"):"ASK N8N MASTER";floatingButton.innerHTML=`<img src="${e}" width="16" height="16" style="margin-right: 8px; vertical-align: middle;" onerror="this.outerHTML='🤖'"> ${t}`}catch(e){const t=window.I18nManager?window.I18nManager.getMessage("askN8nMaster"):"ASK N8N MASTER";floatingButton.innerHTML=`🤖 ${t}`}floatingButton.style.cssText="\n      position: fixed;\n      bottom: 20px;\n      right: 20px;\n      background: #2a2a2a;\n      color: #ffffff;\n      padding: 12px 20px;\n      border-radius: 8px;\n      cursor: pointer;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      font-size: 14px;\n      font-weight: 600;\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4), 0 0 0 1px #ff4757;\n      z-index: 9999;\n      transition: all 0.3s ease;\n      user-select: none;\n      border: 1px solid #ff4757;\n      backdrop-filter: blur(10px);\n      min-width: 186px;\n      min-height: 42px;\n      text-align: center;\n    ",floatingButton.addEventListener("mouseenter",(()=>{floatingButton.style.transform="translateY(-2px)",floatingButton.style.boxShadow="0 6px 16px rgba(0, 0, 0, 0.6), 0 0 0 1px #ff6b7a",floatingButton.style.borderColor="#ff6b7a"})),floatingButton.addEventListener("mouseleave",(()=>{floatingButton.style.transform="translateY(0)",floatingButton.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.4), 0 0 0 1px #ff4757",floatingButton.style.borderColor="#ff4757"})),floatingButton.addEventListener("click",toggleChatWidget),document.body.appendChild(floatingButton),checkAndCreateTemplatesButton()}}async function checkAndCreateTemplatesButton(){try{if(!detectN8nPage())return void(window.templatesButton&&(window.templatesButton.remove(),window.templatesButton=null));const e=await chrome.storage.local.get(["showTemplates"]);e.showTemplates||!1?createTemplatesButton():window.templatesButton&&(window.templatesButton.remove(),window.templatesButton=null)}catch(e){}}function createTemplatesButton(){window.templatesButton||(window.templatesButton=document.createElement("div"),window.templatesButton.id="n8n-master-templates-btn",window.templatesButton.innerHTML="📋",window.templatesButton.style.cssText="\n      position: fixed;\n      bottom: 20px;\n      right: 220px;\n      background: #2a2a2a;\n      color: #ffffff;\n      width: 43px;\n      height: 43px;\n      border-radius: 50%;\n      cursor: pointer;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      font-size: 20px;\n      font-weight: 600;\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4), 0 0 0 1px #4a90e2;\n      z-index: 9999;\n      transition: all 0.3s ease;\n      user-select: none;\n      border: 1px solid #4a90e2;\n      backdrop-filter: blur(10px);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    ",window.templatesButton.addEventListener("mouseenter",(()=>{window.templatesButton.style.transform="translateY(-2px)",window.templatesButton.style.boxShadow="0 6px 16px rgba(0, 0, 0, 0.6), 0 0 0 1px #5ca0f2",window.templatesButton.style.borderColor="#5ca0f2"})),window.templatesButton.addEventListener("mouseleave",(()=>{window.templatesButton.style.transform="translateY(0)",window.templatesButton.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.4), 0 0 0 1px #4a90e2",window.templatesButton.style.borderColor="#4a90e2"})),window.templatesButton.addEventListener("click",toggleTemplatesWidget),document.body.appendChild(window.templatesButton))}function toggleChatWidget(){chatWidget&&"none"!==chatWidget.style.display?hideChatWidget():showChatWidget()}function toggleTemplatesWidget(){window.templatesWidget&&"none"!==window.templatesWidget.style.display?hideTemplatesWidget():showTemplatesWidget()}function showTemplatesWidget(){window.templatesWidget||createTemplatesWidget(),window.templatesWidget.style.display="flex",window.templatesWidget.style.opacity="0",window.templatesWidget.style.transform="translateY(20px)",setTimeout((()=>{window.templatesWidget.style.opacity="1",window.templatesWidget.style.transform="translateY(0)"}),10),window.templatesData?renderTemplatesList(window.templatesData):loadTemplatesData()}function hideTemplatesWidget(){window.templatesWidget&&(window.templatesWidget.style.opacity="0",window.templatesWidget.style.transform="translateY(20px)",setTimeout((()=>{window.templatesWidget.style.display="none"}),300))}async function showChatWidget(){chatWidget||createChatWidget(),chatWidget.style.display="flex",chatWidget.style.opacity="0",chatWidget.style.transform="translateY(20px)",setTimeout((()=>{chatWidget.style.opacity="1",chatWidget.style.transform="translateY(0)"}),10),startNodeCountMonitoring();try{if("undefined"!=typeof DialogManager){if(await DialogManager.isRememberDialogEnabled()){const e=getCurrentWorkflowId();e&&await loadChatHistory(e)}}}catch(e){}}function hideChatWidget(){chatWidget&&(chatWidget.style.opacity="0",chatWidget.style.transform="translateY(20px)",setTimeout((()=>{chatWidget.style.display="none"}),300))}function toggleChatFullscreen(){if(!chatWidget)return;const e=chatWidget.classList.contains("fullscreen"),t=document.getElementById("n8n-chat-fullscreen"),n=document.getElementById("n8n-chat-input"),o=document.querySelector('[data-test-id="node-creator-plus-button"]');if(e){if(chatWidget.classList.remove("fullscreen"),chatWidget.style.cssText="\n        position: fixed;\n        bottom: 80px;\n        right: 20px;\n        width: 400px;\n        height: 500px;\n        background: #1e1e1e;\n        border-radius: 8px;\n        box-shadow: 0 10px 40px rgba(0,0,0,0.6), 0 0 0 1px #333333;\n        z-index: 9999;\n        display: flex;\n        flex-direction: column;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n        transition: all 0.3s ease;\n        border: 1px solid #333333;\n        pointer-events: auto;\n        backdrop-filter: blur(10px);\n      ","TEXTAREA"===n.tagName){const e=document.createElement("input");e.id="n8n-chat-input",e.type="text",e.placeholder=n.placeholder,e.value=n.value,e.style.cssText="\n          width: 100%;\n          padding: 12px 40px 12px 12px;\n          border: 1px solid #444444;\n          border-radius: 6px;\n          font-size: 14px;\n          outline: none;\n          transition: border-color 0.2s;\n          background: #1e1e1e;\n          color: #ffffff;\n          box-sizing: border-box;\n        ",n.parentNode.replaceChild(e,n);const t=document.getElementById("n8n-chat-input");t.addEventListener("focus",(e=>{e.stopPropagation(),e.target.style.borderColor="#ff4757",e.target.style.boxShadow="0 0 0 2px rgba(255, 71, 87, 0.2)"})),t.addEventListener("blur",(e=>{e.stopPropagation(),e.target.style.borderColor="#444444",e.target.style.boxShadow="none"})),t.addEventListener("keypress",(e=>{e.stopPropagation(),"Enter"===e.key&&(e.preventDefault(),sendChatMessage())})),t.addEventListener("keydown",(e=>e.stopPropagation())),t.addEventListener("keyup",(e=>e.stopPropagation())),t.addEventListener("input",(e=>e.stopPropagation())),t.addEventListener("focus",(e=>e.stopPropagation())),t.addEventListener("blur",(e=>e.stopPropagation())),t.focus()}else n.style.height="auto",n.style.minHeight="auto",n.style.resize="none",n.rows=1;t.innerHTML="⛶",t.title="Expand to full screen",o&&o.dataset.originalRight&&(o.style.position=o.dataset.originalPosition,o.style.right=o.dataset.originalRight,o.style.top=o.dataset.originalTop,o.style.bottom=o.dataset.originalBottom,o.style.transition="right 0.3s ease, top 0.3s ease",setTimeout((()=>{delete o.dataset.originalRight,delete o.dataset.originalBottom,delete o.dataset.originalTop,delete o.dataset.originalPosition,o.style.transition=""}),300))}else{chatWidget.classList.add("fullscreen");const e=document.querySelector('[data-test-id="canvas-header"]')?.offsetHeight||60,a=window.innerHeight-e-20;if(chatWidget.style.cssText=`\n        position: fixed;\n        top: ${e+10}px;\n        right: 20px;\n        width: 400px;\n        height: ${a}px;\n        background: #1e1e1e;\n        border-radius: 8px;\n        box-shadow: 0 10px 40px rgba(0,0,0,0.6), 0 0 0 1px #333333;\n        z-index: 9999;\n        display: flex;\n        flex-direction: column;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n        transition: all 0.3s ease;\n        border: 1px solid #333333;\n        pointer-events: auto;\n        backdrop-filter: blur(10px);\n      `,setTimeout((()=>{if("INPUT"===n.tagName){const e=document.createElement("textarea");e.id="n8n-chat-input",e.placeholder=n.placeholder,e.value=n.value,e.rows=3,e.style.cssText="\n            width: 100%;\n            padding: 12px 40px 12px 12px;\n            border: 1px solid #444444;\n            border-radius: 6px;\n            font-size: 14px;\n            outline: none;\n            transition: border-color 0.2s;\n            background: #1e1e1e;\n            color: #ffffff;\n            box-sizing: border-box;\n            resize: vertical;\n            min-height: 60px;\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n          ",n.parentNode.replaceChild(e,n);const t=document.getElementById("n8n-chat-input");t.addEventListener("focus",(e=>{e.stopPropagation(),e.target.style.borderColor="#ff4757",e.target.style.boxShadow="0 0 0 2px rgba(255, 71, 87, 0.2)"})),t.addEventListener("blur",(e=>{e.stopPropagation(),e.target.style.borderColor="#444444",e.target.style.boxShadow="none"})),t.addEventListener("keypress",(e=>{e.stopPropagation(),"Enter"!==e.key||e.shiftKey||(e.preventDefault(),sendChatMessage())})),t.addEventListener("keydown",(e=>e.stopPropagation())),t.addEventListener("keyup",(e=>e.stopPropagation())),t.addEventListener("input",(e=>e.stopPropagation())),t.addEventListener("focus",(e=>e.stopPropagation())),t.addEventListener("blur",(e=>e.stopPropagation())),t.focus()}}),50),t.innerHTML="🗕",t.title="Exit full screen",o){if(!o.dataset.originalRight){const e=window.getComputedStyle(o);o.dataset.originalRight=e.right||"auto",o.dataset.originalBottom=e.bottom||"auto",o.dataset.originalTop=e.top||"auto",o.dataset.originalPosition=e.position||"static"}const e=document.querySelector('[data-test-id="canvas-header"]')?.offsetHeight||60;o.style.position="fixed",o.style.right="450px",o.style.top=`${e+20}px`,o.style.bottom="auto",o.style.transition="right 0.3s ease, top 0.3s ease"}}}function initializeNodeCreatorAutoClose(){document.addEventListener("click",(e=>{e.target.closest('[data-test-id="node-creator-plus-button"]')&&chatWidget&&"none"!==chatWidget.style.display&&setTimeout((()=>{hideChatWidget()}),100)}))}function createChatWidget(){chatWidget=document.createElement("div"),chatWidget.id="n8n-master-chat-widget",chatWidget.style.cssText="\n      position: fixed;\n      bottom: 80px;\n      right: 20px;\n      width: 400px;\n      height: 500px;\n      background: #1e1e1e;\n      border-radius: 8px;\n      box-shadow: 0 10px 40px rgba(0,0,0,0.6), 0 0 0 1px #333333;\n      z-index: 9999;\n      display: none;\n      flex-direction: column;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      transition: all 0.3s ease;\n      border: 1px solid #333333;\n      pointer-events: auto;\n      backdrop-filter: blur(10px);\n    ",chatWidget.addEventListener("click",(e=>e.stopPropagation())),chatWidget.addEventListener("keydown",(e=>e.stopPropagation())),chatWidget.addEventListener("keyup",(e=>e.stopPropagation())),chatWidget.addEventListener("keypress",(e=>e.stopPropagation())),chatWidget.innerHTML=`\n      <style>\n        @keyframes loading-dots {\n          0%, 20% { opacity: 0; }\n          50% { opacity: 1; }\n          100% { opacity: 0; }\n        }\n        \n        .loading-dots {\n          display: inline-block;\n        }\n        \n        .loading-dots::after {\n          content: '...';\n          animation: loading-dots 1.5s infinite;\n          font-weight: bold;\n        }\n        \n        .loading-dots::before {\n          content: '';\n          animation: loading-dots 1.5s infinite 0.5s;\n        }\n      </style>\n      \n      <div style="\n        padding: 16px 20px;\n        border-bottom: 1px solid #333333;\n        background: #2a2a2a;\n        color: #ffffff;\n        border-radius: 8px 8px 0 0;\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n      ">\n        <div style="display: flex; align-items: center; gap: 12px;">\n          <div style="font-weight: 600; font-size: 16px; display: flex; align-items: center;">\n            <img src="${chrome.runtime.getURL("icons/icon16.png")}" width="16" height="16" style="margin-right: 8px;" onerror="this.outerHTML='🤖'">\n            ${I18nManager?I18nManager.getMessage("chatTitle"):"N8N Master"}\n          </div>\n          <div id="n8n-node-count" style="\n            background: #1e1e1e;\n            border: 1px solid #444444;\n            border-radius: 4px;\n            padding: 4px 8px;\n            font-size: 12px;\n            font-weight: 500;\n            color: #cccccc;\n            min-width: 40px;\n            text-align: center;\n          ">0/0</div>\n        </div>\n        <div style="display: flex; align-items: center; gap: 8px;">\n          <button id="n8n-chat-fullscreen" style="\n            background: none;\n            border: none;\n            color: #ffffff;\n            font-size: 16px;\n            cursor: pointer;\n            padding: 4px;\n            width: 24px;\n            height: 24px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            border-radius: 4px;\n            transition: background 0.2s;\n          " title="${I18nManager?I18nManager.getMessage("chatFullscreen"):"Expand to full screen"}">⛶</button>\n          <button id="n8n-chat-clear" style="\n            background: none;\n            border: none;\n            color: #ffffff;\n            font-size: 16px;\n            cursor: pointer;\n            padding: 4px;\n            width: 24px;\n            height: 24px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            border-radius: 4px;\n            transition: background 0.2s;\n          " title="${I18nManager?I18nManager.getMessage("chatClearHistory"):"Clear chat history"}">🗑️</button>\n          <button id="n8n-chat-close" style="\n            background: none;\n            border: none;\n            color: #ffffff;\n            font-size: 18px;\n            cursor: pointer;\n            padding: 0;\n            width: 24px;\n            height: 24px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            border-radius: 4px;\n            transition: background 0.2s;\n          ">×</button>\n        </div>\n      </div>\n      \n      <div id="n8n-chat-messages" style="\n        flex: 1;\n        padding: 16px;\n        overflow-y: auto;\n        display: flex;\n        flex-direction: column;\n        gap: 12px;\n        background: #2d2d2d;\n      ">\n        <div class="welcome-message" style="\n          background: #3a3a3a;\n          padding: 12px;\n          border-radius: 8px;\n          font-size: 14px;\n          color: #cccccc;\n          border: 1px solid #444444;\n        ">\n          👋 ${I18nManager?I18nManager.getMessage("chatWelcome"):"Hi! I'm your N8N Master assistant. I can help you analyze workflows, create a new workflows, optimize prompts, and answer questions about your n8n setup."}\n          <br><br>\n          ${I18nManager?I18nManager.getMessage("chatWelcome2"):'Try asking: "What does this workflow do?" or "Analyze selected nodes"'}\n        </div>\n      </div>\n      \n      <div style="\n        padding: 16px;\n        border-top: 1px solid #333333;\n        background: #2a2a2a;\n        border-radius: 0 0 8px 8px;\n      ">\n        <div style="position: relative;">\n          <input \n            id="n8n-chat-input" \n            type="text" \n                            placeholder="${I18nManager?I18nManager.getMessage("createWorkflow"):"Create a workflow..."}"\n            style="\n              width: 100%;\n              padding: 12px 40px 12px 12px;\n              border: 1px solid #444444;\n              border-radius: 6px;\n              font-size: 14px;\n              outline: none;\n              transition: border-color 0.2s;\n              background: #1e1e1e;\n              color: #ffffff;\n              box-sizing: border-box;\n            "\n          />\n          <div style="\n            position: absolute;\n            right: 12px;\n            top: 50%;\n            transform: translateY(-50%);\n            color: #888888;\n            font-size: 16px;\n            pointer-events: none;\n          ">⏎</div>\n        </div>\n      </div>\n    `,document.body.appendChild(chatWidget);const e=document.createElement("style");e.textContent="\n      #n8n-chat-messages::-webkit-scrollbar {\n        width: 8px;\n      }\n      \n      #n8n-chat-messages::-webkit-scrollbar-track {\n        background: #1a1a1a;\n        border-radius: 4px;\n      }\n      \n      #n8n-chat-messages::-webkit-scrollbar-thumb {\n        background: #555555;\n        border-radius: 4px;\n        transition: background 0.2s;\n      }\n      \n      #n8n-chat-messages::-webkit-scrollbar-thumb:hover {\n        background: #666666;\n      }\n      \n      #n8n-chat-messages::-webkit-scrollbar-thumb:active {\n        background: #777777;\n      }\n      \n      /* For Firefox */\n      #n8n-chat-messages {\n        scrollbar-width: thin;\n        scrollbar-color: #555555 #1a1a1a;\n      }\n    ",document.head.appendChild(e),document.getElementById("n8n-chat-close").addEventListener("click",hideChatWidget);const t=document.getElementById("n8n-chat-clear");t.addEventListener("click",(e=>{e.stopPropagation(),clearChatHistory()}));const n=document.getElementById("n8n-chat-fullscreen");n.addEventListener("click",(e=>{e.stopPropagation(),toggleChatFullscreen()})),[n,t,document.getElementById("n8n-chat-close")].forEach((e=>{e.addEventListener("mouseenter",(()=>{e.style.background="rgba(255, 255, 255, 0.1)"})),e.addEventListener("mouseleave",(()=>{e.style.background="none"}))}));document.getElementById("n8n-chat-messages").addEventListener("click",(e=>{e.target.classList.contains("clickable-code")&&(e.stopPropagation(),selectCodeElement(e.target))}));const o=document.getElementById("n8n-chat-input");o.addEventListener("focus",(e=>{e.stopPropagation(),e.target.style.borderColor="#ff4757",e.target.style.boxShadow="0 0 0 2px rgba(255, 71, 87, 0.2)"})),o.addEventListener("blur",(e=>{e.stopPropagation(),e.target.style.borderColor="#444444",e.target.style.boxShadow="none"})),o.addEventListener("keypress",(e=>{e.stopPropagation(),"Enter"===e.key&&(e.preventDefault(),sendChatMessage())})),o.addEventListener("keydown",(e=>e.stopPropagation())),o.addEventListener("keyup",(e=>e.stopPropagation())),o.addEventListener("input",(e=>e.stopPropagation())),o.addEventListener("focus",(e=>e.stopPropagation())),o.addEventListener("blur",(e=>e.stopPropagation())),setTimeout((()=>{document.getElementById("n8n-chat-input").focus()}),100)}function createTemplatesWidget(){window.templatesWidget=document.createElement("div"),window.templatesWidget.id="n8n-master-templates-widget",window.templatesWidget.style.cssText="\n      position: fixed;\n      bottom: 80px;\n      right: 275px;\n      width: 450px;\n      height: 600px;\n      background: #1e1e1e;\n      border-radius: 8px;\n      box-shadow: 0 10px 40px rgba(0,0,0,0.6), 0 0 0 1px #333333;\n      z-index: 2000;\n      display: none;\n      flex-direction: column;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      transition: all 0.3s ease;\n      border: 1px solid #333333;\n      pointer-events: auto;\n      backdrop-filter: blur(10px);\n    ",window.templatesWidget.addEventListener("click",(e=>e.stopPropagation())),window.templatesWidget.addEventListener("keydown",(e=>e.stopPropagation())),window.templatesWidget.addEventListener("keyup",(e=>e.stopPropagation())),window.templatesWidget.addEventListener("keypress",(e=>e.stopPropagation())),window.templatesWidget.innerHTML=`\n      <div style="\n        padding: 16px 20px;\n        border-bottom: 1px solid #333333;\n        background: #2a2a2a;\n        color: #ffffff;\n        border-radius: 8px 8px 0 0;\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n      ">\n        <div style="display: flex; align-items: center; gap: 12px;">\n          <div id="templates-title" style="font-weight: 600; font-size: 16px;">\n            ${I18nManager?I18nManager.getMessage("templatesTitle"):"Templates"} (0)\n          </div>\n        </div>\n        <div style="display: flex; align-items: center; gap: 8px;">\n          <button id="templates-search-btn" style="\n            background: none;\n            border: none;\n            color: #ffffff;\n            font-size: 16px;\n            cursor: pointer;\n            padding: 4px;\n            width: 24px;\n            height: 24px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            border-radius: 4px;\n            transition: background 0.2s;\n          " title="${I18nManager?I18nManager.getMessage("templatesSearchTitle"):"Search templates"}">🔍</button>\n          <button id="templates-close" style="\n            background: none;\n            border: none;\n            color: #ffffff;\n            font-size: 18px;\n            cursor: pointer;\n            padding: 0;\n            width: 24px;\n            height: 24px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            border-radius: 4px;\n            transition: background 0.2s;\n          ">×</button>\n        </div>\n      </div>\n      \n      <div id="templates-search-container" style="\n        padding: 12px 16px;\n        border-bottom: 1px solid #333333;\n        background: #2a2a2a;\n        display: none;\n      ">\n        <input \n          id="templates-search-input" \n          type="text" \n                          placeholder="${I18nManager?I18nManager.getMessage("templatesSearch"):"Search templates..."}"\n          style="\n            width: 100%;\n            padding: 8px 12px;\n            border: 1px solid #444444;\n            border-radius: 6px;\n            font-size: 14px;\n            outline: none;\n            transition: border-color 0.2s;\n            background: #1e1e1e;\n            color: #ffffff;\n            box-sizing: border-box;\n          "\n        />\n      </div>\n      \n      <div id="templates-content" style="\n        flex: 1;\n        padding: 16px;\n        overflow-y: auto;\n        display: flex;\n        flex-direction: column;\n        gap: 12px;\n        background: #2d2d2d;\n      ">\n        <div style="\n          background: #3a3a3a;\n          padding: 12px;\n          border-radius: 8px;\n          font-size: 14px;\n          color: #cccccc;\n          border: 1px solid #444444;\n          text-align: center;\n        ">\n          ${I18nManager?I18nManager.getMessage("templatesLoading"):"Loading templates..."}\n        </div>\n      </div>\n    `,document.body.appendChild(window.templatesWidget);const e=document.createElement("style");e.textContent="\n      #templates-content::-webkit-scrollbar {\n        width: 8px;\n      }\n      \n      #templates-content::-webkit-scrollbar-track {\n        background: #1a1a1a;\n        border-radius: 4px;\n      }\n      \n      #templates-content::-webkit-scrollbar-thumb {\n        background: #555555;\n        border-radius: 4px;\n        transition: background 0.2s;\n      }\n      \n      #templates-content::-webkit-scrollbar-thumb:hover {\n        background: #666666;\n      }\n      \n      #templates-content::-webkit-scrollbar-thumb:active {\n        background: #777777;\n      }\n      \n      /* For Firefox */\n      #templates-content {\n        scrollbar-width: thin;\n        scrollbar-color: #555555 #1a1a1a;\n      }\n    ",document.head.appendChild(e),document.getElementById("templates-close").addEventListener("click",hideTemplatesWidget);const t=document.getElementById("templates-search-btn"),n=document.getElementById("templates-search-container"),o=document.getElementById("templates-search-input");t.addEventListener("click",(e=>{e.stopPropagation(),"none"===n.style.display?(n.style.display="block",o.focus()):(n.style.display="none",o.value="",window.templatesData&&renderTemplatesList(window.templatesData))})),o.addEventListener("input",(e=>{e.stopPropagation();const t=e.target.value.toLowerCase();if(window.templatesData){renderTemplatesList(window.templatesData.filter((e=>e.name.toLowerCase().includes(t)||e.description.toLowerCase().includes(t))),t)}})),o.addEventListener("keypress",(e=>{e.stopPropagation()})),[t,document.getElementById("templates-close")].forEach((e=>{e.addEventListener("mouseenter",(()=>{e.style.background="rgba(255, 255, 255, 0.1)"})),e.addEventListener("mouseleave",(()=>{e.style.background="none"}))})),o.addEventListener("keydown",(e=>e.stopPropagation())),o.addEventListener("keyup",(e=>e.stopPropagation())),o.addEventListener("focus",(e=>e.stopPropagation())),o.addEventListener("blur",(e=>e.stopPropagation()));document.getElementById("templates-content").addEventListener("click",(e=>{if(e.target.classList.contains("template-copy-btn")){e.stopPropagation();const t=e.target.getAttribute("data-filepath");t&&copyTemplateToClipboard(t,e.target)}}))}async function sendChatMessage(){const e=document.getElementById("n8n-chat-input"),t=e.value.trim();if(!t)return;e.disabled=!0,e.placeholder=I18nManager.getMessage("chatProcessing"),startChatIconAnimation(),e.value="";addMessageToChat("user",t);if(!!window.TemplateWorkflowHelper&&window.TemplateWorkflowHelper.isWorkflowCreationRequest(t)){try{const n=await window.TemplateWorkflowHelper.processWorkflowCreationRequest(t,addMessageToChat,removeMessageFromChat,stopChatIconAnimation,(()=>{e.disabled=!1,e.placeholder=window.I18nManager?window.I18nManager.getMessage("createWorkflow"):"Create a workflow..."}));if(n.success&&n.usedTemplate)return}catch(e){}const n=addMessageToChat("assistant",'🏗️ Creating custom workflow<span class="loading-dots"></span>',!0);try{const o=Date.now();window.chatRequests=window.chatRequests||{},window.chatRequests[o]=n;const a=await chrome.runtime.sendMessage({action:"createWorkflow",description:t,requestId:o});if(a.success&&a.workflow){removeMessageFromChat(n);let e="✅ **Workflow created successfully!**\n\n";try{const t=JSON.parse(a.workflow);t.name&&(e+=`**Name:** ${t.name}\n\n`),t.nodes&&t.nodes.length>0&&(e+=`**Nodes created:** ${t.nodes.length}\n`,t.nodes.forEach(((t,n)=>{e+=`${n+1}. **${t.name}** (${t.type})\n`})),e+="\n"),e+="🔄 **Ready to import:** The workflow JSON has been generated and is ready to be imported into your n8n instance.\n\n",e+="💡 **Next steps:**\n",e+="• Copy the JSON below\n",e+="• Go to n8n and create a new workflow\n",e+='• Use "Import from URL or File" and paste the JSON\n\n',e+="```json\n"+a.workflow+"\n```"}catch(t){e+=a.workflow}addMessageToChat("assistant",e)}else{removeMessageFromChat(n);addMessageToChat("assistant",`❌ **Workflow creation failed:** ${a.error||"Failed to create workflow"}`)}e.disabled=!1,e.placeholder="Create a workflow...",stopChatIconAnimation()}catch(t){removeMessageFromChat(n),addMessageToChat("assistant","❌ Sorry, I encountered an error while creating the workflow: "+t.message),e.disabled=!1,e.placeholder="Create a workflow...",stopChatIconAnimation()}return}const n=addMessageToChat("assistant",`🤔 ${I18nManager.getMessage("chatAnalyzing")}<span class="loading-dots"></span>`,!0);try{let o=null,a={platform:"n8n",currentPage:window.location.pathname.includes("/workflow/")?"workflow-editor":"n8n-page",url:window.location.href,workflowId:getCurrentWorkflowId()};if(window.NodeContextAnalyzer)try{o=window.NodeContextAnalyzer.getCurrentNodeContext()}catch(e){}const i=getSelectedNodes();let r=t;const s=["workflow","рабочий процесс","воркфлоу","what does this workflow","что делает этот рабочий процесс","что делает workflow","analyze workflow","explain workflow","describe workflow","how does workflow work","what is this workflow for","workflow purpose","workflow function","весь workflow","целый workflow","overview","обзор","общий обзор"],d=["selected","this node","these nodes","what does this","what does it","analyze this","explain this","how does this work","what is this","describe this","tell me about","what are these","explain these","how do these work","what do these do","analyze these nodes","explain the node","describe the node","node does","nodes do","what nodes are here","what nodes","nodes are here","what's in this workflow","nodes in this workflow","show me the nodes","list the nodes","этот нод","эти ноды","что делает","как работает","объясни","расскажи","опиши","анализируй","что это","где указать","как настроить","где найти","где ввести","где написать","как добавить","где установить"].some((e=>t.toLowerCase().includes(e.toLowerCase()))),l=s.some((e=>t.toLowerCase().includes(e.toLowerCase()))),c=o?.isOpen&&!o?.reason&&o?.nodeName&&"Unknown Node"!==o?.nodeName&&(d||t.length<100||window.NodeContextAnalyzer?.isNodeRelatedQuestion(t)),u=!c&&i.length>0&&(d||t.length<50);if(c){const e=getCurrentWorkflowId();let n=null;if(e&&window.N8NApiClient&&window.N8NApiClient.initialized&&window.N8NApiClient.apiKey&&"function"==typeof window.N8NApiClient.getWorkflowById)try{const a=await window.N8NApiClient.getWorkflowById(e);a&&(o.userMessage=t,n=await formatNodeContextWithWorkflow(o,a))}catch(e){}if(n)r=n;else{const e=window.NodeContextAnalyzer.formatContextForAI(o);r=`PLATFORM CONTEXT:\n- Platform: n8n Workflow Automation\n- Current Page: ${a.currentPage}\n- URL: ${a.url}\n\n${e}\n\nUSER QUESTION: ${t}\n\nRESPONSE REQUIREMENTS:\n1. Answer based on the EXACT node configuration shown above\n2. Use the specific parameter names from "CURRENT CONFIGURATION"\n3. If the user asks about settings/parameters, explain exactly where to find them in the n8n interface\n4. Provide step-by-step instructions\n5. If a parameter shows "(not set)", explain how to configure it\n6. Focus on this specific node instance, not general n8n advice\n\nPlease provide specific, actionable help for configuring this exact "${o.nodeName}" node.`}}else if(u){const e=getCurrentWorkflowId();let n=null;if(e&&window.N8NApiClient&&window.N8NApiClient.initialized&&window.N8NApiClient.apiKey&&"function"==typeof window.N8NApiClient.getWorkflowById)try{const o=await window.N8NApiClient.getWorkflowById(e);o&&(n=await formatSelectedNodesContextWithWorkflow(i,o,t))}catch(e){}r=n||(d||t.length<50?`Context: User has selected ${i.length} n8n node(s) in their workflow:\n\n${i.map(((e,t)=>{let n=`${t+1}. **${e.name}** (Type: ${e.type})`;return e.description&&(n+=`\n   Description: ${e.description}`),e.parameters&&Object.keys(e.parameters).length>0&&(n+="\n   Parameters:",Object.entries(e.parameters).forEach((([e,t])=>{n+=`\n     - ${e}: ${t}`}))),e.configuration&&(n+=`\n   Configuration: ${e.configuration.substring(0,200)}${e.configuration.length>200?"...":""}`),e.connections&&(n+=`\n   Connections: ${e.connections.inputs} input(s), ${e.connections.outputs} output(s)`),e.isOpenNode&&(n+="\n   Note: This node is currently open in the details panel"),n})).join("\n\n")}\n\nUser question: ${t}\n\nPlease provide a detailed explanation of the selected node(s), focusing on what they do, how they work, and any important configuration details. If the user asked a specific question, answer it in the context of these nodes.`:`PLATFORM CONTEXT:\n- Platform: n8n Workflow Automation\n- Current Page: ${a.currentPage}\n- Selected Nodes: ${i.map((e=>`${e.name} (${e.type})`)).join(", ")}\n\nUSER QUESTION: ${t}\n\nPlease answer the question while considering the context of their selected nodes if relevant.`)}else if(l||t.toLowerCase().includes("what does this")||t.toLowerCase().includes("analyze")||t.toLowerCase().includes("what nodes")||t.toLowerCase().includes("nodes are here")||t.toLowerCase().includes("what's in this")||t.toLowerCase().includes("show me the nodes")||t.toLowerCase().includes("list the nodes")||t.toLowerCase().includes("что тут")||t.toLowerCase().includes("какие ноды")||t.toLowerCase().includes("что за ноды")||d){const e=await getEnhancedWorkflowContext();if(e)r=`Context: User is on an n8n workflow page. ${e}\n\nUser question: ${t}\n\nPlease provide an overview of this n8n workflow based on the available information. Focus on explaining the workflow's purpose and functionality, how the nodes work together, and what the overall automation accomplishes.`;else{const e=getAllVisibleNodes();if(e.length>0)r=`Context: User is on an n8n workflow page with ${e.length} node(s):\n\n${e.map(((e,t)=>{let n=`${t+1}. **${e.name}** (${e.category})`;return e.type&&"Unknown"!==e.type&&(n+=` - Type: ${e.type}`),e.basicInfo&&(n+=` - ${e.basicInfo}`),n})).join("\n")}\n\nUser question: ${t}\n\nPlease provide an overview of this n8n workflow, explaining what each node does and how they work together. Focus on the workflow's purpose and functionality.`;else{const e=extractWorkflowData();r=e?`Context: User is on an n8n workflow page. Here's the workflow structure:\n${e}\n\nUser question: ${t}\n\nPlease help them understand their workflow or answer their question in the context of n8n workflow automation.`:`PLATFORM CONTEXT:\n- Platform: n8n Workflow Automation\n- Current Page: ${a.currentPage}\n- URL: ${a.url}\n\nUSER QUESTION: ${t}\n\nPlease provide helpful guidance about n8n workflows, nodes, or automation in general. If they're asking about specific nodes, suggest they select the nodes first for more detailed analysis.`}}}else r=`PLATFORM CONTEXT:\n- Platform: n8n Workflow Automation\n- Current Page: ${a.currentPage}\n- URL: ${a.url}\n\nUSER QUESTION: ${t}\n\nPlease provide helpful answers related to n8n workflow automation. Focus on n8n-specific guidance and best practices.`;let p=[];try{if("undefined"!=typeof DialogManager){if(await DialogManager.isRememberDialogEnabled()){const e=getCurrentWorkflowId();if(e){const t=await DialogManager.loadDialog(e);t&&t.length>0&&(p=DialogManager.formatMessagesForAI(t))}}}}catch(e){}try{const t=Date.now();window.chatRequests=window.chatRequests||{},window.chatRequests[t]=n;const o=await new Promise(((e,n)=>{chrome.runtime.sendMessage({action:"chatWithAI",prompt:r,chatHistory:p,language:I18nManager?I18nManager.getCurrentLanguage():navigator.language.split("-")[0],requestId:t},(t=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):e(t)}))}));if(o&&o.success&&o.response)removeMessageFromChat(n),delete window.chatRequests[t],addMessageToChat("assistant",o.response),e.disabled=!1,e.placeholder="Create a workflow...",stopChatIconAnimation();else if(o&&!o.success){removeMessageFromChat(n),delete window.chatRequests[t];addMessageToChat("assistant","❌ Sorry, I encountered an error: "+(o.error||"Unknown error occurred")),e.disabled=!1,e.placeholder="Create a workflow...",stopChatIconAnimation()}}catch(t){removeMessageFromChat(n),addMessageToChat("assistant","❌ Sorry, I encountered an error: Failed to communicate with background script"),e.disabled=!1,e.placeholder="Create a workflow...",stopChatIconAnimation()}}catch(t){removeMessageFromChat(n),addMessageToChat("assistant","❌ Sorry, I encountered an error: "+t.message),e.disabled=!1,e.placeholder="Create a workflow...",stopChatIconAnimation()}}function markdownToHtml(e){if(window.CodeCopyHandler&&window.CodeCopyHandler.markdownToHtml)return window.CodeCopyHandler.markdownToHtml(e);let t=e;const n=t.match(/```[\s\S]*?```/g);return n&&n.forEach(((e,t)=>{})),t=t.replace(/```(\w+)?\s*\n?([\s\S]*?)```/g,((e,t,n)=>`<pre class="code-block clickable-code" style="background: #1a1a1a; padding: 12px; border-radius: 6px; overflow-x: auto; margin: 8px 0; cursor: pointer; border: 1px solid #444444; transition: background 0.2s; color: #e6e6e6; font-family: 'Fira Code', 'Cascadia Code', 'JetBrains Mono', Consolas, monospace; white-space: pre-wrap; word-wrap: break-word;" title="Click to select all"><code>${n.replace(/^\s*\n/,"").replace(/\n\s*$/,"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}</code></pre>`)),t=t.replace(/^#### (.*$)/gm,'<h4 style="margin: 10px 0 6px 0; font-size: 14px; font-weight: 600; color: #ffffff;">$1</h4>').replace(/^### (.*$)/gm,'<h3 style="margin: 12px 0 8px 0; font-size: 16px; font-weight: 600; color: #ffffff;">$1</h3>').replace(/^## (.*$)/gm,'<h2 style="margin: 16px 0 8px 0; font-size: 18px; font-weight: 600; color: #ffffff;">$1</h2>').replace(/^# (.*$)/gm,'<h1 style="margin: 16px 0 8px 0; font-size: 20px; font-weight: 600; color: #ffffff;">$1</h1>').replace(/`([^`]+)`/g,"<code class=\"inline-code clickable-code\" style=\"background: #1a1a1a; padding: 3px 6px; border-radius: 4px; font-family: 'Fira Code', 'Cascadia Code', 'JetBrains Mono', Consolas, monospace; cursor: pointer; border: 1px solid #444444; transition: background 0.2s; color: #ff6b7a; font-size: 13px;\" title=\"Click to select\">$1</code>").replace(/<code class="code-block">([\s\S]*?)<\/code>/g,"<code class=\"code-block clickable-code\" style=\"display: block; background: #1a1a1a; padding: 12px; border-radius: 6px; font-family: 'Fira Code', 'Cascadia Code', 'JetBrains Mono', Consolas, monospace; white-space: pre-wrap; cursor: pointer; border: 1px solid #444444; transition: background 0.2s; margin: 8px 0; color: #e6e6e6;\" title=\"Click to select all\">$1</code>").replace(/\*\*(.*?)\*\*/g,'<strong style="color: #ffffff;">$1</strong>').replace(/\*(.*?)\*/g,'<em style="color: #cccccc;">$1</em>').replace(/\n/g,"<br>"),t}function addMessageToChat(e,t,n=!1){let o=document.getElementById("n8n-chat-messages");if(!o)try{return initializeChatWidget(),void setTimeout((()=>{if(o=document.getElementById("n8n-chat-messages"),o)addMessageToChat(e,t,n);else{showNotificationInPage("error",window.I18nManager?window.I18nManager.getMessage("chatNotAvailable"):"Chat widget not available. Please open chat manually first.")}}),100)}catch(e){return void showNotificationInPage("error",window.I18nManager?window.I18nManager.getMessage("openChatFirst"):"Please open chat widget first to see AI messages.")}const a=`msg-${e}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,i=document.createElement("div");if(i.id=a,i.setAttribute("data-message-id",a),i.style.cssText=`\n      padding: 12px;\n      border-radius: 8px;\n      font-size: 14px;\n      line-height: 1.4;\n      max-width: 85%;\n      word-wrap: break-word;\n      ${"user"===e?"background: #ff4757; color: white; margin-left: auto; text-align: right; border: 1px solid #ff6b7a;":"background: #3a3a3a; color: #cccccc; margin-right: auto; border: 1px solid #444444;"}\n      ${n?"opacity: 0.7;":""}\n    `,"assistant"===e)if(n)i.innerHTML=`<div class="message-content">${t}</div>`;else{const e=markdownToHtml(t);i.innerHTML=`<div class="message-content">${e}</div>`}else i.innerHTML=`<div class="message-content">${t}</div>`;return o.appendChild(i),"assistant"!==e||n?o.scrollTop=o.scrollHeight:i.scrollIntoView({behavior:"smooth",block:"start"}),n||saveChatMessage(e,t),a}function removeMessageFromChat(e){const t=document.getElementById(e);if(t){const n=t.textContent.substring(0,50),o=n.includes("🤔 "+I18nManager.getMessage("chatAnalyzing"))||n.includes(I18nManager.getMessage("chatAnalyzing"));if(e.includes("assistant")||o){t.remove();document.getElementById(e)}}else{document.querySelectorAll('[id^="msg-"]')}}function extractWorkflowData(){try{let e=[];if(window.n8n?.store?.state?.workflows?.workflow){const e=window.n8n.store.state.workflows.workflow;return`Workflow: "${e.name}"\nNodes: ${Object.keys(e.nodes||{}).length}\nConnections: ${Object.keys(e.connections||{}).length}`}if(window.Vue&&window.Vue.$store)try{const t=window.Vue.$store.state;if(t.workflows?.workflow){const n=t.workflows.workflow;if(e.push(`Workflow: "${n.name||"Untitled"}"`),n.nodes){const t=Object.values(n.nodes).map((e=>e.type));e.push(`Nodes (${t.length}): ${t.join(", ")}`)}}}catch(e){}const t=document.querySelectorAll('[data-test-id*="node"], .node-default, [class*="node-"]');if(t.length>0){const n=Array.from(t).map((e=>{const t=['[data-test-id="node-title"]',".node-name",".node-title",'[class*="node-name"]','.parameter-input[placeholder*="name"]'];let n="Unknown";for(const o of t){const t=e.querySelector(o);if(t&&t.textContent.trim()){n=t.textContent.trim();break}}return{name:n,type:e.getAttribute("data-node-type")||e.getAttribute("data-type")||(()=>{const t=(e.className?"string"==typeof e.className?e.className:e.className.toString():"").match(/node-type-([^\s]+)/);return t?t[1]:"Unknown"})()}})).filter((e=>"Unknown"!==e.name||"Unknown"!==e.type));n.length>0&&(e.push(`Detected ${n.length} nodes:`),n.forEach((t=>{e.push(`- ${t.name} (${t.type})`)})))}const n=['[data-test-id="workflow-name"]',".workflow-name",'h1[class*="workflow"]','[placeholder*="workflow name"]'];for(const t of n){const n=document.querySelector(t);if(n&&n.textContent.trim()){e.unshift(`Workflow: "${n.textContent.trim()}"`);break}}document.querySelector('[data-test-id="execute-workflow-button"]')&&e.push("Status: Ready for execution");return document.querySelector('[data-test-id="workflow-settings"]')&&e.push("Settings panel available"),e.length>0?e.join("\n"):"n8n workflow page detected but no specific workflow data found"}catch(e){return"Error extracting workflow data: "+e.message}}function getSelectedNodes(){try{const e=[],t=['[data-test-id*="node"].selected','[class*="node"][class*="selected"]',".node.selected",'[data-selected="true"]',".node-default.selected",".node-view.selected",'[data-test-id="canvas-node"].selected',".node-box.selected"];let n=[];for(const e of t)if(n=document.querySelectorAll(e),n.length>0)break;if(n.forEach(((t,n)=>{try{const o=['[data-test-id="node-title"]',".node-name",".node-title",'[class*="node-name"]',".node-label",".node-header",'[data-test-id*="title"]',".node-title-text"];let a="Unknown";for(const e of o){const n=t.querySelector(e);if(n&&n.textContent&&n.textContent.trim()){a=n.textContent.trim();break}}if("Unknown"===a&&(a=t.getAttribute("data-name")||t.getAttribute("data-title")||t.getAttribute("title")||t.getAttribute("data-node-name")||"Unknown","Unknown"===a)){const e=(t.textContent||"").split("\n").map((e=>e.trim())).filter((e=>e));if(e.length>0)for(const t of e)if(t&&!t.includes("@n8n")&&!t.includes("n8n-nodes-")&&!t.includes(".")&&t.length<50&&t.length>2){a=t;break}}let i=t.getAttribute("data-node-type")||t.getAttribute("data-type")||"Unknown";if("Unknown"===i){const e=(t.className?"string"==typeof t.className?t.className:t.className.toString():"").match(/node-type-([^\s]+)/);if(e)i=e[1];else{const e=t.querySelector("[data-node-type], [data-type]");e&&(i=e.getAttribute("data-node-type")||e.getAttribute("data-type")||"Unknown")}}let r=t.getAttribute("title")||t.querySelector(".node-description")?.textContent||"",s={},d="";try{const e=document.querySelector('.ndv-wrapper, [data-test-id="node-parameters"]');if(e){e.querySelectorAll("input, textarea, select").forEach((e=>{if(e.value&&e.value.trim()){const t=e.getAttribute("placeholder")||e.getAttribute("name")||e.getAttribute("data-test-id")||e.id;t&&!t.includes("undefined")&&t.length<50&&(s[t]=e.value.trim())}}));const t=e.textContent||"";t.length>0&&t.length<1e3&&(d=t.substring(0,500).trim())}if(0===Object.keys(s).length){t.querySelectorAll("input, textarea").forEach((e=>{if(e.value&&e.value.trim()&&e.value.length<100){const t=e.getAttribute("placeholder")||e.getAttribute("name")||"parameter";s[t]=e.value.trim()}}))}const n=t.textContent||"",o=["GET","POST","PUT","DELETE","PATCH"];for(const e of o)if(n.includes(e)){s["HTTP Method"]=e;break}const a=n.match(/(https?:\/\/[^\s]+)/);a&&(s.URL=a[1]),n.includes("webhook")&&(i="Unknown"===i?"Webhook":i),n.includes("trigger")&&(i="Unknown"===i?"Trigger":i),n.includes("schedule")&&(i="Unknown"===i?"Schedule Trigger":i)}catch(e){}const l={name:a,type:i,description:r.trim(),index:n+1,parameters:Object.keys(s).length>0?s:null,configuration:d||null,position:{x:t.style.left||t.offsetLeft||"unknown",y:t.style.top||t.offsetTop||"unknown"},connections:{inputs:t.querySelectorAll('.input-endpoint, [data-endpoint-type="input"]').length,outputs:t.querySelectorAll('.output-endpoint, [data-endpoint-type="output"]').length}};e.push(l)}catch(t){e.push({name:"Node "+(n+1),type:"Unknown",description:"Error extracting node information",index:n+1,error:t.message})}})),0===e.length){const t=document.querySelector('.ndv-wrapper, [data-test-id="node-parameters"]');if(t)try{const n=t.querySelector('[data-test-id="node-title"], .node-title, h1, h2')?.textContent?.trim()||"Current Node",o=t.querySelector('[data-test-id="node-type"]')?.textContent?.trim()||"Unknown",a={};t.querySelectorAll("input, textarea, select").forEach((e=>{if(e.value&&e.value.trim()){const t=e.getAttribute("placeholder")||e.getAttribute("name")||e.getAttribute("data-test-id")||"parameter";t&&!t.includes("undefined")&&t.length<50&&(a[t]=e.value.trim())}})),e.push({name:n,type:o,description:"Currently open node in details panel",index:1,parameters:Object.keys(a).length>0?a:null,isOpenNode:!0})}catch(e){}}return e}catch(e){return[]}}function selectCodeElement(e){try{const t=window.getSelection();t.removeAllRanges(),setTimeout((()=>{try{const n=document.createRange();e.querySelector("code")?n.selectNodeContents(e.querySelector("code")):n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n);const o=e.style.background,a=e.style.borderColor;e.style.background="#333333",e.style.borderColor="#ff4757",setTimeout((()=>{e.style.background=o,e.style.borderColor=a||"#444444"}),300);try{if(document.execCommand("copy")){const e=document.createElement("div");e.textContent="📋 Copied!",e.style.cssText="\n                position: fixed;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                background: #2a2a2a;\n                color: #ffffff;\n                padding: 8px 16px;\n                border-radius: 6px;\n                font-size: 14px;\n                z-index: 10001;\n                pointer-events: none;\n                border: 1px solid #444444;\n                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);\n              ",document.body.appendChild(e),setTimeout((()=>{e.parentNode&&e.remove()}),1e3)}}catch(t){if(navigator.clipboard&&navigator.clipboard.writeText){const t=e.textContent||e.innerText||"";navigator.clipboard.writeText(t).then((()=>{})).catch((e=>{}))}}}catch(e){}}),10)}catch(e){}}function sendMessageToChat(e,t="curl"){if(!chatWidget)try{return createChatWidget(),void setTimeout((()=>{sendMessageToChat(e,t)}),100)}catch(e){return void showNotificationInPage("error","Failed to open chat widget. Please try opening chat manually first.")}try{showChatWidget()}catch(e){}let n;switch(t){case"explanation":const t=window.I18nManager&&window.I18nManager.getMessage("codeExplanation")||"Code Explanation:";n=`**${t}**\n\n${e}`;break;case"curl":const o=window.I18nManager&&window.I18nManager.getMessage("generatedCurlCommand")||"Generated cURL command:";n=`**${o}**\n\`\`\`bash\n${e}\n\`\`\``;break;default:n=e}try{addMessageToChat("assistant",n)}catch(e){try{initializeChatWidget(),setTimeout((()=>{try{addMessageToChat("assistant",n)}catch(e){showNotificationInPage("error","Failed to send message to chat. Please open chat widget manually.")}}),200)}catch(e){showNotificationInPage("error","Chat widget initialization failed. Please refresh the page.")}}}function showNotificationInPage(e,t){const n=document.getElementById("n8n-master-notification");n&&n.remove();const o=document.createElement("div");o.id="n8n-master-notification",o.style.cssText="\n      position: fixed;\n      bottom: 30%;\n      left: 50%;\n      transform: translateX(-50%);\n      padding: 12px 20px;\n      border-radius: 8px;\n      color: white;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      font-size: 14px;\n      font-weight: 500;\n      z-index: 99999;\n      box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n      max-width: 400px;\n      text-align: center;\n      transition: all 0.3s ease;\n    ";const a={processing:"#ff8c00",success:"#28a745",error:"#dc3545"};if(o.style.backgroundColor=a[e]||a.processing,o.textContent=t,document.body.appendChild(o),"processing"===e){o.style.position="relative",o.style.overflow="hidden";const e=document.createElement("div");e.style.cssText="\n        position: absolute;\n        bottom: 0;\n        left: 0;\n        height: 3px;\n        background: rgba(255,255,255,0.3);\n        animation: loading 2s infinite;\n      ";const t=document.createElement("style");t.textContent="\n        @keyframes loading {\n          0% { width: 0%; }\n          50% { width: 100%; }\n          100% { width: 0%; }\n        }\n      ",document.head.appendChild(t),o.appendChild(e)}else setTimeout((()=>{o.parentNode&&(o.style.opacity="0",o.style.transform="translateX(-50%) translateY(20px)",setTimeout((()=>o.remove()),300))}),3e3)}async function loadTemplatesData(){try{const e=await fetch(chrome.runtime.getURL("awesome-n8n-templates.json")),t=await e.json();window.templatesData=t.templates||[];const n=document.getElementById("templates-title");if(n){const e=window.I18nManager?window.I18nManager.getMessage("templatesTitle"):"Templates";n.textContent=`${e} (${window.templatesData.length})`}renderTemplatesList(window.templatesData)}catch(e){const t=document.getElementById("templates-content");t&&(t.innerHTML='\n          <div style="\n            background: #3a3a3a;\n            padding: 12px;\n            border-radius: 8px;\n            font-size: 14px;\n            color: #ff6b7a;\n            border: 1px solid #444444;\n            text-align: center;\n          ">\n            ❌ Failed to load templates\n          </div>\n        ')}}function renderTemplatesList(e,t=""){const n=document.getElementById("templates-content");if(!n)return;if(!e||0===e.length)return void(n.innerHTML=`\n        <div style="\n          background: #3a3a3a;\n          padding: 12px;\n          border-radius: 8px;\n          font-size: 14px;\n          color: #cccccc;\n          border: 1px solid #444444;\n          text-align: center;\n        ">\n          ${t?`No templates found for "${t}"`:"No templates available"}\n        </div>\n      `);const o=e.map(((e,n)=>{let o=e.name,a=e.description;if(t){const e=new RegExp(`(${t})`,"gi");o=o.replace(e,'<mark style="background: #ff4757; color: white; padding: 1px 2px; border-radius: 2px;">$1</mark>'),a=a.replace(e,'<mark style="background: #ff4757; color: white; padding: 1px 2px; border-radius: 2px;">$1</mark>')}return`\n        <div style="\n          background: #3a3a3a;\n          border: 1px solid #444444;\n          border-radius: 8px;\n          padding: 16px;\n          transition: border-color 0.2s, background 0.2s;\n        " onmouseenter="this.style.borderColor='#4a90e2'; this.style.background='#424242';" onmouseleave="this.style.borderColor='#444444'; this.style.background='#3a3a3a';">\n          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">\n            <div style="font-weight: 600; font-size: 14px; color: #ffffff; line-height: 1.3; flex: 1; margin-right: 12px;">\n              ${o}\n            </div>\n            <button class="template-copy-btn" data-filepath="${e.filePath}" style="\n              background: #4a90e2;\n              border: none;\n              color: white;\n              padding: 6px 12px;\n              border-radius: 4px;\n              cursor: pointer;\n              font-size: 12px;\n              font-weight: 500;\n              transition: background 0.2s;\n              white-space: nowrap;\n            " onmouseenter="this.style.background='#5ca0f2';" onmouseleave="this.style.background='#4a90e2';">\n              Copy\n            </button>\n          </div>\n          <div style="\n            font-size: 13px;\n            color: #cccccc;\n            line-height: 1.4;\n          ">\n            ${a}\n          </div>\n        </div>\n      `})).join("");n.innerHTML=o}async function copyTemplateToClipboard(e,t){const n=t.textContent,o=t.style.background;try{if(t.textContent="Loading...",t.style.background="#ffa500",t.disabled=!0,!window.GitHubDownloader)throw new Error("GitHubDownloader module not available");const a=await window.GitHubDownloader.downloadWorkflow(e);if(!a.success)throw new Error(a.error||"Download failed");let i;i="json"===a.type||"json_unknown"===a.type?JSON.stringify(a.workflow,null,2):a.workflow,await navigator.clipboard.writeText(i),t.textContent="✅ Copied",t.style.background="#27ae60";showNotificationInPage("success",window.I18nManager?window.I18nManager.getMessage("templateCopiedSuccess"):"The template has been successfully copied to the clipboard. Press Ctrl + V to paste the workflow."),setTimeout((()=>{t.textContent=n,t.style.background=o,t.disabled=!1}),2e3)}catch(a){t.textContent="❌ Failed",t.style.background="#e74c3c";showNotificationInPage("error",`❌ ${window.I18nManager?window.I18nManager.getMessage("templateDownloadFailed"):"Failed to download"} ${e}: ${a.message}`),setTimeout((()=>{t.textContent=n,t.style.background=o,t.disabled=!1}),2e3)}}function addExportCurlButtons(){new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.forEach((e=>{e.nodeType===Node.ELEMENT_NODE&&checkAndAddExportButton(e)}))}))})).observe(document.body,{childList:!0,subtree:!0}),checkAndAddExportButton(document.body),setTimeout((()=>{checkAndAddExportButton(document.body)}),2e3)}function checkAndAddExportButton(e){(e.querySelectorAll?e.querySelectorAll('[data-test-id="node-parameters"], .ndv-wrapper, .node-settings'):[]).forEach((e=>{if(e.querySelector(".n8n-master-export-curl"))return;const t=e.querySelectorAll("button");let n=!1;for(const e of t)if(e.textContent&&e.textContent.includes("Import cURL")){n=!0;break}if(n)addExportButtonToNode(e);else{const t=e.textContent||"";t.includes("HTTP")||t.includes("Request")||t.includes("OpenAI")||t.includes("Generate")}}))}function addExportButtonToNode(e){try{let t=null;const n=e.querySelectorAll("button");for(const e of n)if(e.textContent&&e.textContent.includes("Import cURL")){t=e.parentElement;break}if(!t){const n=[e.querySelector(".parameter-input-list"),e.querySelector(".node-parameters"),e.querySelector('[data-test-id="parameter-input-container"]'),e.querySelector(".ndv-wrapper"),e];for(const e of n)if(e){t=e;break}}if(!t)return;const o=document.createElement("button");o.className="n8n-master-export-curl button _button_g7qox_351 _secondary_g7qox_436 _mini_g7qox_559",o.setAttribute("aria-live","polite");const a=Array.from(n).find((e=>e.textContent&&e.textContent.includes("Import cURL")));if(a){const e=window.getComputedStyle(a);o.style.cssText=`\n          background: ${e.background} !important;\n          color: ${e.color} !important;\n          border: ${e.border} !important;\n          border-radius: ${e.borderRadius} !important;\n          padding: ${e.padding} !important;\n          margin: ${e.margin} !important;\n          margin-right: 5px  !important;\n          font-size: ${e.fontSize} !important;\n          font-weight: ${e.fontWeight} !important;\n          font-family: ${e.fontFamily} !important;\n          height: ${e.height} !important;\n          min-height: ${e.minHeight} !important;\n          display: inline-flex !important;\n          align-items: center !important;\n          justify-content: center !important;\n          cursor: pointer !important;\n          transition: all 0.2s ease !important;\n          box-sizing: border-box !important;\n        `}else o.style.cssText='\n          background: rgb(255, 255, 255) !important;\n          border: 1px solid rgb(221, 221, 221) !important;\n          border-radius: 6px !important;\n          color: rgb(51, 51, 51) !important;\n          cursor: pointer !important;\n          display: inline-flex !important;\n          align-items: center !important;\n          justify-content: center !important;\n          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif !important;\n          font-size: 12px !important;\n          font-weight: 500 !important;\n          height: 32px !important;\n          min-height: 32px !important;\n          padding: 0px 12px !important;\n          margin: 0px 4px 0px 0px !important;\n          transition: all 0.2s ease !important;\n          box-sizing: border-box !important;\n        ';let i="";try{i=`<img src="${chrome.runtime.getURL("icons/icon16.png")}" width="14" height="14" style="margin-right: 6px; filter: none;" onerror="this.style.display='none';">`}catch(e){i='\n          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 6px;">\n            <path d="M12 2L12 15M12 15L8 11M12 15L16 11M3 17L3 19C3 20.1046 3.89543 21 5 21L19 21C20.1046 21 21 20.1046 21 19L21 17" \n                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n          </svg>\n        '}o.innerHTML=`${i}<span>Export cURL</span>`,o.addEventListener("mouseenter",(()=>{o.style.borderColor="rgb(102, 126, 234)",o.style.color="rgb(102, 126, 234)"})),o.addEventListener("mouseleave",(()=>{if(a){const e=window.getComputedStyle(a);o.style.borderColor=e.borderColor,o.style.color=e.color}else o.style.borderColor="rgb(221, 221, 221)",o.style.color="rgb(51, 51, 51)"})),o.addEventListener("click",(async e=>{e.preventDefault(),e.stopPropagation();try{const e=o.innerHTML;if(o.innerHTML=`\n            <div style="width: 14px; height: 14px; border: 2px solid rgba(51,51,51,0.3); border-top: 2px solid rgb(51,51,51); border-radius: 50%; animation: spin 1s linear infinite; margin-right: 6px;"></div>\n                                <span>${I18nManager.getMessage("chatGenerating")}</span>\n          `,o.disabled=!0,!document.querySelector("#n8n-master-spin-style")){const e=document.createElement("style");e.id="n8n-master-spin-style",e.textContent="\n              @keyframes spin {\n                0% { transform: rotate(0deg); }\n                100% { transform: rotate(360deg); }\n              }\n            ",document.head.appendChild(e)}const t=await chrome.runtime.sendMessage({action:"generateCurlFromButton"});o.innerHTML=e,o.disabled=!1,t&&t.success}catch(e){o.innerHTML=originalText,o.disabled=!1}}));const r=Array.from(n).find((e=>e.textContent&&e.textContent.includes("Import cURL")));r&&r.parentElement?(o.style.marginLeft="3px",r.nextSibling?r.parentElement.insertBefore(o,r.nextSibling):r.parentElement.appendChild(o)):t.firstChild?t.insertBefore(o,t.firstChild):t.appendChild(o)}catch(e){}}function initializeAutoSave(){chrome.storage.local.get(["autoSave"],(e=>{e.autoSave&&startAutoSaveMonitoring()})),chrome.storage.onChanged.addListener(((e,t)=>{"local"===t&&e.autoSave&&(e.autoSave.newValue?startAutoSaveMonitoring():stopAutoSaveMonitoring())}))}chrome.storage.onChanged.addListener(((e,t)=>{"local"===t&&e.workflowExecution&&(e.workflowExecution.newValue?initializeWorkflowExecutionCopy():cleanupWorkflowExecutionCopy())})),chrome.storage.local.get(["workflowExecution"],(e=>{e.workflowExecution&&initializeWorkflowExecutionCopy()})),window.testN8nMaster=async function(){try{return{success:!0,response:await chrome.runtime.sendMessage({action:"getSettings"})}}catch(e){return{success:!1,error:e.message}}},window.testNotificationLocalization=function(){window.I18nManager&&window.I18nManager.getCurrentLanguage();setTimeout((()=>{showNotificationInPage("success",window.I18nManager?window.I18nManager.getMessage("workflowInsertedSuccess"):"Workflow inserted successfully!")}),1e3),setTimeout((()=>{showNotificationInPage("error",`❌ ${window.I18nManager?window.I18nManager.getMessage("autoSaveFailed"):"Auto save failed"}: Test error`)}),2e3),"function"==typeof updateCopyButtonTexts&&updateCopyButtonTexts()},window.testCustomI18n=async function(){try{if(!window.I18nManager)return{success:!1,error:"I18nManager not available"};const e=window.I18nManager.getCurrentLanguage(),t=window.I18nManager.getTranslationStats(),n=["chatTitle","chatWelcome","templatesTitle","createWorkflow"],o={};for(const e of n)o[e]=window.I18nManager.getMessage(e);return{success:!0,currentLanguage:e,stats:t,translations:o}}catch(e){return{success:!1,error:e.message}}},window.testContentLocalization=function(){const e=window.I18nManager?window.I18nManager.getCurrentLanguage():"unknown",t=document.querySelector("#n8n-master-chat-widget");if(t){t.querySelector('div[style*="font-weight: 600"]'),t.querySelector("#n8n-chat-input"),t.querySelector(".welcome-message"),t.querySelector("#n8n-chat-fullscreen"),t.querySelector("#n8n-chat-clear")}const n=document.querySelector("#n8n-master-templates-widget");if(n){n.querySelector("#templates-title"),n.querySelector("#templates-search-input"),n.querySelector("#templates-search-btn"),n.querySelector('div[style*="text-align: center"]')}return updateContentLocalization(),{language:e,chatWidget:!!t,templatesWidget:!!n,i18nManager:!!window.I18nManager}},chrome.runtime.sendMessage({action:"test"},(e=>{chrome.runtime.lastError})),window.testChatCommunication=async function(){try{const e="Test message from console";return await chrome.runtime.sendMessage({action:"chatWithAI",prompt:e})}catch(e){return{success:!1,error:e.message}}},window.forceCreateChatWidget=function(){isActivated=!0,initializeChatWidget()},window.testExportCurlButtons=function(){const e=document.querySelectorAll('[data-test-id="node-parameters"], .ndv-wrapper, .node-settings');return e.forEach(((e,t)=>{const n=e.textContent||"",o=e.querySelectorAll("button");let a=!1;o.forEach(((e,t)=>{(e.textContent?.trim()||"No text").includes("Import cURL")&&(a=!0)}));e.querySelector(".n8n-master-export-curl");const i={methodSelect:!!e.querySelector('select[name*="method"]'),urlField:!!e.querySelector('input[placeholder*="example.com"]'),httpMethods:!!e.querySelector('input[value="GET"], input[value="POST"], input[value="PUT"], input[value="DELETE"]'),httpTestId:!!e.querySelector('[data-test-id*="http-request"]')},r={promptField:!!e.querySelector('textarea[placeholder*="prompt"]'),apiKeyField:!!e.querySelector('input[placeholder*="api key"]')};a||n.includes("HTTP Request")&&!n.includes("AI Agent")&&!n.includes("OpenAI")&&Object.values(i).some((e=>e))&&Object.values(r).some((e=>e))})),checkAndAddExportButton(document.body),{containers:e.length,buttons:Array.from(e).reduce(((e,t)=>e+t.querySelectorAll("button").length),0)}},window.testAutoSave=function(){try{chrome.storage.local.get(["autoSave"],(e=>{if(!e.autoSave)return;const t=Date.now()-lastAutoSaveTime,n=(Math.max(0,1e4-t),document.querySelectorAll("button"));let o=null;for(const e of n){const t=e.textContent?.trim().toLowerCase();if("save"===t){o=e;break}}o&&checkSaveButton()}))}catch(e){}return{autoSaveObserver:!!autoSaveObserver,lastState:lastSaveButtonState,lastSaveTime:lastAutoSaveTime,timeSinceLastSave:Date.now()-lastAutoSaveTime,autoSaveTimeout:!!autoSaveTimeout,buttonDisappearedTime:buttonDisappearedTime,timeSinceDisappeared:buttonDisappearedTime?Date.now()-buttonDisappearedTime:0,periodicCheckActive:!!periodicCheckInterval,buttonActiveTime:buttonActiveTime,timeSinceActive:buttonActiveTime?Date.now()-buttonActiveTime:0}},chrome.runtime.onMessage.addListener(((e,t,n)=>{if("activateN8nMaster"===e.action)detectN8nPage()?(isCurrentlyActive=!0,floatingButton&&chatWidget||init(),n({success:!0,message:"N8N Master activated successfully!"})):n({success:!1,message:"This page is not detected as an n8n page."});else if("createWorkflowFromJson"===e.action){stopChatIconAnimation();const t=e.requestId,n=window.chatRequests?.[t];n&&(removeMessageFromChat(n),delete window.chatRequests[t]);const o="string"==typeof e.workflowJson?JSON.parse(e.workflowJson):e.workflowJson,a=document.querySelector('[data-test-id="canvas"], .workflow-canvas, .node-view, #n8n-editor');if(!a)return addMessageToChat("assistant","❌ **Failed to create workflow:** Canvas not found. Make sure you are on an n8n workflow page."),!0;createWorkflowViaDom(o,a).then((e=>{})).catch((e=>{addMessageToChat("assistant","❌ **Failed to create workflow:** "+e.message)}))}else if("deactivateN8nMaster"===e.action){isCurrentlyActive=!1,floatingButton&&(floatingButton.remove(),floatingButton=null),chatWidget&&(chatWidget.remove(),chatWidget=null),stopAutoSaveMonitoring(),stopAutoPinMonitoring();document.querySelectorAll(".n8n-master-export-curl").forEach((e=>e.remove())),stopNodeCountMonitoring(),n({success:!0,message:"N8N Master deactivated successfully!"})}else if("checkN8nPage"===e.action){const e=detectN8nPage();n({success:!0,isN8nPage:e,isActivated:isCurrentlyActive})}else if("chatResponse"===e.action){stopChatIconAnimation();const t=e.requestId,n=window.chatRequests?.[t];if(n)if(removeMessageFromChat(n),delete window.chatRequests[t],e.success)addMessageToChat("assistant",e.response);else{addMessageToChat("assistant","❌ Sorry, I encountered an error: "+(e.error||"Unknown error occurred"))}}else if("showNotification"===e.action)showNotificationInPage(e.type,e.message);else if("showLicenseExpiredNotification"===e.action){showNotificationInPage("error",`🔒 ${window.I18nManager?window.I18nManager.getMessage("licenseExpired"):"License expired. Please reactivate in the extension popup."}`)}else if("sendToChat"===e.action)sendMessageToChat(e.content,e.contentType);else{if("getWorkflowHistoryCount"===e.action)return(async()=>{try{let e=0;if(void 0!==window.IndexedDBManager&&window.IndexedDBManager.db){e=(await window.IndexedDBManager.getAllWorkflowHistoryKeys()).length}else{const t=await chrome.storage.local.get();e=Object.keys(t).filter((e=>e.startsWith("workflow_history_"))).length}n({success:!0,count:e})}catch(e){n({success:!1,error:e.message})}})(),!0;if("exportIndexedDBData"===e.action)return(async()=>{try{const e={localProjects:[],localVariables:[],outputTemplates:[]};if(window.UnifiedDatabaseManager)try{const t=await window.UnifiedDatabaseManager.getAllProjects();e.localProjects=t||[];const o=await window.UnifiedDatabaseManager.getAllVariables();e.localVariables=o||[];const a=await window.UnifiedDatabaseManager.getAllOutputTemplates();e.outputTemplates=a||[];const i=e.localProjects.length+e.localVariables.length+e.outputTemplates.length;return void n({success:!0,data:e,message:`Exported ${i} items from N8N page`})}catch(e){}if(window.LocalProjectsManager)try{const t=await window.LocalProjectsManager.getAllProjects();e.localProjects=t||[]}catch(e){}if(window.LocalVariablesManager)try{const t=await window.LocalVariablesManager.getAllVariables();e.localVariables=t||[]}catch(e){}try{if(window.LocalProjectsManager&&"function"==typeof window.LocalProjectsManager.getAllOutputTemplates){const t=await window.LocalProjectsManager.getAllOutputTemplates();e.outputTemplates=t||[]}else{const t=await exportFromIndexedDBDirect("N8NMaster","outputTemplates");e.outputTemplates=t||[]}}catch(e){}const t=e.localProjects.length+e.localVariables.length+e.outputTemplates.length;n({success:!0,data:e,message:`Exported ${t} items from N8N page (fallback method)`})}catch(e){n({success:!1,error:e.message,data:{localProjects:[],localVariables:[],outputTemplates:[]}})}})(),!0;if("importIndexedDBData"===e.action)return(async()=>{try{let t=0;const o={projects:0,variables:0,templates:0};if(window.UnifiedDatabaseManager)try{if(e.data.localProjects&&e.data.localProjects.length>0){await window.UnifiedDatabaseManager.clearStore("projects");for(const t of e.data.localProjects)await window.UnifiedDatabaseManager.saveProject(t),o.projects++}if(e.data.localVariables&&e.data.localVariables.length>0){await window.UnifiedDatabaseManager.clearStore("variables");for(const t of e.data.localVariables)await window.UnifiedDatabaseManager.saveVariable(t),o.variables++}if(e.data.outputTemplates&&e.data.outputTemplates.length>0){await window.UnifiedDatabaseManager.clearStore("outputTemplates");for(const t of e.data.outputTemplates)await window.UnifiedDatabaseManager.saveOutputTemplate(t),o.templates++}return t=o.projects+o.variables+o.templates,void n({success:!0,importedCount:t,results:o,message:`Imported ${t} items to N8N page`})}catch(e){}if(window.LocalProjectsManager&&e.data.localProjects&&e.data.localProjects.length>0)try{for(const t of e.data.localProjects)await window.LocalProjectsManager.saveProject(t),o.projects++}catch(e){}if(window.LocalVariablesManager&&e.data.localVariables&&e.data.localVariables.length>0)try{for(const t of e.data.localVariables)await window.LocalVariablesManager.saveVariable(t),o.variables++}catch(e){}if(e.data.outputTemplates&&e.data.outputTemplates.length>0)try{if(window.LocalProjectsManager&&"function"==typeof window.LocalProjectsManager.saveOutputTemplate)for(const t of e.data.outputTemplates)await window.LocalProjectsManager.saveOutputTemplate(t),o.templates++;else await importToIndexedDBDirect("N8NMaster","outputTemplates",e.data.outputTemplates),o.templates=e.data.outputTemplates.length}catch(e){}t=o.projects+o.variables+o.templates,n({success:!0,importedCount:t,results:o,message:`Imported ${t} items to N8N page (fallback method)`})}catch(e){n({success:!1,error:e.message,importedCount:0,results:{projects:0,variables:0,templates:0}})}})(),!0;if("updateWorkflowExecution"===e.action)e.enabled?initializeWorkflowExecutionCopy():cleanupWorkflowExecutionCopy(),n({success:!0});else if("updateNodeExecutionSelect"===e.action){if(window.nodeExecutionSelectEnabled=e.enabled,window.OutputManager)if(e.enabled);else{document.querySelectorAll("#n8n-execution-select").forEach((e=>{const t=e.closest("div");t&&t.parentNode&&t.parentNode.removeChild(t)}))}n({success:!0})}}return!0})),window.selectCodeBlock=selectCodeElement,window.selectInlineCode=selectCodeElement,document.addEventListener("n8n-master-show-chat",(()=>{chatWidget||createChatWidget(),showChatWidget()})),window.addEventListener("message",(e=>{if("N8N_MASTER_SEND_TO_CHAT"===e.data.type){const t=e.data.contentType||"curl";sendMessageToChat(e.data.content,t)}}));let lastSaveButtonState=null,lastAutoSaveTime=0,autoSaveTimeout=null,buttonDisappearedTime=0;function isNodeEditorOpen(){const e=document.querySelector('.ndv-wrapper, [data-test-id="node-parameters"]'),t=e&&"none"!==e.style.display&&!e.hidden&&null!==e.offsetParent;return t}let periodicCheckInterval=null,buttonActiveTime=0;function startAutoSaveMonitoring(){function e(){const e=document.querySelectorAll("button");let t=null;for(const n of e){const e=n.textContent?.trim().toLowerCase();if("save"===e){t=n;break}}if(t){if(buttonDisappearedTime>0){Date.now()-buttonDisappearedTime>3e3&&(lastAutoSaveTime=0),buttonDisappearedTime=0}const e={exists:!0,enabled:!(t.disabled||t.hasAttribute("disabled")||t.classList.contains("disabled")||"none"===t.style.pointerEvents||"0.5"===t.style.opacity||"0"===t.style.opacity),hasPrimary:t.classList.contains("_primary_g7qox_611")||t.classList.contains("primary")||t.classList.contains("btn-primary"),isWorkflowSave:!t.closest('.ndv-wrapper, .node-settings, [data-test-id="node-parameters"]')&&(t.closest('[data-test-id="workflow-save"]')||t.closest(".workflow-save")||!t.closest(".modal, .dialog, .popup")),text:t.textContent?.trim()||"",classes:t.className||""},n=e.enabled&&e.hasPrimary&&e.isWorkflowSave;!n||lastSaveButtonState&&lastSaveButtonState.enabled&&lastSaveButtonState.hasPrimary&&lastSaveButtonState.isWorkflowSave?n||(buttonActiveTime=0):buttonActiveTime=Date.now();!lastSaveButtonState||lastSaveButtonState.enabled!==e.enabled||lastSaveButtonState.hasPrimary!==e.hasPrimary||lastSaveButtonState.isWorkflowSave!==e.isWorkflowSave||(lastSaveButtonState.exists,e.exists);const o=Date.now(),a=o-lastAutoSaveTime,i=1e4;let r=!1,s="";if(!lastSaveButtonState||lastSaveButtonState.enabled&&lastSaveButtonState.hasPrimary&&lastSaveButtonState.isWorkflowSave||!n){if(n&&buttonActiveTime>0){const e=o-buttonActiveTime;e>=5e3?(r=!0,s=`button active for ${Math.round(e/1e3)} seconds`):Math.floor(e/1e3)}}else r=!0,s="button became active";if(r&&a>=i){if(isNodeEditorOpen())return;try{lastAutoSaveTime=o,buttonActiveTime=o,setTimeout((()=>{t.click(),showSaveAnimation(),setTimeout((async()=>{try{const e=await chrome.storage.local.get(["enableHistory"]);if(!(!0===e.enableHistory))return;const t=getCurrentWorkflowId(),n=await extractCurrentWorkflow();t&&n&&triggerApiBackup(t,n)}catch(e){}}),2e3)}),100)}catch(e){showNotificationInPage("error",`❌ ${window.I18nManager?window.I18nManager.getMessage("autoSaveFailed"):"Auto save failed"}: ${e.message}`),lastAutoSaveTime=0}}else if(r&&a<i){Math.ceil((i-a)/1e3)}lastSaveButtonState=e}else lastSaveButtonState&&lastSaveButtonState.exists&&0===buttonDisappearedTime&&(buttonDisappearedTime=Date.now()),lastSaveButtonState={exists:!1,enabled:!1,hasPrimary:!1,isWorkflowSave:!1},buttonActiveTime=0}autoSaveObserver||(e(),periodicCheckInterval=setInterval((()=>{e()}),5e3),autoSaveObserver=new MutationObserver((t=>{let n=!1;t.forEach((e=>{"childList"!==e.type&&"attributes"!==e.type||(n=!0)})),n&&(clearTimeout(autoSaveTimeout),autoSaveTimeout=setTimeout((()=>{e()}),1e3))})),autoSaveObserver.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["disabled","class","style"]}))}function stopAutoSaveMonitoring(){autoSaveObserver&&(autoSaveObserver.disconnect(),autoSaveObserver=null,lastSaveButtonState=null,lastAutoSaveTime=0,buttonDisappearedTime=0,buttonActiveTime=0,clearTimeout(autoSaveTimeout),autoSaveTimeout=null,periodicCheckInterval&&(clearInterval(periodicCheckInterval),periodicCheckInterval=null))}function initializeAutoPin(){chrome.storage.local.get(["autoPinHttp","autoPinAi"],(e=>{(e.autoPinHttp||e.autoPinAi)&&(startAutoPinMonitoring(),TestWorkflowAutoPin.init())})),chrome.storage.onChanged.addListener(((e,t)=>{"local"===t&&(e.autoPinHttp||e.autoPinAi)&&chrome.storage.local.get(["autoPinHttp","autoPinAi"],(e=>{e.autoPinHttp||e.autoPinAi?(startAutoPinMonitoring(),TestWorkflowAutoPin.init()):(stopAutoPinMonitoring(),TestWorkflowAutoPin.destroy())}))}))}function startAutoPinMonitoring(){function e(){const e=['[data-test-id*="execution"]:not(.n8n-info-tip):not([class*="_infoTip_"]):not([class*="_note_"])',".execution-list:not(.n8n-info-tip)",".node-execution-status:not(.n8n-info-tip)",'[class*="execution"]:not(.n8n-info-tip):not([class*="_infoTip_"]):not([class*="_note_"])','[data-test-id*="node-execution"]:not(.n8n-info-tip)',".node-output-info:not(.n8n-info-tip)",'[data-test-id="output-panel"]:not(.n8n-info-tip)',".ndv-output:not(.n8n-info-tip)",'[data-test-id="ndv-output"]:not(.n8n-info-tip)'];let t=[];for(const n of e){const e=document.querySelectorAll(n);t=[...t,...Array.from(e)]}t=[...new Set(t)],t.forEach(((e,t)=>{const n=e.className?.toString()||"";if(n.includes("n8n-info-tip")||n.includes("_infoTip_")||n.includes("_note_")||n.includes("tooltip")||"tooltip"===e.getAttribute("role"))return;let o=null;if(o=e.closest('[data-test-id*="canvas-node"], [data-test-id*="node"], .node-default, [class*="node-"], .ndv-wrapper'),!o){let t=e.parentElement,n=0;for(;t&&n<10;){if((t.className?.toString()||"").includes("node")||t.getAttribute("data-test-id")?.includes("node")||t.getAttribute("data-test-id")?.includes("canvas-node")){o=t;break}t=t.parentElement,n++}}if(!o){const t=document.querySelectorAll('[data-test-id*="canvas-node"], [data-test-id*="node"], .node-default');for(const n of t)if(n.contains(e)){o=n;break}}if(!o)return;if(o.classList.contains("ndv-wrapper")||o.classList.contains("el-dialog")||o.classList.contains("data-display-wrapper")){let e=o.querySelector('[data-test-id*="canvas-node"]:not([class*="tooltip"]):not([class*="el-tooltip"]), [data-test-id*="node"]:not([class*="tooltip"]):not([class*="el-tooltip"]), .node-default:not([class*="tooltip"]), [class*="node-"]:not([class*="tooltip"]):not([class*="el-tooltip"]):not([class*="_connectedNode_"])');if(e||(e=o),!e)return;if(o=e,e.className?.includes("n8n-node-icon")||"I"===e.tagName||"SVG"===e.tagName){const e=o.closest(".ndv-wrapper")?.querySelector(".parameter-input-list")||o.closest(".ndv-wrapper")?.querySelector(".node-parameters")||o.closest(".ndv-wrapper")?.querySelector('[data-test-id*="parameter"]')||o.closest(".el-dialog")?.querySelector(".parameter-input-list")||o.closest(".el-dialog")?.querySelector(".node-parameters");e&&(o=e)}}if("ndv"===o.id&&!o.querySelector('[data-test-id*="node"]'))return;const a=getNodeType(o);if(!a)return;if(!checkExecutionSuccess(e,o))return;const i=generateConsistentNodeId(o,a);if(lastExecutionState.has(i)){const e=lastExecutionState.get(i);if(e.successful&&Date.now()-e.timestamp<1e4)return}const r={successful:!0,timestamp:Date.now(),nodeType:a,autoPinAttempted:!1};lastExecutionState.set(i,r),chrome.storage.local.get(["autoPinHttp","autoPinAi"],(e=>{let t=!1;const n=lastExecutionState.get(i);n&&n.autoPinAttempted||(t=!("http"!==a||!e.autoPinHttp)||!("ai"!==a||!e.autoPinAi),manuallyUnpinnedNodes.has(i)||t&&(lastExecutionState.set(i,{...n,autoPinAttempted:!0}),pinNodeExecution(o,a)))}))}))}autoPinObserver||(setupUnpinMonitoring(),e(),autoPinObserver=new MutationObserver((t=>{let n=!1;t.forEach((e=>{if("childList"===e.type||"attributes"===e.type){const t=e.target;if(t&&t.className){const e="string"==typeof t.className?t.className:t.className.toString();if(e.includes("pin")||e.includes("Pin")||t.closest('[data-test-id*="pin"]'))return;(e.includes("execution")||e.includes("success")||e.includes("completed"))&&(n=!0)}}})),n&&(clearTimeout(window.autoPinCheckTimeout),window.autoPinCheckTimeout=setTimeout(e,2e3))})),autoPinObserver.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","data-execution-status","data-test-id"]}))}function generateConsistentNodeId(e,t){try{let n=e;if("ndv"===e.id||"node-parameters"===e.id||e.classList?.contains("ndv-wrapper")||e.classList?.contains("el-dialog")||e.classList?.contains("node-parameters-wrapper")||e.closest(".ndv-wrapper")||e.closest(".el-dialog")||e.closest(".node-parameters-wrapper")){const t=[document.querySelector(".ndv-wrapper"),document.querySelector('.el-dialog[role="dialog"]'),document.querySelector("#ndv"),e.closest(".ndv-wrapper"),e.closest(".el-dialog"),e.closest(".node-parameters-wrapper")?.closest(".ndv-wrapper"),e.closest(".node-parameters-wrapper")?.closest(".el-dialog")].filter(Boolean);t.length>0&&(n=t[0])}if(n.classList?.contains("ndv-wrapper")||n.classList?.contains("el-dialog")||n.classList?.contains("node-parameters-wrapper")||"ndv"===n.id||e.classList?.contains("node-parameters-wrapper")||e.closest(".ndv-wrapper")||e.closest(".el-dialog")){return`current-node-${t}`}const o=n.getAttribute("data-node-id")||n.getAttribute("data-test-id")||n.id;if(o&&!o.includes("ndv")&&!o.includes("node-parameters"))return o;const a=(n.textContent?.substring(0,100)||"").replace(/\s+/g,"").substring(0,30);return`node-${t}-${a.substring(0,10)}`}catch(e){return`node-${t}-${Date.now()}`}}function getNodeTypeForUnpin(e){try{const t=e.textContent?.toLowerCase()||"",n=e.getAttribute("data-node-type")?.toLowerCase();if(n){if(n.includes("httprequest"))return"http";if(n.includes("code"))return"code";if(n.includes("webhook"))return"webhook";if(n.includes("ai")||n.includes("openai")||n.includes("anthropic"))return"ai"}const o=t.split("\n")[0]||t.substring(0,50);return o.includes("http request")&&!o.includes("code")?"http":o.includes("code")&&!o.includes("http")?"code":o.includes("webhook")?"webhook":o.includes("ai agent")||o.includes("openai")||o.includes("anthropic")?"ai":e.querySelector('[data-test-id*="http-request"]')?"http":e.querySelector('[data-test-id*="code"]')?"code":e.querySelector('[data-test-id*="webhook"]')?"webhook":!t.includes("method")||!t.includes("get")&&!t.includes("post")||t.includes("javascript")||t.includes("code")?(t.includes("javascript")||t.includes("python"))&&t.includes("code")&&!t.includes("http request")?"code":t.includes("model")&&(t.includes("openai")||t.includes("anthropic")||t.includes("claude"))?"ai":"unknown":"http"}catch(e){return"unknown"}}function setupUnpinMonitoring(){document.addEventListener("click",(function(e){const t=e.target;if(t.textContent?.toLowerCase().includes("unpin")||t.getAttribute("title")?.toLowerCase().includes("unpin")||t.getAttribute("aria-label")?.toLowerCase().includes("unpin")||t.closest('[data-test-id*="unpin"]')||t.closest("button")?.textContent?.toLowerCase().includes("unpin")||t.closest("a")?.textContent?.toLowerCase().includes("unpin")){let e=t.closest('[data-test-id*="canvas-node"], [data-test-id*="node"], .node-default, [class*="node-"], .ndv-wrapper');if(e){const t=generateConsistentNodeId(e,getNodeTypeForUnpin(e));manuallyUnpinnedNodes.add(t)}}}),!0)}function stopAutoPinMonitoring(){autoPinObserver&&(autoPinObserver.disconnect(),autoPinObserver=null,lastExecutionState.clear(),manuallyUnpinnedNodes.clear(),clearTimeout(window.autoPinCheckTimeout)),TestWorkflowAutoPin.destroy()}function getNodeType(e){try{const t=(e,t)=>{if(!e||!e.className)return!1;return("string"==typeof e.className?e.className:e.className.toString()).includes(t)};if(t(e,"n8n-info-tip")||t(e,"_infoTip_")||t(e,"_note_")||t(e,"n8n-tooltip")||t(e,"el-tooltip")||t(e,"n8n-popover")||t(e,"notice")||t(e,"info-tip")||"tooltip"===e.getAttribute("role")||e.getAttribute("data-test-id")?.includes("tooltip")||e.getAttribute("data-test-id")?.includes("info-tip"))return null;const n=e.textContent?.toLowerCase()||"";if(e.getAttribute("data-node-type")?.toLowerCase().includes("code")||e.querySelector('[data-test-id*="code"]')||e.querySelector(".code-editor, .monaco-editor, .cm-editor")||e.querySelector('textarea[name*="jsCode"]')||n.includes("language javascript")||n.includes("mode language javascript")||n.includes("// loop over input items")||n.includes("//loop over input items")||n.includes("for (const item of")||n.includes("for(const item of")||n.includes("mynewfield")||n.includes("myNewField")||n.includes("code test step")||n.includes("test stepparameters")||n.includes("mode language javascript")&&n.includes("loop over input items")||n.includes("9123456//")||n.match(/^\d{7}\/\//)||n.includes("add a new field called")&&n.includes("mynewfield")||n.includes("code")&&!n.includes("http request")&&!n.includes("webhook")||n.includes("javascript")&&(n.includes("code")||n.includes("function"))||n.includes("python")&&n.includes("code")||n.includes("$input")&&!n.includes("http request")||n.includes("return")&&n.includes("item")&&!n.includes("http request")||n.match(/^\d+\/\//)&&n.includes("loop over input"))return"code";if(e.textContent?.toLowerCase().includes("webhook")||e.querySelector('[data-test-id*="webhook"]')||e.getAttribute("data-node-type")?.toLowerCase().includes("webhook")||e.querySelector('input[placeholder*="webhook"]')||e.querySelector('[class*="webhook"]'))return"webhook";const o=n.includes("method"),a=n.includes("get")||n.includes("post")||n.includes("put")||n.includes("delete")||n.includes("patch")||n.includes("head")||n.includes("options"),i=o&&a;n.includes("http request")||e.getAttribute("data-node-type")?.toLowerCase().includes("httprequest")||e.querySelector('[data-test-id*="http-request"]'),e.querySelector('input[placeholder*="url"]')||e.querySelector('input[name*="url"]')||n.includes("url")&&n.includes("http"),n.includes("headers")&&(n.includes("content-type")||n.includes("authorization"));if(i)return"http";const r=n.includes("source for prompt (user message)")||n.includes("source for prompt")||n.includes("ai agent"),s=n.includes("openai")&&!n.includes("webhook")&&(n.includes("model")||n.includes("api key")),d=n.includes("anthropic")&&(n.includes("model")||n.includes("api key")),l=n.includes("claude")&&(n.includes("model")||n.includes("api key")),c=n.includes("gpt")&&n.includes("model")&&(n.includes("api key")||n.includes("prompt"));if(t(e,"el-dialog")||t(e,"ndv-wrapper")||t(e,"data-display-wrapper")||"ndv"===e.id||n.includes("node details view"))return null;return r||s||d||l||c?"ai":null}catch(e){return null}}function checkExecutionSuccess(e,t){try{const n=(e,t)=>{if(!e||!e.className)return!1;return("string"==typeof e.className?e.className:e.className.toString()).includes(t)};return[()=>n(e,"success"),()=>n(e,"completed"),()=>n(e,"finished"),()=>n(t,"success"),()=>e.textContent?.toLowerCase().includes("success"),()=>e.textContent?.toLowerCase().includes("completed"),()=>e.textContent?.toLowerCase().includes("finished"),()=>{const t=window.getComputedStyle(e);return t.backgroundColor.includes("green")||t.color.includes("green")||t.borderColor.includes("green")},()=>"success"===e.getAttribute("data-execution-status"),()=>"success"===e.getAttribute("data-status"),()=>e.querySelector('.fa-check, .success-icon, [data-icon="check"]'),()=>e.querySelector('[data-test-id*="success"]'),()=>t.querySelector('[data-test-id*="success"]')].some((e=>{try{return e()}catch(e){return!1}}))}catch(e){return!1}}function isNodeAlreadyPinned(e){try{if(!e)return!1;const t=[".pin-button.active",".pin-button.pinned",'.pin-button[aria-pressed="true"]','[data-test-id*="pin"][class*="active"]','[data-test-id*="pin"][class*="pinned"]',".fa-thumbtack.pinned",".pin-icon.active",'button[title*="Unpin"]','button[aria-label*="Unpin"]','[data-test-id="ndv-pin-data"][class*="active"]','[data-test-id="pin-data-button"][class*="active"]','*[class*="pinned"]','*[data-pinned="true"]'];for(const n of t){if(e.querySelector(n))return!0}const n=e.className||"";return!(!n.includes("pinned")&&!n.includes("_pinned"))}catch(e){return!1}}function pinNodeExecution(e,t){try{if("webhook"===t)return;if("code"===t)return;const n=generateConsistentNodeId(e,t);if(manuallyUnpinnedNodes.has(n))return;if(isNodeAlreadyPinned(e))return;const o=['[data-test-id="ndv-pin-data"]','[data-test-id="pin-data-button"]','[data-test-id*="pin"]',".ndv-pin-data",".pin-data-button",".pin-button",'button[title*="pin"]','button[title*="Pin"]','button[aria-label*="pin"]','button[aria-label*="Pin"]','[class*="pin"]',".fa-thumbtack",".fa-pin",'[data-icon="pin"]','[data-icon="thumbtack"]',"button .fa-thumbtack","button .fa-pin",'button svg[class*="pin"]','button [class*="thumbtack"]'];let a=null,i="unknown";const r=document.querySelectorAll('.ndv-output, [data-test-id="ndv-output"], .node-output-info, [data-test-id="output-panel"]');if(r.length>0)for(const e of r){for(const t of o)if(a=e.querySelector(t),a){i="output panel";break}if(a)break}if(!a&&e)for(const t of o)if(a=e.querySelector(t),a){i="node element";break}if(!a)for(const e of o){const t=document.querySelectorAll(e);for(const e of t){const t=window.getComputedStyle(e);if("none"!==t.display&&"hidden"!==t.visibility&&"0"!==t.opacity){a=e,i="document";break}}if(a)break}if(!a){const e=document.querySelectorAll("button");for(const t of e){const e=t.textContent?.toLowerCase()||"",n=t.title?.toLowerCase()||"",o=t.getAttribute("aria-label")?.toLowerCase()||"";if(e.includes("pin")||n.includes("pin")||o.includes("pin")){const e=window.getComputedStyle(t);if("none"!==e.display&&"hidden"!==e.visibility&&"0"!==e.opacity){a=t,i="text search";break}}}}if(a)a.disabled||"none"===a.style.display||setTimeout((()=>{try{a.click(),setTimeout((()=>{if(isNodeAlreadyPinned(e)){showNotificationInPage("success",(window.I18nManager?window.I18nManager.getMessage("autoPinSuccess"):"$1 response pinned automatically!").replace("$1",`📌 ${t.toUpperCase()}`))}}),1e3)}catch(e){}}),500);else{document.querySelectorAll("button").forEach(((e,t)=>{}))}}catch(e){}}function createAutopinTestButton(){const e=document.getElementById("autopin-test-button");e&&e.remove();const t=document.createElement("button");t.id="autopin-test-button",t.innerHTML="🧪 Test Code Autopin Fix",t.style.cssText="\n      position: fixed;\n      top: 10px;\n      right: 10px;\n      z-index: 9999;\n      padding: 10px 15px;\n      background: #4CAF50;\n      color: white;\n      border: none;\n      border-radius: 5px;\n      cursor: pointer;\n      font-weight: bold;\n      box-shadow: 0 2px 5px rgba(0,0,0,0.3);\n    ",t.onclick=function(){t.innerHTML="🔄 Testing...",t.style.background="#FF9800",setTimeout((()=>{try{const e=testCodeNodeAutopin();let n="📊 Autopin Test Results:\n";n+=`• ${e.codeNodes} Code nodes (should be excluded)\n`,n+=`• ${e.httpNodes} HTTP nodes\n`,n+=`• ${e.aiNodes} AI nodes\n`,n+=`• ${e.otherNodes} Other nodes\n`,n+=`• Total: ${e.totalNodes} nodes`,e.codeNodes>0?n+="\n✅ Code nodes found and tested for exclusion":n+="\n⚠️ No Code nodes found on this page",showNotificationInPage("success",n),t.innerHTML="✅ Test Complete",t.style.background="#4CAF50"}catch(e){showNotificationInPage("error",`❌ ${window.I18nManager?window.I18nManager.getMessage("testFailed"):"Test failed"}: ${e.message}`),t.innerHTML="❌ Test Failed",t.style.background="#f44336"}setTimeout((()=>{t.remove()}),8e3)}),1e3)},document.body.appendChild(t),setTimeout((()=>{document.getElementById("autopin-test-button")&&t.remove()}),3e4)}document.addEventListener("keydown",(function(e){if(e.ctrlKey&&e.shiftKey&&"A"===e.key&&(e.preventDefault(),createAutopinTestButton()),e.ctrlKey&&e.shiftKey&&"U"===e.key){e.preventDefault();const t=manuallyUnpinnedNodes.size,n=Array.from(manuallyUnpinnedNodes).slice(0,3);let o="🔍 Unpin Tracking Status:\n";o+=`• Manually unpinned nodes: ${t}\n`,t>0?(o+=`• Recent: ${n.join(", ")}`,t>3&&(o+=` (+${t-3} more)`)):o+="• No nodes manually unpinned yet",showNotificationInPage("info",o)}})),window.testCodeNodeAutopin=function(){manuallyUnpinnedNodes.clear();const e=document.querySelectorAll('[data-test-id*="node"], .node-default, [class*="node-"]');let t=0,n=0,o=0,a=0;return e.forEach(((e,i)=>{const r=getNodeType(e);e.textContent?.substring(0,100);if("code"===r){t++;try{pinNodeExecution(e,r)}catch(e){}}else"http"===r?n++:"ai"===r?o++:a++})),{codeNodes:t,httpNodes:n,aiNodes:o,otherNodes:a,totalNodes:e.length}},window.testAutoPin=function(){return chrome.storage.local.get(["autoPinHttp","autoPinAi"],(e=>{if(!e.autoPinHttp&&!e.autoPinAi)return;const t=document.querySelectorAll('[data-test-id*="node"], .node-default, [class*="node-"]');t.forEach(((e,t)=>{const n=getNodeType(e);"http"===n?0:"ai"===n&&0}));document.querySelectorAll('[data-test-id*="pin"], .pin-button, button[title*="pin"], button[title*="Pin"]')})),{autoPinObserver:!!autoPinObserver,lastExecutionState:lastExecutionState.size}};const TestWorkflowAutoPin={_testWorkflowObserver:null,_buttonTextObserver:null,_isMonitoringExecution:!1,init:function(){this.setupTestWorkflowMonitoring()},setupTestWorkflowMonitoring:function(){this._testWorkflowObserver=new MutationObserver((()=>{this.checkForTestButton()})),this._testWorkflowObserver.observe(document.body,{childList:!0,subtree:!0}),this.checkForTestButton()},checkForTestButton:function(){const e=['[data-test-id="execute-workflow-button"]','button[data-test-id*="test-workflow"]','button[title*="Test workflow"]'];let t=null;for(const n of e)if(t=document.querySelector(n),t)break;if(!t){const e=document.querySelectorAll("button");for(const n of e){const e=n.textContent?.trim().toLowerCase()||"";if(e.includes("test workflow")||e.includes("execute workflow")){t=n;break}}}t&&!t.hasAttribute("data-autopin-listener")&&this.addTestButtonListener(t)},addTestButtonListener:function(e){e.setAttribute("data-autopin-listener","true"),e.addEventListener("click",(()=>{chrome.storage.local.get(["autoPinHttp","autoPinAi"],(t=>{(t.autoPinHttp||t.autoPinAi)&&this.startMonitoringExecution(e,t)}))}))},startMonitoringExecution:function(e,t){this._isMonitoringExecution||(this._isMonitoringExecution=!0,this._buttonTextObserver=new MutationObserver((()=>{const n=e.textContent?.trim()||"";n.toLowerCase().includes("test workflow")&&!n.toLowerCase().includes("executing")&&(this.stopMonitoringExecution(),setTimeout((()=>{this.pinSuccessfulNodes(t)}),1e3))})),this._buttonTextObserver.observe(e,{childList:!0,subtree:!0,characterData:!0}),setTimeout((()=>{this._isMonitoringExecution&&(this.stopMonitoringExecution(),this.pinSuccessfulNodes(t))}),3e4))},stopMonitoringExecution:function(){this._isMonitoringExecution=!1,this._buttonTextObserver&&(this._buttonTextObserver.disconnect(),this._buttonTextObserver=null)},pinSuccessfulNodes:function(e){const t=document.querySelectorAll('[data-test-id="canvas-node"]:not([data-test-id*="add"]):not([data-test-id*="creator"])');let n=0;t.forEach(((t,o)=>{try{t.textContent?.substring(0,50);const o=this.getNodeTypeFromElement(t);if(!o)return;if(!("http"===o&&e.autoPinHttp||"ai"===o&&e.autoPinAi))return;if(!this.isNodeExecutedSuccessfully(t))return;setTimeout((()=>{this.selectNodeAndPin(t,o)}),500*n),n++}catch(e){}}))},isNodeExecutedSuccessfully:function(e){try{const t=[()=>e.querySelector(".fa-check"),()=>e.querySelector('[class*="success"]'),()=>e.querySelector('[data-test-id*="success"]'),()=>e.querySelector(".success-icon"),()=>{const t=e.querySelectorAll('[data-test-id*="output"], .node-output, [class*="output"]');return Array.from(t).some((e=>{const t=e.textContent?.trim()||"";return t.length>10&&!t.includes("No data")&&!t.includes("Empty")}))},()=>{const t=window.getComputedStyle(e);return t.borderColor.includes("green")||t.backgroundColor.includes("green")},()=>{const t=e.className||"";return t.includes("success")||t.includes("completed")||t.includes("executed")},()=>!e.querySelector('.fa-exclamation, [class*="error"], [class*="failed"]')].some((e=>{try{return e()}catch{return!1}}));return t}catch(e){return!1}},getNodeTypeFromElement:function(e){try{const t=e.textContent?.toLowerCase()||"";return t.includes("code")&&!t.includes("http")?null:!t.includes("set")||t.includes("http")||t.includes("request")?t.includes("http request")||t.includes("http")&&t.includes("request")&&!t.includes("code")?"http":t.includes("ai agent")||t.includes("openai")||t.includes("anthropic")||t.includes("claude")||t.includes("gpt")?"ai":null:null}catch(e){return null}},selectNodeAndPin:function(e,t){try{e.textContent?.substring(0,50);if(isNodeAlreadyPinned(e))return;e.click(),setTimeout((()=>{const e=new KeyboardEvent("keydown",{key:"p",code:"KeyP",bubbles:!0,cancelable:!0});document.dispatchEvent(e);const t=new KeyboardEvent("keydown",{key:"P",code:"KeyP",shiftKey:!0,bubbles:!0,cancelable:!0});document.dispatchEvent(t),setTimeout((()=>{const e=document.querySelector(".workflow-canvas")||document.querySelector('[data-test-id="canvas"]');if(e){const t=e.getBoundingClientRect(),n=new MouseEvent("click",{bubbles:!0,clientX:t.right-50,clientY:t.bottom-50});e.dispatchEvent(n)}}),200)}),300)}catch(e){}},destroy:function(){this.stopMonitoringExecution(),this._testWorkflowObserver&&(this._testWorkflowObserver.disconnect(),this._testWorkflowObserver=null)}};function showSaveAnimation(){const e=document.getElementById("n8n-master-floating-btn");if(!e)return;if("true"===e.dataset.animating)return;e.dataset.animating="true";const t=e.innerHTML;e.innerHTML="✅ SAVED",setTimeout((()=>{e.innerHTML=t,e.dataset.animating="false"}),2e3)}function getTotalNodeCount(){try{try{if(window.Vue&&window.Vue.util){const e=document.querySelectorAll("[data-v-]");for(const t of e){const e=t.__vue__;if(e&&e.$store){const t=["getters.workflowsById","state.workflows","getters.workflow","state.ui.workflowsById"];for(const n of t){const t=n.split(".").reduce(((e,t)=>e?.[t]),e.$store);if(t&&"object"==typeof t){if(t.nodes&&Array.isArray(t.nodes))return t.nodes.length;if("object"==typeof t&&Object.keys(t).length>0){return Object.keys(t).length}}}}}}}catch(e){}const e=document.querySelectorAll('[data-test-id="canvas-node"][data-node-type]');if(e.length>0){const t=Array.from(e).filter((e=>{const t=e.getAttribute("data-node-type");if(!t||""===t)return!1;if(e.closest(".sidebar, .menu, .node-creator, .ndv-wrapper, .overlay, .modal"))return!1;const n=window.getComputedStyle(e);if("none"===n.display||"hidden"===n.visibility||0===parseFloat(n.opacity))return!1;const o=(e.textContent||"").trim();if(o.length<2)return!1;return!["add node","node creator","add first step","click to add","drop to add"].some((e=>o.toLowerCase().includes(e)))}));if(t.length>0)return t.length}const t=['[data-node-type]:not([data-node-type=""])',".node-default:not(.node-creator):not(.add-node)"];for(const e of t){const t=document.querySelectorAll(e);if(t.length>0){const e=Array.from(t).filter((e=>{const t=e.getAttribute("data-node-type");if(!t||""===t)return!1;if(e.closest(".sidebar, .menu, .node-creator, .ndv-wrapper, .overlay, .modal"))return!1;const n=window.getComputedStyle(e);if("none"===n.display||"hidden"===n.visibility||0===parseFloat(n.opacity))return!1;if(!(e.closest('[data-test-id="canvas"], .node-view, #canvas')||document.querySelector('[data-test-id="canvas"], .node-view, #canvas')?.contains(e)))return!1;const o=(e.textContent||"").trim();if(o.length<2)return!1;return!["add node","node creator","add first step","click to add"].some((e=>o.toLowerCase().includes(e)))}));if(e.length>0&&e.length<=50)return e.length;e.length}}try{const e=extractWorkflowData();if(e&&"string"==typeof e){const t=e.match(/Detected (\d+) nodes:/);if(t){return parseInt(t[1])}}}catch(e){}return 0}catch(e){return 0}}function getTotalNodeCount_OLD(){try{try{if(window.n8n&&window.n8n.store&&window.n8n.store.getters){const e=window.n8n.store.getters.allNodes;if(e&&Array.isArray(e)&&e.length>0)return e.length}}catch(e){}try{if(window.n8n&&window.n8n.store&&window.n8n.store.state){const e=["workflows.workflow.nodes","workflows.workflow","workflow.nodes","nodes"];for(const t of e){const e=t.split(".");let n=window.n8n.store.state;for(const t of e){if(!n||!n[t]){n=null;break}n=n[t]}if(n){if(Array.isArray(n))return n.length;if(n.nodes&&Array.isArray(n.nodes))return n.nodes.length;if("object"==typeof n&&Object.keys(n).length>0){return Object.keys(n).length}}}}}catch(e){}const e=['[data-test-id^="canvas-node"]','[data-test-id*="node"]:not([data-test-id*="add"]):not([data-test-id*="creator"])',".node-default","[data-node-type]"];for(const t of e){const e=document.querySelectorAll(t);if(e.length>0){const t=Array.from(e).filter((e=>{const t=e.getBoundingClientRect();if(t.width<80||t.height<50)return!1;const n=e.textContent||"";return!(n.includes("Add node")||n.includes("Node Creator")||n.includes("Add first step")||n.includes("Click to add"))&&!e.closest(".sidebar, .menu, .node-creator, .ndv-wrapper")}));if(t.length>0)return t.length}}try{const e=extractWorkflowData();if(e&&"string"==typeof e){const t=e.match(/Detected (\d+) nodes:/);if(t){return parseInt(t[1])}}}catch(e){}return 0}catch(e){return 0}}function getSelectedNodeCount(){try{let e=document.querySelectorAll('[data-test-id^="canvas-node"]');if(e.length>0){return Array.from(e).filter((e=>e.classList.contains("selected")||e.classList.contains("node-selected")||e.classList.contains("jtk-drag-selected")||"true"===e.getAttribute("data-selected")||e.hasAttribute("selected"))).length}const t=document.querySelector('.node-view, #node-view, [data-test-id="canvas"]');if(t){e=t.querySelectorAll(".node-default, [data-node-type], .jtk-node");return Array.from(e).filter((e=>{const t=e.getBoundingClientRect();if(t.width<80||t.height<40)return!1;const n=e.textContent||"";return!n.includes("Add node")&&!n.includes("Node Creator")&&(!e.closest(".sidebar, .menu, .node-creator")&&(e.classList.contains("selected")||e.classList.contains("node-selected")||e.classList.contains("jtk-drag-selected")||"true"===e.getAttribute("data-selected")||e.hasAttribute("selected")))})).length}return 0}catch(e){return 0}}function updateNodeCountDisplay(){const e=document.getElementById("n8n-node-count");if(!e)return;const t=getTotalNodeCount(),n=getSelectedNodeCount(),o=`${0===n?t:n}/${t}`;e.textContent!==o&&(e.textContent=o,e.title=0===n?`All ${t} nodes selected`:`${n} of ${t} nodes selected`)}let nodeCountMonitoringActive=!1,nodeCountObserver=null,nodeCountClickHandler=null,nodeCountMonitorInterval=null;function startNodeCountMonitoring(){if(nodeCountMonitoringActive)return;let e;nodeCountMonitoringActive=!0,setTimeout((()=>{updateNodeCountDisplay()}),1e3),setTimeout((()=>{updateNodeCountDisplay()}),3e3),setTimeout((()=>{updateNodeCountDisplay()}),5e3),nodeCountObserver=new MutationObserver((e=>{let t=!1;e.forEach((e=>{if("childList"===e.type){[...Array.from(e.addedNodes),...Array.from(e.removedNodes)].some((e=>{if(e.nodeType!==Node.ELEMENT_NODE)return!1;const t=e.getAttribute&&(e.getAttribute("data-node-type")||e.getAttribute("data-type")||e.getAttribute("data-test-id")?.includes("node")),n=e.className&&(e.classList.contains("node")||e.classList.contains("canvas"));return t||n}))&&(t=!0)}else if("attributes"===e.type){const n=e.target,o=e.attributeName;if("class"===o||"data-selected"===o||"data-test-id"===o){n.getAttribute&&(n.getAttribute("data-node-type")||n.getAttribute("data-type")||n.getAttribute("data-test-id")?.includes("node"))&&(t=!0)}}})),t&&(clearTimeout(window.nodeCountUpdateTimeout),window.nodeCountUpdateTimeout=setTimeout((()=>{updateNodeCountDisplay()}),1e3))})),nodeCountObserver.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","data-selected","data-test-id","data-node-type"]}),nodeCountClickHandler=t=>{t.target.closest('[data-test-id*="node"], .node-default, [data-node-type]')&&(clearTimeout(e),e=setTimeout((()=>{updateNodeCountDisplay()}),300))},document.addEventListener("click",nodeCountClickHandler),nodeCountMonitorInterval=setInterval((()=>{updateNodeCountDisplay()}),1e4)}function stopNodeCountMonitoring(){nodeCountMonitoringActive&&(nodeCountObserver&&(nodeCountObserver.disconnect(),nodeCountObserver=null),nodeCountClickHandler&&(document.removeEventListener("click",nodeCountClickHandler),nodeCountClickHandler=null),nodeCountMonitorInterval&&(clearInterval(nodeCountMonitorInterval),nodeCountMonitorInterval=null),clearTimeout(window.nodeCountUpdateTimeout),nodeCountMonitoringActive=!1)}async function clearChatHistory(){const e=document.getElementById("n8n-chat-messages");if(e&&confirm("Are you sure you want to clear the chat history?")){e.innerHTML=`\n        <div style="\n          background: #3a3a3a;\n          padding: 12px;\n          border-radius: 8px;\n          font-size: 14px;\n          color: #cccccc;\n          border: 1px solid #444444;\n        ">\n          👋 ${window.I18nManager?window.I18nManager.getMessage("chatWelcome"):"Hi! I'm your N8N Master assistant. I can help you analyze workflows, create a new workflows, optimize prompts, and answer questions about your n8n setup."}\n          <br><br>\n          ${window.I18nManager?window.I18nManager.getMessage("chatWelcomeHelp"):'Try asking: "What does this workflow do?" or "Analyze selected nodes"'}\n        </div>\n      `;try{if("undefined"!=typeof DialogManager){if(await DialogManager.isRememberDialogEnabled()){const e=getCurrentWorkflowId();e&&await DialogManager.deleteDialog(e)}}}catch(e){}const t=document.createElement("div");t.textContent="🗑️ Chat history cleared",t.style.cssText="\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        background: #2a2a2a;\n        color: #ffffff;\n        padding: 8px 16px;\n        border-radius: 6px;\n        font-size: 14px;\n        z-index: 10001;\n        pointer-events: none;\n        border: 1px solid #444444;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);\n      ",document.body.appendChild(t),setTimeout((()=>{t.parentNode&&t.remove()}),1500)}}function getAllVisibleNodes(){try{const e=[],t=['[data-test-id="canvas-node"]',".node-default[data-node-type]",'[data-test-id*="node"][data-node-type]',".workflow-node",'[data-type*="n8n-nodes"]',".vue-flow__node","[data-id][data-type]",".node-wrapper",'[class*="node"][data-name]',".canvas-node","[data-node-name]","[data-node-id]",".node-container",'[class*="NodeView"]'];let n=[];for(const e of t)if(n=document.querySelectorAll(e),n.length>0)break;const o=10;return Array.from(n).slice(0,o).forEach(((t,n)=>{try{const o=['[data-test-id="node-title"]',".node-name",".node-title",'[class*="node-name"]',".node-label",".node-header",'[data-test-id*="title"]',".node-title-text",".vue-flow__node-label","[data-label]",".node-text",".node-display-name",".node-name-text"];let a="Unknown";for(const e of o){const n=t.querySelector(e);if(n&&n.textContent&&n.textContent.trim()){a=n.textContent.trim();break}}"Unknown"===a&&(a=t.getAttribute("data-name")||t.getAttribute("data-title")||t.getAttribute("title")||t.getAttribute("data-node-name")||t.getAttribute("data-label")||t.getAttribute("data-id")||"Node "+(n+1));let i=t.getAttribute("data-node-type")||t.getAttribute("data-type")||"Unknown";i.includes("n8n-nodes-base.")?(i=i.replace("n8n-nodes-base.","").replace(/([A-Z])/g," $1").trim(),i=i.charAt(0).toUpperCase()+i.slice(1)):i.includes("@n8n/")&&(i=i.split(".").pop()||i);const r=t.textContent||"";let s="";const d=["GET","POST","PUT","DELETE","PATCH"];for(const e of d)if(r.includes(e)){s+=`Method: ${e}; `;break}const l=r.match(/(https?:\/\/[^\s]+)/);l&&(s+=`URL: ${l[1]}; `);let c="Action";r.includes("trigger")||i.toLowerCase().includes("trigger")?c="Trigger":r.includes("webhook")?c="Webhook":r.includes("schedule")?c="Schedule":i.toLowerCase().includes("code")?c="Code":i.toLowerCase().includes("http")&&(c="HTTP Request"),e.push({name:a,type:i,category:c,basicInfo:s.trim(),index:n+1})}catch(t){e.push({name:"Node "+(n+1),type:"Unknown",category:"Unknown",basicInfo:"",index:n+1,error:t.message})}})),n.length,e}catch(e){return[]}}function getSelectedNodes(){try{const e=[],t=['[data-test-id*="node"].selected','[class*="node"][class*="selected"]',".node.selected",'[data-selected="true"]',".node-default.selected",".node-view.selected",'[data-test-id="canvas-node"].selected',".node-box.selected"];let n=[];for(const e of t)if(n=document.querySelectorAll(e),n.length>0)break;if(n.forEach(((t,n)=>{try{const o=['[data-test-id="node-title"]',".node-name",".node-title",'[class*="node-name"]',".node-label",".node-header",'[data-test-id*="title"]',".node-title-text"];let a="Unknown";for(const e of o){const n=t.querySelector(e);if(n&&n.textContent&&n.textContent.trim()){a=n.textContent.trim();break}}if("Unknown"===a&&(a=t.getAttribute("data-name")||t.getAttribute("data-title")||t.getAttribute("title")||t.getAttribute("data-node-name")||"Unknown","Unknown"===a)){const e=(t.textContent||"").split("\n").map((e=>e.trim())).filter((e=>e));if(e.length>0)for(const t of e)if(t&&!t.includes("@n8n")&&!t.includes("n8n-nodes-")&&!t.includes(".")&&t.length<50&&t.length>2){a=t;break}}let i=t.getAttribute("data-node-type")||t.getAttribute("data-type")||"Unknown";if("Unknown"===i){const e=(t.className?"string"==typeof t.className?t.className:t.className.toString():"").match(/node-type-([^\s]+)/);if(e)i=e[1];else{const e=t.querySelector("[data-node-type], [data-type]");e&&(i=e.getAttribute("data-node-type")||e.getAttribute("data-type")||"Unknown")}}let r=t.getAttribute("title")||t.querySelector(".node-description")?.textContent||"",s={},d="";try{const e=document.querySelector('.ndv-wrapper, [data-test-id="node-parameters"]');if(e){e.querySelectorAll("input, textarea, select").forEach((e=>{if(e.value&&e.value.trim()){const t=e.getAttribute("placeholder")||e.getAttribute("name")||e.getAttribute("data-test-id")||e.id;t&&!t.includes("undefined")&&t.length<50&&(s[t]=e.value.trim())}}));const t=e.textContent||"";t.length>0&&t.length<1e3&&(d=t.substring(0,500).trim())}if(0===Object.keys(s).length){t.querySelectorAll("input, textarea").forEach((e=>{if(e.value&&e.value.trim()&&e.value.length<100){const t=e.getAttribute("placeholder")||e.getAttribute("name")||"parameter";s[t]=e.value.trim()}}))}const n=t.textContent||"",o=["GET","POST","PUT","DELETE","PATCH"];for(const e of o)if(n.includes(e)){s["HTTP Method"]=e;break}const a=n.match(/(https?:\/\/[^\s]+)/);a&&(s.URL=a[1]),n.includes("webhook")&&(i="Unknown"===i?"Webhook":i),n.includes("trigger")&&(i="Unknown"===i?"Trigger":i),n.includes("schedule")&&(i="Unknown"===i?"Schedule Trigger":i)}catch(e){}const l={name:a,type:i,description:r.trim(),index:n+1,parameters:Object.keys(s).length>0?s:null,configuration:d||null,position:{x:t.style.left||t.offsetLeft||"unknown",y:t.style.top||t.offsetTop||"unknown"},connections:{inputs:t.querySelectorAll('.input-endpoint, [data-endpoint-type="input"]').length,outputs:t.querySelectorAll('.output-endpoint, [data-endpoint-type="output"]').length}};e.push(l)}catch(t){e.push({name:"Node "+(n+1),type:"Unknown",description:"Error extracting node information",index:n+1,error:t.message})}})),0===e.length){const t=document.querySelector('.ndv-wrapper, [data-test-id="node-parameters"]');if(t)try{const n=t.querySelector('[data-test-id="node-title"], .node-title, h1, h2')?.textContent?.trim()||"Current Node",o=t.querySelector('[data-test-id="node-type"]')?.textContent?.trim()||"Unknown",a={};t.querySelectorAll("input, textarea, select").forEach((e=>{if(e.value&&e.value.trim()){const t=e.getAttribute("placeholder")||e.getAttribute("name")||e.getAttribute("data-test-id")||"parameter";t&&!t.includes("undefined")&&t.length<50&&(a[t]=e.value.trim())}})),e.push({name:n,type:o,description:"Currently open node in details panel",index:1,parameters:Object.keys(a).length>0?a:null,isOpenNode:!0})}catch(e){}}return e}catch(e){return[]}}async function createWorkflowFromJson(e){try{const t="string"==typeof e?JSON.parse(e):e,n=document.querySelector('[data-test-id="canvas"], .workflow-canvas, .node-view, #n8n-editor');if(!n)throw new Error("Canvas not found. Make sure you are on an n8n workflow page.");if(window.n8n&&window.n8n.store){window.n8n.store;t.clearExisting;let e=0,o=Object.keys(t.nodes).length;for(const[o,a]of Object.entries(t.nodes))try{await addNodeToCanvas(o,a,n)&&e++}catch(e){}if(e===o){if(t.connections)for(const[e,n]of Object.entries(t.connections))for(const[t,o]of Object.entries(n.main||{}))for(const n of o)try{await addConnectionToCanvas(e,parseInt(t),n.node,n.input||0)}catch(e){}return!0}return!1}return!1}catch(e){throw e}}async function addNodeToCanvas(e,t,n){const o=document.querySelector('[data-test-id="add-node-button"], .add-node-button, [title*="Add node"]');if(o){o.click(),await new Promise((e=>setTimeout(e,500)));const n=document.querySelector('[data-test-id="node-creator-search"], .node-creator-search, input[placeholder*="search"]');if(n){let o=t.type;o.includes(".")&&(o=o.split(".").pop()),o.includes("n8n-nodes-base")&&(o=o.replace("n8n-nodes-base.","")),o=o.replace(/([A-Z])/g," $1").trim(),n.value=o,n.dispatchEvent(new Event("input",{bubbles:!0})),await new Promise((e=>setTimeout(e,300)));const a=document.querySelector('[data-test-id="node-creator-item"], .node-creator-item, .node-item');if(a)return a.click(),await new Promise((e=>setTimeout(e,500))),t.position&&await positionNode(e,t.position),t.parameters&&await configureNode(e,t.parameters),!0}}return!1}async function positionNode(e,t){try{const e=document.querySelectorAll('[data-test-id="canvas-node"]'),n=e[e.length-1];n&&void 0!==t.x&&void 0!==t.y&&(n.style.left=t.x+"px",n.style.top=t.y+"px",n.style.transform=`translate(${t.x}px, ${t.y}px)`)}catch(e){}}async function configureNode(e,t){}async function addConnectionToCanvas(e,t,n,o){}async function createWorkflowViaDom(e,t){try{if(await createWorkflowFromJson(e))return addMessageToChat("assistant","✅ **Workflow created successfully!** All nodes have been added to your canvas."),!0}catch(e){}const n=[];n.push("🏗️ **Workflow Generated Successfully!**\n"),n.push("⚠️ **Automatic node creation is not available**, but I've generated the complete workflow structure for you:\n"),n.push("📝 **Workflow Structure:**\n");for(const[t,o]of Object.entries(e.nodes)){let e=`**${o.name||t}** (${o.type.replace("n8n-nodes-base.","")})`;if(o.parameters){e+="\n  Key Parameters:";for(const[t,n]of Object.entries(o.parameters))e+="object"==typeof n?`\n    - ${t}: ${JSON.stringify(n)}`:`\n    - ${t}: ${n}`}n.push(e)}if(e.connections){n.push("\n🔗 **Connections:**");for(const[t,o]of Object.entries(e.connections))for(const[e,a]of Object.entries(o.main||{}))for(const e of a)n.push(`${t} → ${e.node}`)}n.push("\n📋 **Generated Workflow JSON:**\n"),n.push("```json"),n.push(JSON.stringify(e,null,2)),n.push("```\n"),n.push("📝 **Manual Creation Instructions:**"),n.push('1. Click the **"📥 Insert Workflow"** button below to try automatic insertion'),n.push("2. If automatic insertion fails, manually create nodes:"),n.push('   - Click the **"+"** button to add nodes'),n.push("   - Search for each node type listed above"),n.push("   - Configure the parameters as shown"),n.push("   - Connect the nodes as indicated in the connections section"),n.push("\n💡 **Tip:** You can copy the JSON above and import it directly in n8n if the Insert button doesn't work.");const o=addMessageToChat("assistant",n.join("\n"));return setTimeout((()=>{const t=document.querySelector(`[data-message-id="${o}"]`);if(t){const n=t.querySelector(".message-content");if(n){const t=document.createElement("div");t.style.cssText="\n            margin-top: 15px;\n            text-align: center;\n            padding-top: 10px;\n            border-top: 1px solid #555;\n          ";const o=document.createElement("button");o.className="workflow-insert-btn",o.innerHTML="📥 Insert Workflow",o.onclick=async()=>{try{o.disabled=!0,o.innerHTML="⏳ Inserting...";if(await insertWorkflowToN8n(e)){o.innerHTML="✅ Inserted!",o.style.background="#48bb78";showNotificationInPage("success",window.I18nManager?window.I18nManager.getMessage("workflowInsertedSuccess"):"Workflow inserted successfully!")}else{o.innerHTML="❌ Failed",o.style.background="#e53e3e";showNotificationInPage("error",window.I18nManager?window.I18nManager.getMessage("workflowInsertFailed"):"Failed to insert workflow automatically. Please try manual creation.")}setTimeout((()=>{o.disabled=!1,o.innerHTML="📥 Insert Workflow",o.style.background="#667eea"}),3e3)}catch(e){o.innerHTML="❌ Error",o.style.background="#e53e3e";showNotificationInPage("error",`${window.I18nManager?window.I18nManager.getMessage("workflowInsertError"):"Error inserting workflow"}: ${e.message}`),setTimeout((()=>{o.disabled=!1,o.innerHTML="📥 Insert Workflow",o.style.background="#667eea"}),3e3)}},t.appendChild(o),n.appendChild(t)}}}),100),!0}async function insertWorkflowToN8n(e){try{const t=getTotalNodeCount();try{if(window.n8n&&window.n8n.store&&window.n8n.store.dispatch){await window.n8n.store.dispatch("workflows/setWorkflow",{workflow:e,keepId:!1}),await new Promise((e=>setTimeout(e,1e3)));if(getTotalNodeCount()>t)return!0}}catch(e){}try{const n={meta:{instanceId:"n8n-master-import"},nodes:[],connections:e.connections||{},settings:e.settings||{},staticData:e.staticData||{},tags:e.tags||[],triggerCount:0,mode:"manual"};e.nodes&&(Array.isArray(e.nodes)?n.nodes=e.nodes:Object.keys(e.nodes).forEach((t=>{const o=e.nodes[t];n.nodes.push({parameters:o.parameters||{},id:o.id||t,name:o.name||t,type:o.type||"n8n-nodes-base.noOp",typeVersion:o.typeVersion||1,position:o.position||[100+200*n.nodes.length,100]})})));const o=JSON.stringify(n,null,2);await navigator.clipboard.writeText(o);const a=document.querySelector('[data-test-id="canvas"], .workflow-canvas, .node-view');if(a){a.focus();[new KeyboardEvent("keydown",{key:"v",code:"KeyV",ctrlKey:!0,bubbles:!0}),new KeyboardEvent("keyup",{key:"v",code:"KeyV",ctrlKey:!0,bubbles:!0})].forEach((e=>a.dispatchEvent(e))),await new Promise((e=>setTimeout(e,2e3)));const e=document.querySelector('[data-test-id*="import"], [role="dialog"], .el-dialog');if(e&&"none"!==e.style.display){const t=['[data-test-id*="import"][data-test-id*="confirm"]','[data-test-id*="import"][data-test-id*="button"]','button[type="submit"]',".el-button--primary"];let n=null;for(const o of t)if(n=e.querySelector(o),n&&!n.disabled){n.click();break}if(!n){const t=e.querySelectorAll("button");for(const e of t){const t=e.textContent.toLowerCase().trim();if((t.includes("import")||t.includes("confirm")||t.includes("ok"))&&!e.disabled){e.click();break}}}await new Promise((e=>setTimeout(e,2e3)))}if(getTotalNodeCount()>t)return!0}}catch(e){}const n=JSON.stringify(e,null,2);showNotificationInPage("info","📋 Automatic import failed. Workflow JSON copied to clipboard. Please paste it manually using Ctrl+V in the n8n canvas.");try{await navigator.clipboard.writeText(n)}catch(e){}await new Promise((e=>setTimeout(e,3e3)));return getTotalNodeCount()>t}catch(e){return!1}}function startChatIconAnimation(){const e=document.querySelector("#n8n-master-chat-widget img");if(e&&(e.style.animation="spin 1s linear infinite",!document.querySelector("#n8n-chat-spin-animation"))){const e=document.createElement("style");e.id="n8n-chat-spin-animation",e.textContent="\n          @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n          }\n        ",document.head.appendChild(e)}}function stopChatIconAnimation(){const e=document.querySelector("#n8n-master-chat-widget img");e&&(e.style.animation="");const t=document.getElementById("n8n-chat-input");t&&(t.disabled=!1,t.placeholder="Create a workflow...")}function initializeWorkflowHistory(){chrome.storage.local.get(["enableHistory"],(e=>{e.enableHistory&&startHistoryMonitoring()})),chrome.storage.onChanged.addListener(((e,t)=>{"local"===t&&e.enableHistory&&(e.enableHistory.newValue?startHistoryMonitoring():stopHistoryMonitoring())}))}async function initializeLocalProjects(){try{if(!(await chrome.storage.local.get(["localProjects"])).localProjects)return;if(void 0===window.LocalProjectsManager)return;await window.LocalProjectsManager.init()}catch(e){}chrome.storage.onChanged.addListener(((e,t)=>{if("local"===t&&e.localProjects){const t=e.localProjects?.newValue;t&&void 0!==window.LocalProjectsManager?window.LocalProjectsManager.reinitializeUI():t||void 0===window.LocalProjectsManager||window.LocalProjectsManager.removeUI()}}))}async function initializeLocalVariables(){try{if(!(await chrome.storage.local.get(["localVariables"])).localVariables)return;if(void 0===window.LocalVariablesManager)return;await window.LocalVariablesManager.init()}catch(e){}chrome.storage.onChanged.addListener(((e,t)=>{if("local"===t&&e.localVariables){const t=e.localVariables?.newValue;t&&void 0!==window.LocalVariablesManager?window.LocalVariablesManager.init():t||void 0===window.LocalVariablesManager||(window.LocalVariablesManager.stopVariablesLinkMonitoring&&window.LocalVariablesManager.stopVariablesLinkMonitoring(),window.LocalVariablesManager.hideVariablesBlock&&window.LocalVariablesManager.hideVariablesBlock())}}))}window.testAllNodes=function(){const e=getAllVisibleNodes();if(e.length>0){e.forEach(((e,t)=>{}));e.length,e.map(((e,t)=>{let n=`${t+1}. **${e.name}** (${e.category})`;return e.type&&"Unknown"!==e.type&&(n+=` - Type: ${e.type}`),e.basicInfo&&(n+=` - ${e.basicInfo}`),n})).join("\n")}return{total:e.length,nodes:e.map((e=>({name:e.name,type:e.type,category:e.category})))}},window.testNodeCount=function(){const e=getTotalNodeCount(),t=getSelectedNodeCount();['[data-test-id*="node"]',".node-default",'[class*="node-"]',".workflow-node","[data-node-type]"].forEach((e=>{const t=document.querySelectorAll(e);t.length>0&&t.forEach(((e,t)=>{if(t<3){e.getAttribute("data-node-type")||e.getAttribute("data-type"),e.getAttribute("data-test-id"),e.className&&("string"==typeof e.className?e.className:e.className.toString())}}))}));const n=getSelectedNodes(),o=document.getElementById("n8n-node-count");return updateNodeCountDisplay(),{total:e,selected:t,selectedElements:n.length,display:o?.textContent}},window.testKeywordDetection=function(e){return{isNodeQuestion:["selected","this node","these nodes","what does this","what does it","analyze this","explain this","how does this work","what is this","describe this","tell me about","what are these","explain these","how do these work","what do these do","analyze these nodes","explain the node","describe the node","node does","nodes do","what nodes are here","what nodes","nodes are here","what's in this workflow","nodes in this workflow","show me the nodes","list the nodes","этот нод","эти ноды","что делает","как работает","объясни","расскажи","опиши","анализируй","что это"].some((t=>e.toLowerCase().includes(t.toLowerCase()))),isWorkflowQuestion:["workflow","what does this","analyze","what nodes","nodes are here","what's in this","show me the nodes","list the nodes","что тут","какие ноды","что за ноды"].some((t=>e.toLowerCase().includes(t.toLowerCase())))}},window.resetAutoSaveTimer=function(){const e=lastAutoSaveTime;return lastAutoSaveTime=0,{success:!0,oldTime:e,newTime:0}},window.forceAutoSaveCheck=function(){if(autoSaveObserver){const e=document.createElement("div");return e.style.display="none",document.body.appendChild(e),setTimeout((()=>{document.body.removeChild(e)}),10),{success:!0,message:"Auto-save check triggered via DOM change"}}return{success:!1,message:"Auto-save monitoring not active"}};let historyObserver=null,historyDropdown=null;function startHistoryMonitoring(){if(historyObserver)return;activateHistoryButton(),monitorWorkflowSaves(),historyObserver=new MutationObserver((e=>{e.forEach((e=>{if("childList"===e.type||"attributes"===e.type){const e=document.querySelector('[data-test-id="workflow-history-button"]');e&&e.disabled?activateHistoryButton():e&&!e.disabled&&removeHistoryButtonTooltips(e)}}))})),historyObserver.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["disabled","aria-disabled"]});const e=setInterval((()=>{const e=document.querySelector('[data-test-id="workflow-history-button"]');e&&!e.disabled&&removeHistoryButtonTooltips(e)}),500);window.n8nMasterIntervals||(window.n8nMasterIntervals={}),window.n8nMasterIntervals.tooltipRemoval=e}function stopHistoryMonitoring(){if(historyObserver){historyObserver.disconnect(),historyObserver=null,window.n8nMasterIntervals&&window.n8nMasterIntervals.tooltipRemoval&&(clearInterval(window.n8nMasterIntervals.tooltipRemoval),delete window.n8nMasterIntervals.tooltipRemoval),historyDropdown&&(historyDropdown.remove(),historyDropdown=null);const e=document.querySelector('[data-test-id="workflow-history-button"]');e&&(e.disabled=!0,e.setAttribute("aria-disabled","true"),e.removeEventListener("click",handleHistoryButtonClick))}}function activateHistoryButton(){const e=document.querySelector('[data-test-id="workflow-history-button"]');e&&(e.disabled?(e.disabled=!1,e.setAttribute("aria-disabled","false"),e.classList.remove("_disabled_g7qox_402"),removeHistoryButtonTooltips(e),e.addEventListener("click",handleHistoryButtonClick)):removeHistoryButtonTooltips(e))}function handleHistoryButtonClick(e){e.preventDefault(),e.stopPropagation(),historyDropdown&&"none"!==historyDropdown.style.display?hideHistoryDropdown():showHistoryDropdown(e.target)}async function showHistoryDropdown(e){try{if(!isExtensionContextValid())return void handleContextInvalidation("showHistoryDropdown");historyDropdown&&historyDropdown.remove();const t=getCurrentWorkflowId();if(!t){return void showNotificationInPage("error",`❌ ${window.I18nManager?window.I18nManager.getMessage("workflowIdNotFound"):"Could not determine workflow ID"}`)}const n=await getWorkflowHistory(t);historyDropdown=document.createElement("div"),historyDropdown.id="n8n-master-history-dropdown",historyDropdown.style.cssText="\n        position: absolute;\n        top: 100%;\n        left: 0;\n        width: 350px;\n        max-height: 400px;\n        background: #1e1e1e;\n        border: 1px solid #333333;\n        border-radius: 8px;\n        box-shadow: 0 10px 40px rgba(0,0,0,0.6);\n        z-index: 10000;\n        overflow: hidden;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      ";const o=document.createElement("div");o.style.cssText="\n        padding: 12px 16px;\n        background: #2a2a2a;\n        border-bottom: 1px solid #333333;\n        color: #ffffff;\n        font-weight: 600;\n        font-size: 14px;\n      ";const a=window.I18nManager?window.I18nManager.getMessage("workflowHistory"):"Workflow History";o.textContent=`📚 ${a} (${n.length})`,historyDropdown.appendChild(o);const i=document.createElement("div");if(i.style.cssText="\n        max-height: 350px;\n        overflow-y: auto;\n        background: #1e1e1e;\n      ",0===n.length){const e=document.createElement("div");e.style.cssText="\n          padding: 20px;\n          text-align: center;\n          color: #888888;\n          font-size: 14px;\n        ";const t=window.I18nManager?window.I18nManager.getMessage("noHistoryAvailable"):"No history available yet";e.textContent=t,i.appendChild(e)}else{const e=getTotalNodeCount();n.forEach(((t,n)=>{const o=createHistoryItem(t,0===n&&t.nodeCount===e&&e>0);i.appendChild(o)}))}historyDropdown.appendChild(i);const r=e.getBoundingClientRect(),s=350,d=Math.min(400,60*n.length+60);let l=r.left,c=r.bottom+5;l+s>window.innerWidth&&(l=window.innerWidth-s-10),l<10&&(l=10),c+d>window.innerHeight&&(c=r.top-d-5),c<10&&(c=10),historyDropdown.style.position="fixed",historyDropdown.style.top=c+"px",historyDropdown.style.left=l+"px",historyDropdown.style.zIndex="99999",document.body.appendChild(historyDropdown),setTimeout((()=>{document.addEventListener("click",closeHistoryDropdownOutside)}),100)}catch(e){if(e.message&&e.message.includes("Extension context invalidated"))handleContextInvalidation("showHistoryDropdown");else{showNotificationInPage("error",`❌ ${window.I18nManager?window.I18nManager.getMessage("workflowHistoryLoadFailed"):"Failed to load workflow history"}`)}}}function hideHistoryDropdown(){historyDropdown&&(historyDropdown.remove(),historyDropdown=null,document.removeEventListener("click",closeHistoryDropdownOutside))}function closeHistoryDropdownOutside(e){!historyDropdown||historyDropdown.contains(e.target)||e.target.closest('[data-test-id="workflow-history-button"]')||hideHistoryDropdown()}function createHistoryItem(e,t){const n=document.createElement("div");n.style.cssText=`\n      padding: 12px 16px;\n      border-bottom: 1px solid #333333;\n      color: #cccccc;\n      font-size: 13px;\n      cursor: pointer;\n      transition: background 0.2s;\n      ${t?"background: #2d4a2d; border-left: 3px solid #48bb78;":""}\n    `,n.addEventListener("mouseenter",(()=>{t||(n.style.background="#2a2a2a")})),n.addEventListener("mouseleave",(()=>{t||(n.style.background="transparent")}));const o=new Date(e.timestamp),a=o.toLocaleDateString()+" "+o.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),i=document.createElement("div");i.style.cssText="\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n    ";const r=document.createElement("div"),s=window.I18nManager?window.I18nManager.getMessage("current"):"(current)",d=window.I18nManager?window.I18nManager.getMessage("nodes"):"nodes";r.innerHTML=`\n      <div style="font-weight: 500; margin-bottom: 2px;">\n        ${a} ${t?`<span style="color: #48bb78;">${s}</span>`:""}\n      </div>\n      <div style="color: #888888; font-size: 12px;">\n        ${e.nodeCount} ${d}\n      </div>\n    `;const l=document.createElement("button"),c=window.I18nManager?window.I18nManager.getMessage("copy"):"copy";return l.textContent=c,l.style.cssText="\n      background: #667eea;\n      color: white;\n      border: none;\n      padding: 4px 8px;\n      border-radius: 4px;\n      font-size: 11px;\n      cursor: pointer;\n      transition: background 0.2s;\n    ",l.addEventListener("mouseenter",(()=>{l.style.background="#5a6fd8"})),l.addEventListener("mouseleave",(()=>{l.style.background="#667eea"})),l.addEventListener("click",(t=>{t.stopPropagation(),copyWorkflowToClipboard(e.workflow)})),i.appendChild(r),t||i.appendChild(l),n.appendChild(i),n}async function copyWorkflowToClipboard(e){try{const t={meta:{instanceId:e.meta?.instanceId||"n8n-master-history"},nodes:[],connections:e.connections||{},settings:e.settings||{},staticData:e.staticData||{},tags:e.tags||[],triggerCount:e.triggerCount||0,mode:e.mode||"manual",pinData:e.pinData||{}};if(e.nodes&&(Array.isArray(e.nodes)?t.nodes=e.nodes.map((e=>({parameters:e.parameters||{},id:e.id||`node_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:e.name||"Unnamed Node",type:e.type||"n8n-nodes-base.noOp",typeVersion:e.typeVersion||1,position:e.position||[100,100],credentials:e.credentials||{},disabled:e.disabled||!1,notes:e.notes||"",notesInFlow:e.notesInFlow||!1,color:e.color||"",continueOnFail:e.continueOnFail||!1,executeOnce:e.executeOnce||!1,retryOnFail:e.retryOnFail||!1,maxTries:e.maxTries||3,waitBetweenTries:e.waitBetweenTries||1e3,alwaysOutputData:e.alwaysOutputData||!1}))):Object.keys(e.nodes).forEach((n=>{const o=e.nodes[n];t.nodes.push({parameters:o.parameters||{},id:o.id||n,name:o.name||`Node ${t.nodes.length+1}`,type:o.type||"n8n-nodes-base.noOp",typeVersion:o.typeVersion||1,position:o.position||[100+200*t.nodes.length,100],credentials:o.credentials||{},disabled:o.disabled||!1,notes:o.notes||"",notesInFlow:o.notesInFlow||!1,color:o.color||"",continueOnFail:o.continueOnFail||!1,executeOnce:o.executeOnce||!1,retryOnFail:o.retryOnFail||!1,maxTries:o.maxTries||3,waitBetweenTries:o.waitBetweenTries||1e3,alwaysOutputData:o.alwaysOutputData||!1})}))),0===t.nodes.length){return void showNotificationInPage("error",`❌ ${window.I18nManager?window.I18nManager.getMessage("noNodesFound"):"No nodes found in workflow"}`)}const n=JSON.stringify(t,null,2);await navigator.clipboard.writeText(n);const o=window.I18nManager?window.I18nManager.getMessage("workflowCopiedSuccess"):"Workflow copied to clipboard ($1 nodes). Use Ctrl+V to paste in n8n.";showNotificationInPage("success",`✅ ${o.replace("$1",t.nodes.length)}`),hideHistoryDropdown()}catch(e){showNotificationInPage("error",`❌ ${window.I18nManager?window.I18nManager.getMessage("workflowRestoreFailed"):"Failed to restore workflow from history"}`)}}function monitorWorkflowSaves(){['[data-test-id="save-button"]','[data-test-id="workflow-save-button"]','button[title*="save"]','button[aria-label*="save"]'].forEach((e=>{document.addEventListener("click",(async t=>{t.target.closest(e)&&setTimeout((async()=>{try{const e=getCurrentWorkflowId();e&&triggerApiBackup(e,null)}catch(e){}}),1e3)}),!0)})),document.addEventListener("keydown",(async e=>{(e.ctrlKey||e.metaKey)&&"s"===e.key&&setTimeout((async()=>{try{const e=getCurrentWorkflowId();e&&triggerApiBackup(e,null)}catch(e){}}),1e3)}))}function getCurrentWorkflowId(){try{const e=window.location.pathname.match(/\/workflow\/([^\/]+)/);return e&&e[1]&&"new"!==e[1]?e[1]:window.n8n?.store?.state?.workflows?.workflow?.id?window.n8n.store.state.workflows.workflow.id:window.Vue?.$store?.state?.workflows?.workflow?.id?window.Vue.$store.state.workflows.workflow.id:window.location.pathname.includes("/workflow/new")||window.location.pathname.endsWith("/workflow")?"new_workflow_"+Date.now():null}catch(e){return null}}async function extractCurrentWorkflow(){try{const n8nStorePaths=[()=>window.n8n?.store?.state?.workflows?.workflow,()=>window.n8n?.store?.getters?.workflow,()=>window.n8n?.store?.getters?.allNodes,()=>window.n8n?.store?.state?.ui?.workflow,()=>window.n8n?.workflowsStore?.workflow,()=>window.n8n?.workflow,()=>window.n8n?.store?.state?.workflows,()=>window.n8n?.store?.state],pathNames=["window.n8n.store.state.workflows.workflow","window.n8n.store.getters.workflow","window.n8n.store.getters.allNodes","window.n8n.store.state.ui.workflow","window.n8n.workflowsStore.workflow","window.n8n.workflow","window.n8n.store.state.workflows","window.n8n.store.state"];for(let e=0;e<n8nStorePaths.length;e++)try{const t=n8nStorePaths[e](),n=pathNames[e];if(t&&t.nodes)return{nodes:t.nodes,connections:t.connections||{},pinData:t.pinData||{},meta:t.meta||{instanceId:t.meta?.instanceId||"n8n-master-export"},name:t.name||"Untitled Workflow",settings:t.settings||{},staticData:t.staticData||{},tags:t.tags||[],triggerCount:t.triggerCount||0,mode:t.mode||"manual"};if(Array.isArray(t)&&t.length>0)return{nodes:t,connections:{},pinData:{},meta:{instanceId:"n8n-master-export"},name:"Current Workflow",settings:{},staticData:{},tags:[],triggerCount:0,mode:"manual"};if(t&&t.workflow&&t.workflow.nodes){const e=t.workflow;return{nodes:e.nodes,connections:e.connections||{},pinData:e.pinData||{},meta:e.meta||{instanceId:e.meta?.instanceId||"n8n-master-export"},name:e.name||"Untitled Workflow",settings:e.settings||{},staticData:e.staticData||{},tags:e.tags||[],triggerCount:e.triggerCount||0,mode:e.mode||"manual"}}}catch(e){}const vueStorePaths=["window.Vue?.$store?.state?.workflows?.workflow","window.Vue?.$store?.getters?.workflow","window.Vue?.$store?.state?.ui?.workflow"];for(const path of vueStorePaths)try{const workflow=eval(path);if(workflow&&workflow.nodes)return{nodes:workflow.nodes,connections:workflow.connections||{},pinData:workflow.pinData||{},meta:workflow.meta||{instanceId:workflow.meta?.instanceId||"n8n-master-export"},name:workflow.name||"Untitled Workflow",settings:workflow.settings||{},staticData:workflow.staticData||{},tags:workflow.tags||[],triggerCount:workflow.triggerCount||0,mode:workflow.mode||"manual"}}catch(e){}const globalPaths=["window.__N8N_WORKFLOW__","window.workflowData","window.currentWorkflow"];for(const path of globalPaths)try{const workflow=eval(path);if(workflow&&workflow.nodes)return{nodes:workflow.nodes,connections:workflow.connections||{},pinData:workflow.pinData||{},meta:workflow.meta||{instanceId:workflow.meta?.instanceId||"n8n-master-export"},name:workflow.name||"Untitled Workflow",settings:workflow.settings||{},staticData:workflow.staticData||{},tags:workflow.tags||[],triggerCount:workflow.triggerCount||0,mode:workflow.mode||"manual"}}catch(e){}const scripts=document.querySelectorAll("script");for(const e of scripts)try{const t=e.textContent||e.innerHTML;if(t.includes("workflow")&&t.includes("nodes")){const e=t.match(/\{[^{}]*"nodes"[^{}]*\}/g);if(e)for(const t of e)try{const e=JSON.parse(t);if(e.nodes&&Array.isArray(e.nodes)&&e.nodes.length>0)return{nodes:e.nodes,connections:e.connections||{},pinData:e.pinData||{},meta:e.meta||{instanceId:e.meta?.instanceId||"n8n-master-export"},name:e.name||"Untitled Workflow",settings:e.settings||{},staticData:e.staticData||{},tags:e.tags||[],triggerCount:e.triggerCount||0,mode:e.mode||"manual"}}catch(e){}}}catch(e){}const localStorageKeys=Object.keys(localStorage);for(const e of localStorageKeys)try{const t=JSON.parse(localStorage.getItem(e));if(t&&t.nodes&&Array.isArray(t.nodes)&&t.nodes.length>0){const e=t.nodes[0];if(e&&e.type&&e.id&&e.name)return{nodes:t.nodes,connections:t.connections||{},pinData:t.pinData||{},meta:t.meta||{instanceId:t.meta?.instanceId||"n8n-master-export"},name:t.name||"Untitled Workflow",settings:t.settings||{},staticData:t.staticData||{},tags:t.tags||[],triggerCount:t.triggerCount||0,mode:t.mode||"manual"}}}catch(e){}return await extractWorkflowFromDOM()}catch(e){return null}}async function getWorkflowHistory(e){try{if(void 0!==window.IndexedDBManager&&window.IndexedDBManager.db){return await window.IndexedDBManager.getWorkflowHistory(e)}{const t=`workflow_history_${e}`,n=await chrome.storage.local.get([t]);return n[t]||[]}}catch(e){return[]}}function removeHistoryButtonTooltips(e){if(!e)return;if(!document.getElementById("n8n-master-tooltip-hide")){const e=document.createElement("style");e.id="n8n-master-tooltip-hide",e.textContent='\n        .n8n-tooltip,\n        [data-test-id="workflow-history-button"] .n8n-tooltip,\n        [data-test-id="workflow-history-button"] + .n8n-tooltip {\n          display: none !important;\n          visibility: hidden !important;\n          opacity: 0 !important;\n          pointer-events: none !important;\n        }\n        \n        /* Fix toast notifications z-index */\n        .content-toast.right {\n          z-index: 10000 !important;\n        }\n      ',document.head.appendChild(e)}const t=["title","data-tooltip","aria-label","data-original-title","data-bs-title","data-toggle","data-placement","tooltip","data-tippy-content"];t.forEach((t=>{e.removeAttribute(t)}));const n=e.querySelectorAll("*");n.forEach((e=>{t.forEach((t=>{e.removeAttribute(t)}))})),e.classList.remove("tooltip","has-tooltip","tippy-target","n8n-tooltip"),n.forEach((e=>{e.classList.remove("tooltip","has-tooltip","tippy-target","n8n-tooltip")})),Object.keys(e.dataset).forEach((t=>{(t.toLowerCase().includes("tooltip")||t.toLowerCase().includes("title"))&&delete e.dataset[t]}));document.querySelectorAll(".n8n-tooltip").forEach((e=>{e.style.display="none",e.style.visibility="hidden",e.style.opacity="0"}))}async function extractWorkflowFromDOM(){try{const e=document.querySelectorAll('[data-test-id^="canvas-node"]');if(0===e.length)return null;const t=Array.from(e).filter((e=>{const t=e.getBoundingClientRect();if(t.width<100||t.height<60)return!1;const n=e.textContent||"";return!n.includes("Add node")&&!n.includes("Node Creator")&&(!e.closest(".sidebar, .menu, .node-creator")&&(t.left>200&&t.top>100))}));if(0===t.length)return null;const n=[],o={};if(t.forEach(((e,t)=>{try{const o=`node_${Date.now()}_${t}`,a=e.getBoundingClientRect();let i="Unknown Node";const r=['[data-test-id="node-title"]',".node-name",".node-title","h3","h4"];for(const t of r){const n=e.querySelector(t);if(n&&n.textContent&&n.textContent.trim()){i=n.textContent.trim();break}}let s=e.getAttribute("data-node-type")||e.getAttribute("data-type")||"n8n-nodes-base.noOp";if("n8n-nodes-base.noOp"===s){const t=e.textContent||"";t.includes("HTTP Request")?s="n8n-nodes-base.httpRequest":t.includes("Email Send")?s="n8n-nodes-base.emailSend":t.includes("Webhook")?s="n8n-nodes-base.webhook":t.includes("Schedule")?s="n8n-nodes-base.scheduleTrigger":t.includes("Manual")?s="n8n-nodes-base.manualTrigger":t.includes("Code")?s="n8n-nodes-base.code":t.includes("Set")?s="n8n-nodes-base.set":t.includes("IF")?s="n8n-nodes-base.if":t.includes("Date")?s="n8n-nodes-base.dateTime":t.includes("Edit Fields")&&(s="n8n-nodes-base.set")}const d={parameters:{},id:o,name:i,type:s,typeVersion:1,position:[Math.round(a.left-200),Math.round(a.top-100)],disabled:!1};n.push(d)}catch(e){}})),n.length>1){const e=[...n].sort(((e,t)=>e.position[0]-t.position[0]));for(let t=0;t<e.length-1;t++){const n=e[t],a=e[t+1];o[n.name]||(o[n.name]={main:[[]]}),o[n.name].main[0].push({node:a.name,type:"main",index:0})}}return{nodes:n,connections:o,pinData:{},meta:{instanceId:"n8n-master-export"},name:"Extracted Workflow",settings:{},staticData:{},tags:[],triggerCount:0,mode:"manual"}}catch(e){return null}}function isExtensionContextValid(){try{return!!(chrome&&chrome.runtime&&chrome.runtime.id)}catch(e){return!1}}function handleContextInvalidation(e){showNotificationInPage("warning",`⚠️ ${window.I18nManager?window.I18nManager.getMessage("extensionUpdated"):"Extension was updated. Please reload the page to continue using N8N Master."}`)}async function getWorkflowHistory(e){try{if(!isExtensionContextValid())return handleContextInvalidation("getWorkflowHistory"),[];if(void 0!==window.IndexedDBManager&&window.IndexedDBManager.db){return await window.IndexedDBManager.getWorkflowHistory(e)}{const t=`workflow_history_${e}`,n=await chrome.storage.local.get([t]);return n[t]||[]}}catch(e){return e.message&&e.message.includes("Extension context invalidated")&&handleContextInvalidation("getWorkflowHistory"),[]}}function startWorkflowImportMonitoring(e){let t,n=0;const o=getTotalNodeCount();t=setInterval((()=>{n++;try{const a=getTotalNodeCount();if(a>o&&a>=e){setTimeout((()=>{window.refreshNodeCount?window.refreshNodeCount():updateNodeCountDisplay(),setTimeout((()=>{window.refreshNodeCount&&window.refreshNodeCount(),updateNodeCountDisplay()}),1e3),setTimeout((()=>{window.refreshNodeCount&&window.refreshNodeCount(),updateNodeCountDisplay()}),2e3)}),1e3);const e=window.I18nManager?window.I18nManager.getMessage("workflowImportedSuccess"):"Workflow imported successfully! ($1 nodes)";return showNotificationInPage("success",`✅ ${e.replace("$1",a)}`),void clearInterval(t)}if(n>=60)return void clearInterval(t)}catch(e){clearInterval(t)}}),1e3);const a=new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.forEach((e=>{if(e.nodeType===Node.ELEMENT_NODE){const n=e.textContent||"";(n.includes("imported")||n.includes("Workflow imported")||n.includes("Successfully imported")||n.includes("Import successful"))&&(setTimeout((()=>{if(window.refreshNodeCount){window.refreshNodeCount()}else updateNodeCountDisplay();setTimeout((()=>{window.refreshNodeCount&&window.refreshNodeCount(),updateNodeCountDisplay()}),1e3),setTimeout((()=>{window.refreshNodeCount&&window.refreshNodeCount(),updateNodeCountDisplay()}),2e3)}),1e3),clearInterval(t),a.disconnect())}}))}))}));a.observe(document.body,{childList:!0,subtree:!0}),setTimeout((()=>{a.disconnect()}),6e4)}function setupSPANavigation(){const e=history.pushState.bind(history),t=history.replaceState.bind(history);function n(){history.pushState.toString().includes("n8nMasterOverride")||(history.pushState=function(...t){e(...t),setTimeout(handleURLChange,10)},history.replaceState=function(...e){t(...e),setTimeout(handleURLChange,10)})}n();const o=setInterval(n,2e3);window.addEventListener("popstate",handleURLChange);const a=setInterval((()=>{window.location.href!==currentURL&&handleURLChange()}),1e3),i=new MutationObserver((e=>{e.forEach((e=>{"childList"===e.type&&window.location.href!==currentURL&&handleURLChange()}))}));i.observe(document.body,{childList:!0,subtree:!0}),window.n8nMasterCleanup={reOverrideInterval:o,urlPollingInterval:a,observer:i,cleanup:function(){clearInterval(o),clearInterval(a),i.disconnect(),window.removeEventListener("popstate",handleURLChange),history.pushState=e,history.replaceState=t}}}function handleURLChange(){const e=window.location.href;window.location.pathname;if(e!==currentURL){currentURL=e;const t=detectN8nPage();t&&!isCurrentlyActive?(isCurrentlyActive=!0,init()):!t&&isCurrentlyActive&&(cleanupExtension(),isCurrentlyActive=!1)}}function cleanupExtension(){cleanupWorkflowExecutionCopy(),floatingButton&&(floatingButton.remove(),floatingButton=null),chatWidget&&(chatWidget.remove(),chatWidget=null),window.templatesButton&&(window.templatesButton.remove(),window.templatesButton=null),window.templatesWidget&&(window.templatesWidget.remove(),window.templatesWidget=null);try{stopAutoSaveMonitoring(),stopAutoPinMonitoring(),stopHistoryMonitoring()}catch(e){}nodeCountMonitorInterval&&(clearInterval(nodeCountMonitorInterval),nodeCountMonitorInterval=null)}window.testN8nMasterFunctions=function(){getTotalNodeCount(),getSelectedNodeCount();try{extractWorkflowData()}catch(e){}extractCurrentWorkflow().then((e=>{})).catch((e=>{}));getCurrentWorkflowId();try{if(window.n8n?.store?.state){window.n8n.store.state.workflows}}catch(e){}try{if(window.Vue?.$store?.state){window.Vue.$store.state.workflows}}catch(e){}Object.keys(localStorage).filter((e=>e.includes("workflow")||e.includes("n8n")));['[data-test-id="canvas"]',".workflow-canvas",".node-view","#n8n-editor"].forEach((e=>{document.querySelector(e)}))},window.debugN8nStore=function(){try{if(window.n8n&&window.n8n.store){if(window.n8n.store.state&&window.n8n.store.state.workflows&&window.n8n.store.state.workflows.workflow){window.n8n.store.state.workflows.workflow}if(window.n8n.store.getters){try{window.n8n.store.getters.workflow}catch(e){}try{window.n8n.store.getters.allNodes}catch(e){}}}window.Vue&&window.Vue.$store;Object.keys(localStorage).filter((e=>e.includes("workflow")||e.includes("n8n")))}catch(e){}},window.manualExtractWorkflow=function(){const e=debugN8nStore();if(e)return e;const t=document.querySelectorAll("script");for(let e=0;e<t.length;e++){const n=t[e],o=n.textContent||n.innerHTML;if(o.includes('"nodes"')&&o.includes('"connections"'))try{const e=o.match(/\{[^{}]*"nodes"\s*:\s*\[[^\]]*\][^{}]*\}/g);if(e)for(const t of e)try{const e=JSON.parse(t);if(e.nodes&&Array.isArray(e.nodes)&&e.nodes.length>0)return e}catch(e){}}catch(e){}}return null},window.listN8nMasterFunctions=function(){window.testN8nMasterFunctions},setTimeout((()=>{}),1e3),window.countWorkflowNodes=function(){try{try{if(window.n8n&&window.n8n.store&&window.n8n.store.getters){const e=window.n8n.store.getters.allNodes;if(e&&Array.isArray(e))return e.length}}catch(e){}if(window.Vue?.$store?.state?.workflows?.workflow?.nodes){const e=window.Vue.$store.state.workflows.workflow.nodes;return Array.isArray(e)?e.length:Object.keys(e).length}let e=document.querySelectorAll('[data-test-id^="canvas-node"]');if(e.length>0){return Array.from(e).filter((e=>{const t=e.getBoundingClientRect();if(t.width<100||t.height<60)return!1;const n=e.textContent||"";if(n.includes("Add node")||n.includes("Node Creator")||n.includes("Add first step")||n.includes("Click to add")||n.includes("Drag to connect"))return!1;if(e.closest(".sidebar, .menu, .node-creator, .ndv-wrapper"))return!1;const o=e.getAttribute("data-node-type")||e.querySelector("[data-node-type]")||e.getAttribute("data-type"),a=e.querySelector('.node-name, .node-title, [data-test-id="node-title"]')||n.length>0,i=t.width>0&&t.height>0,r=t.left>200&&t.top>100;return(o||a)&&i&&r})).length}try{const e=extractWorkflowData();if(e&&"string"==typeof e&&e.includes("nodes:")){const t=e.match(/Detected (\d+) nodes:/);if(t){return parseInt(t[1])}}}catch(e){}return 0}catch(e){return 0}},window.refreshNodeCount=function(){const e=getTotalNodeCount(),t=document.getElementById("n8n-node-count");return t&&(t.textContent=`${e}/${e}`,t.title=`${e} workflow nodes`,setTimeout((()=>{updateNodeCountDisplay()}),100)),e},window.testNodeCountAfterInsertion=function(){countWorkflowNodes();setTimeout((()=>{countWorkflowNodes();refreshNodeCount()}),1e3),setTimeout((()=>{countWorkflowNodes();refreshNodeCount()}),3e3)},window.forceUpdateNodeCount=function(){const e=document.getElementById("n8n-node-count");if(!e)return;const t=getTotalNodeCount();return e.textContent=`${t}/${t}`,e.title=`${t} workflow nodes`,updateNodeCountDisplay(),setTimeout((()=>{const t=getTotalNodeCount();e.textContent=`${t}/${t}`,e.title=`${t} workflow nodes`,updateNodeCountDisplay()}),500),t},window.countWorkflowNodes=function(){const e=getTotalNodeCount(),t=getSelectedNodeCount();if(['[data-test-id^="canvas-node"]','[data-test-id*="node"]:not([data-test-id*="add"]):not([data-test-id*="creator"])',".node-default","[data-node-type]",".workflow-node"].forEach((e=>{document.querySelectorAll(e)})),window.n8n&&window.n8n.store)try{if(window.n8n.store.getters&&window.n8n.store.getters.allNodes){window.n8n.store.getters.allNodes}if(window.n8n.store.state){const e=window.n8n.store.state;if(e.workflows&&e.workflows.workflow){e.workflows.workflow}e.workflow&&e.workflow.nodes,e.nodes}}catch(e){}return{total:e,selected:t}},window.refreshNodeCount=function(){updateNodeCountDisplay();document.getElementById("n8n-node-count")},window.forceUpdateNodeCount=function(){updateNodeCountDisplay();const e=document.getElementById("n8n-master-chat-widget");if(e){const t=e.querySelector(".chat-header h3");if(t){const e=getTotalNodeCount(),n=t.querySelector("#n8n-node-count");n&&(n.textContent=`${e}/${e}`)}}return getTotalNodeCount()},window.testNodeCountAfterInsertion=function(){setTimeout((()=>{window.countWorkflowNodes(),window.forceUpdateNodeCount()}),1e3),setTimeout((()=>{window.countWorkflowNodes(),window.forceUpdateNodeCount()}),3e3),setTimeout((()=>{window.countWorkflowNodes(),window.forceUpdateNodeCount()}),5e3)},window.listN8nMasterFunctions=function(){};const originalInit=init;async function formatNodeContextWithWorkflow(e,t){try{let n=null,o="Untitled",a=null;if(t.nodes?(n=t.nodes,o=t.name||o,a=t.connections):t.workflow&&t.workflow.nodes?(n=t.workflow.nodes,o=t.workflow.name||o,a=t.workflow.connections):t.data&&t.data.nodes&&(n=t.data.nodes,o=t.data.name||o,a=t.data.connections),a&&Object.entries(a).slice(0,2).forEach((([e,t])=>{})),!n)return null;const i=Array.isArray(n)?n:Object.values(n),r=i.find((t=>t.name===e.nodeName||t.id===e.nodeId||t.name.toLowerCase().includes(e.nodeName.toLowerCase())));if(!r)return null;const s=[];if(a&&(r.id||r.name)){const e=[r.id,r.name].filter(Boolean);Object.entries(a).forEach((([t,n])=>{n&&n.main&&n.main[0]&&n.main[0].forEach((n=>{e.includes(n.node)||e.includes(t);if(n.node&&e.includes(n.node)){const e=i.find((e=>e.id===t||e.name===t));e&&s.push({type:"input",node:e,outputIndex:n.outputIndex||0,inputIndex:n.inputIndex||0})}}))}));const t=a[r.id]||a[r.name];t&&t.main&&t.main[0]?t.main[0].forEach((e=>{const t=i.find((t=>t.id===e.node||t.name===e.node));t&&s.push({type:"output",node:t,outputIndex:e.outputIndex||0,inputIndex:e.inputIndex||0})})):Object.entries(a).forEach((([e,t])=>{e!==r.id&&e!==r.name||t&&t.main}))}let d=`ENHANCED NODE CONTEXT (via N8N API):\nWorkflow: "${o}"\nCurrent Node: "${r.name}" (${r.type})\n\nCURRENT NODE CONFIGURATION:\n${Object.entries(r.parameters||{}).map((([e,t])=>`- ${e}: ${"object"==typeof t?JSON.stringify(t).substring(0,100)+"...":t}`)).join("\n")||"- No parameters configured"}\n\nWORKFLOW CONTEXT:\n- Total nodes in workflow: ${i.length}\n- Current node position: ${r.position?`x:${r.position[0]}, y:${r.position[1]}`:"Unknown"}\n\nCONNECTED NODES:`;if(s.length>0){const e=s.filter((e=>"input"===e.type)),t=s.filter((e=>"output"===e.type));e.length>0&&(d+=`\nInput connections (${e.length}):`,e.forEach((e=>{d+=`\n  ← ${e.node.name} (${e.node.type})`}))),t.length>0&&(d+=`\nOutput connections (${t.length}):`,t.forEach((e=>{d+=`\n  → ${e.node.name} (${e.node.type})`})))}else d+="\n- No connections found";if(window.NodeContextAnalyzer){const t=window.NodeContextAnalyzer.formatContextForAI(e);d+=`\n\nSTANDARD NODE CONTEXT:\n${t}`}return d+=`\n\nUSER QUESTION: ${e.userMessage||"Node-related question"}\n\nRESPONSE REQUIREMENTS:\n1. Answer based on the EXACT node configuration and workflow context shown above\n2. Consider the node's role in the overall workflow (input/output connections)\n3. Use specific parameter names and values from the configuration\n4. Explain how this node fits into the workflow's data flow\n5. Provide actionable configuration advice based on connected nodes\n6. Focus on this specific node instance within its workflow context\n\nPlease provide detailed, context-aware help for configuring this "${r.name}" node within the "${o}" workflow.`,d}catch(e){return null}}async function formatSelectedNodesContextWithWorkflow(e,t,n){try{let o=null,a="Untitled",i=null;if(t.nodes?(o=t.nodes,a=t.name||a,i=t.connections):t.workflow&&t.workflow.nodes?(o=t.workflow.nodes,a=t.workflow.name||a,i=t.workflow.connections):t.data&&t.data.nodes&&(o=t.data.nodes,a=t.data.name||a,i=t.data.connections),!o)return null;const r=Array.isArray(o)?o:Object.values(o),s=[];if(e.forEach((e=>{const t=r.find((t=>t.name===e.name||t.name.toLowerCase().includes(e.name.toLowerCase())));t&&s.push({selected:e,workflow:t})})),0===s.length)return null;let d=`ENHANCED SELECTED NODES CONTEXT (via N8N API):\nWorkflow: "${a}"\nSelected Nodes: ${s.length} of ${r.length} total nodes\n\nSELECTED NODES DETAILS:`;return s.forEach(((e,t)=>{const{selected:n,workflow:o}=e;if(d+=`\n\n${t+1}. **${o.name}** (${o.type})`,o.parameters&&Object.keys(o.parameters).length>0&&(d+="\n   Configuration:",Object.entries(o.parameters).slice(0,5).forEach((([e,t])=>{const n="object"==typeof t?JSON.stringify(t).substring(0,80)+"...":t;d+=`\n     - ${e}: ${n}`}))),o.position&&(d+=`\n   Position: x:${o.position[0]}, y:${o.position[1]}`),i){const e=[];Object.entries(i).forEach((([t,n])=>{n&&n.main&&n.main[0]&&n.main[0].forEach((n=>{if(n.node===o.id){const n=r.find((e=>e.id===t));n&&e.push(`← ${n.name}`)}}))})),i[o.id]&&i[o.id].main&&i[o.id].main[0]&&i[o.id].main[0].forEach((t=>{const n=r.find((e=>e.id===t.node));n&&e.push(`→ ${n.name}`)})),e.length>0&&(d+=`\n   Connections: ${e.join(", ")}`)}})),d+=`\n\nWORKFLOW OVERVIEW:\n- Total nodes: ${r.length}\n- Node types: ${[...new Set(r.map((e=>e.type)))].slice(0,8).join(", ")}\n\nUSER QUESTION: ${n}\n\nRESPONSE REQUIREMENTS:\n1. Focus on the selected nodes and their specific configurations\n2. Explain how these nodes work together within the workflow\n3. Consider the data flow between selected and connected nodes\n4. Provide specific configuration advice based on the workflow context\n5. Highlight any potential issues or optimization opportunities\n6. Use exact parameter names and values from the API data\n\nPlease provide detailed analysis of the selected nodes within the context of the "${a}" workflow.`,d}catch(e){return null}}async function getEnhancedWorkflowContext(){try{const e=getCurrentWorkflowId();if(e&&window.N8NApiClient&&window.N8NApiClient.initialized&&window.N8NApiClient.apiKey)try{let t=null;if("function"==typeof window.N8NApiClient.getWorkflowById?t=await window.N8NApiClient.getWorkflowById(e):"function"==typeof window.N8NApiClient.getWorkflow?t=await window.N8NApiClient.getWorkflow(e):"function"==typeof window.N8NApiClient.fetchWorkflow?t=await window.N8NApiClient.fetchWorkflow(e):"function"==typeof window.N8NApiClient.loadWorkflow?t=await window.N8NApiClient.loadWorkflow(e):"function"==typeof window.N8NApiClient.getWorkflowData&&(t=await window.N8NApiClient.getWorkflowData(e)),t){let e=null,n="Untitled",o=null;if(t.nodes?(e=t.nodes,n=t.name||n,o=t.connections):t.workflow&&t.workflow.nodes?(e=t.workflow.nodes,n=t.workflow.name||n,o=t.workflow.connections):t.data&&t.data.nodes&&(e=t.data.nodes,n=t.data.name||n,o=t.data.connections),e){Array.isArray(e)?e.length:Object.keys(e).length;const t=(Array.isArray(e)?e:Object.values(e)).map((e=>({name:e.name,type:e.type,parameters:e.parameters||{},position:e.position}))),a=o?Array.isArray(o)?o.length:Object.keys(o).length:0;return`Workflow "${n}" (via N8N API) contains ${t.length} nodes:\n\n${t.map(((e,t)=>{let n=`${t+1}. **${e.name}** (${e.type})`;if(e.parameters&&Object.keys(e.parameters).length>0){const t=Object.entries(e.parameters).filter((([e,t])=>t&&"options"!==e)).slice(0,3).map((([e,t])=>`${e}: ${"object"==typeof t?JSON.stringify(t).substring(0,50)+"...":t}`)).join(", ");t&&(n+=`\n   Config: ${t}`)}return n})).join("\n")}\n\nConnections: ${a} connection groups\nSource: N8N API (complete workflow data)`}}}catch(e){}const t=getAllVisibleNodes();if(t.length>0){const e=document.querySelector('[data-test-id="workflow-name"], .workflow-name, h1[class*="workflow"], [placeholder*="workflow name"]');return`Workflow "${e&&e.textContent?e.textContent.trim():e&&e.value?e.value.trim():"Current Workflow"}" contains ${t.length} visible nodes:\n\n${t.map(((e,t)=>{let n=`${t+1}. **${e.name}** (${e.category})`;return e.type&&"Unknown"!==e.type&&(n+=` - Type: ${e.type}`),e.basicInfo&&(n+=` - ${e.basicInfo}`),n})).join("\n")}\n\nSource: Enhanced DOM analysis`}const n=document.querySelector('[data-test-id="workflow-name"], .workflow-name, h1[class*="workflow"]'),o=document.querySelectorAll('[data-test-id*="node"], .node-default, [class*="node-"], .vue-flow__node');if(o.length>0||n){let e="";if(n&&n.textContent.trim()&&(e+=`Workflow: "${n.textContent.trim()}"\n`),o.length>0){e+=`Detected ${o.length} workflow elements on the page\n`;const t=Array.from(o).map((e=>(e.getAttribute("data-node-type")||e.getAttribute("data-type")||e.className.match(/node-type-([^\s]+)/)?.[1]||"Unknown").replace("n8n-nodes-base.",""))).filter(((e,t,n)=>n.indexOf(e)===t&&"Unknown"!==e)).slice(0,10);t.length>0&&(e+=`Node types detected: ${t.join(", ")}\n`)}if(e+="Source: Basic DOM detection",e.trim())return e}return null}catch(e){return null}}function triggerApiBackup(e,t){try{if(window.N8NApiClient&&window.N8NApiClient.initialized&&window.N8NApiClient.apiKey){const n=new CustomEvent("n8n-workflow-saved",{detail:{workflowId:e,workflow:t,timestamp:Date.now()}});window.dispatchEvent(n)}}catch(e){}}init=async function(){if(window.n8nMasterCleanup||setupSPANavigation(),detectN8nPage()&&!(isCurrentlyActive&&floatingButton&&chatWidget))return isCurrentlyActive=!0,originalInit.call(this)},window.testWorkflowDetection=function(){},window.forceReactivateExtension=function(){window.location.pathname.includes("/workflow/")&&(floatingButton||chatWidget?(cleanupExtension(),setTimeout((()=>{isCurrentlyActive=!1,currentURL=window.location.href,handleURLChange()}),100)):(isCurrentlyActive=!1,currentURL=window.location.href,handleURLChange()))},window.listN8nMasterFunctions=function(){return{available:!0,functions:["checkN8nMaster","quickTestWorkflow","testN8nMaster","resetAutoSaveTimer","forceAutoSaveCheck","testWorkflowHistory","testNodeCountAfterInsertion","debugN8nStore","listN8nMasterFunctions"]}};let workflowExecutionCopyEnabled=!1,copyToEditorButtonObserver=null;function initializeWorkflowExecutionCopy(){try{workflowExecutionCopyEnabled=!0,startCopyToEditorMonitoring()}catch(e){}}function cleanupWorkflowExecutionCopy(){try{workflowExecutionCopyEnabled=!1,stopCopyToEditorMonitoring()}catch(e){}}function startCopyToEditorMonitoring(){try{stopCopyToEditorMonitoring(),copyToEditorButtonObserver=new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.forEach((e=>{if(e.nodeType===Node.ELEMENT_NODE){checkAndInterceptCopyToEditorButton(e);(e.querySelectorAll?e.querySelectorAll("button"):[]).forEach((e=>checkAndInterceptCopyToEditorButton(e)))}}))}))})),copyToEditorButtonObserver.observe(document.body,{childList:!0,subtree:!0});document.querySelectorAll("button").forEach((e=>checkAndInterceptCopyToEditorButton(e)))}catch(e){}}function stopCopyToEditorMonitoring(){copyToEditorButtonObserver&&(copyToEditorButtonObserver.disconnect(),copyToEditorButtonObserver=null)}function checkAndInterceptCopyToEditorButton(e){try{if(!workflowExecutionCopyEnabled||!e)return;(e.textContent?.toLowerCase().includes("copy to editor")||"copy-to-editor"===e.getAttribute("data-test-id")||e.title?.toLowerCase().includes("copy to editor")||e.getAttribute("aria-label")?.toLowerCase().includes("copy to editor"))&&!e.hasAttribute("data-n8n-master-intercepted")&&(e.setAttribute("data-n8n-master-intercepted","true"),e.addEventListener("click",handleCopyToEditorClick,{capture:!0}))}catch(e){}}async function handleCopyToEditorClick(e){try{e.preventDefault(),e.stopPropagation(),showNotificationInPage("info","🔄 Processing execution data...");const t=extractExecutionIdFromPage(),n=extractWorkflowIdFromPage();if(!t)throw new Error("Could not extract execution ID from page");if(!n)throw new Error("Could not extract workflow ID from page");if(!window.N8NApiClient||!window.N8NApiClient.initialized||!window.N8NApiClient.apiKey)throw new Error("N8N API client not available or not configured. Please set up your API key in extension settings.");const o=await window.N8NApiClient.processExecutionCopy(t,n);if(!o.success)throw new Error(o.error||"Failed to process execution copy");o.apiLimitation?(showNotificationInPage("warning",`⚠️ ${o.message}. You'll need to manually pin the data in the workflow editor.`),navigator.clipboard&&navigator.clipboard.writeText(JSON.stringify(o.pinData,null,2)).then((()=>{setTimeout((()=>{showNotificationInPage("info","📋 Execution data copied to clipboard! Paste it manually in the workflow editor.")}),2e3)})).catch()):showNotificationInPage("success",`✅ Copied execution data for ${o.nodesUpdated} nodes to workflow`),setTimeout((()=>{const e=`/workflow/${n}`;window.location.href=e}),3e3)}catch(e){showNotificationInPage("error",`❌ Failed to copy execution data: ${e.message}`)}}function extractExecutionIdFromPage(){try{const e=window.location.pathname.match(/\/executions\/([^\/]+)/);if(e)return e[1];const t=document.querySelectorAll('[data-execution-id], [data-test-id*="execution"]');for(const e of t){const t=e.getAttribute("data-execution-id")||e.getAttribute("data-test-id")?.replace("execution-","")||e.textContent?.match(/execution[:\s]+(\w+)/i)?.[1];if(t)return t}const n=document.querySelectorAll('.breadcrumb, [data-test-id*="breadcrumb"], nav a');for(const e of n){const t=e.textContent?.match(/^([a-zA-Z0-9]+)$/)?.[1];if(t&&t.length>5)return t}return null}catch(e){return null}}function extractWorkflowIdFromPage(){try{if(window.n8n&&window.n8n.store&&window.n8n.store.state){const e=window.n8n.store.state;if(e.workflows&&e.workflows.workflow&&e.workflows.workflow.id)return e.workflows.workflow.id;if(e.activeWorkflows&&Object.keys(e.activeWorkflows).length>0){return Object.keys(e.activeWorkflows)[0]}}const e=window.location.href.match(/\/workflow\/([^\/\?]+)\/executions/);if(e)return e[1];const t=document.referrer;if(t){const e=t.match(/\/workflow\/([^\/\?]+)/);if(e&&"new"!==e[1]){const t=e[1];if(/^[0-9]+$/.test(t)||t.length>10)return t}}const n=document.querySelectorAll('script[type="application/json"], script');for(const e of n)try{const t=e.textContent;if(t&&t.includes("workflowId")){const e=t.match(/"workflowId"\s*:\s*"([^"]+)"/);if(e){const t=e[1];if(/^[0-9]+$/.test(t)||t.length>10)return t}}}catch(e){}const o=document.querySelectorAll("[data-workflow-id]");for(const e of o){const t=e.getAttribute("data-workflow-id");if(t&&(/^[0-9]+$/.test(t)||t.length>10))return t}const a=document.querySelectorAll('.breadcrumb a, [data-test-id*="breadcrumb"] a, nav a');for(const e of a){const t=e.getAttribute("href");if(t){const e=t.match(/\/workflow\/([^\/\?]+)/);if(e&&"new"!==e[1]){const t=e[1];if(/^[0-9]+$/.test(t)||t.length>10)return t}}}const i=document.querySelectorAll('[data-test-id*="execution"], .execution-');for(const e of i){const t=(e.textContent||"").match(/workflow[:\s]+([a-zA-Z0-9\-_]+)/i);if(t){const e=t[1];if(/^[0-9]+$/.test(e)||e.length>10)return e}}return null}catch(e){return null}}}(),setTimeout((()=>{window.location.href.includes("n8n.io")&&("function"==typeof showNotificationInPage&&showNotificationInPage("info","🧪 N8N Master v2.10.52 loaded! Press Ctrl+Shift+A to test autopin fix"),setTimeout((()=>{performAutomaticAutopinTest()}),3e3))}),2e3);