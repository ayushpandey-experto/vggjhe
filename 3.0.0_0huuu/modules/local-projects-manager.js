const IndexedDBManager={dbName:"N8NMaster",version:1,db:null,async init(){try{return await UnifiedDatabaseManager.init(),this.db=UnifiedDatabaseManager.db,this.db}catch(e){throw e}},saveProject:async e=>UnifiedDatabaseManager.saveProject(e),getProjects:async()=>UnifiedDatabaseManager.getAllProjects(),deleteProject:async e=>UnifiedDatabaseManager.deleteProject(e),saveWorkflow:async e=>UnifiedDatabaseManager.saveWorkflow(e),getWorkflowsByProject:async e=>UnifiedDatabaseManager.getWorkflowsByProject(e),deleteWorkflow:async e=>UnifiedDatabaseManager.deleteWorkflow(e),getAllWorkflows:async()=>UnifiedDatabaseManager.getAllWorkflows(),async saveWorkflowHistory(e,t){if(!this.db.objectStoreNames.contains("workflowHistory"))throw new Error("workflowHistory object store not found. Database may need upgrade.");const n=this.db.transaction(["workflowHistory"],"readwrite").objectStore("workflowHistory"),o={...t,id:`${e}_${t.timestamp}`,workflowId:e};return n.put(o)},async getWorkflowHistory(e){if(!this.db.objectStoreNames.contains("workflowHistory"))return[];const t=this.db.transaction(["workflowHistory"],"readonly").objectStore("workflowHistory").index("workflowId");return new Promise(((n,o)=>{const r=t.getAll(e);r.onsuccess=()=>{const e=r.result.sort(((e,t)=>t.timestamp-e.timestamp));n(e)},r.onerror=()=>o(r.error)}))},async deleteWorkflowHistory(e){const t=this.db.transaction(["workflowHistory"],"readwrite").objectStore("workflowHistory"),n=t.index("workflowId");return new Promise(((o,r)=>{const a=n.getAll(e);a.onsuccess=()=>{const e=a.result.map((e=>t.delete(e.id)));Promise.all(e).then((()=>o())).catch(r)},a.onerror=()=>r(a.error)}))},async getAllWorkflowHistoryKeys(){if(!this.db.objectStoreNames.contains("workflowHistory"))return[];const e=this.db.transaction(["workflowHistory"],"readonly").objectStore("workflowHistory");return new Promise(((t,n)=>{const o=e.getAll();o.onsuccess=()=>{const e=[...new Set(o.result.map((e=>e.workflowId)))];t(e)},o.onerror=()=>n(o.error)}))},async limitWorkflowHistory(e,t=100){if(!this.db.objectStoreNames.contains("workflowHistory"))return;const n=this.db.transaction(["workflowHistory"],"readwrite").objectStore("workflowHistory"),o=n.index("workflowId");return new Promise(((r,a)=>{const s=o.getAll(e);s.onsuccess=()=>{const e=s.result.sort(((e,t)=>t.timestamp-e.timestamp));if(e.length>t){const o=e.slice(t).map((e=>n.delete(e.id)));Promise.all(o).then((()=>r())).catch(a)}else r()},s.onerror=()=>a(s.error)}))},async saveOutputTemplate(e){const t={...e,id:`template_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:Date.now(),createdAt:(new Date).toISOString()};return UnifiedDatabaseManager.saveOutputTemplate(t)},getAllOutputTemplates:async()=>(await UnifiedDatabaseManager.getAllOutputTemplates()).sort(((e,t)=>t.timestamp-e.timestamp)),getOutputTemplateByName:async e=>UnifiedDatabaseManager.getOutputTemplateByName(e),deleteOutputTemplate:async e=>UnifiedDatabaseManager.deleteOutputTemplate(e),async deleteOutputTemplateByName(e){const t=await this.getOutputTemplateByName(e);return!!t&&this.deleteOutputTemplate(t.id)},async migrateOutputTemplatesFromChromeStorage(){try{if((await this.getAllOutputTemplates()).length>0)return;const e=(await new Promise((e=>{chrome.storage.local.get(["output_cache_global"],(t=>{e(t)}))}))).output_cache_global||{};if(0===Object.keys(e).length)return;let t=0;for(const[n,o]of Object.entries(e))try{const e={name:n,content:o.content||"",timestamp:o.timestamp||Date.now(),createdAt:o.createdAt||(new Date).toISOString()};await this.saveOutputTemplate(e),t++}catch(e){}t>0&&chrome.storage.local.remove(["output_cache_global"],(()=>{}))}catch(e){}}},LocalProjectsManager={config:{storageKey:"localProjectsData",workflowsStorageKey:"localProjectWorkflows",maxProjectNameLength:100,maxWorkflowNameLength:100,maxProjectDisplayLength:17,defaultColors:["#ff4757","#ff6b7a","#ff8a94","#ffa726","#ffcc02","#a4de6c","#52c41a","#13c2c2","#1890ff","#722ed1","#eb2f96","#f5222d"],selectors:{menuContainer:".menu-container",sideMenu:"#side-menu",overviewSection:'[data-test-id="project-home-menu-item"]',collapsedClass:"_menuCollapsed_"}},state:{isInitialized:!1,isMenuCollapsed:!1,projects:[],projectWorkflows:{},draggedWorkflow:null,isDragging:!1,currentEditingProject:null},init:async function(){if(!this.state.isInitialized)try{await IndexedDBManager.init(),this.state.projects||(this.state.projects=[]),this.state.projectWorkflows||(this.state.projectWorkflows={}),await this.migrateFromChromeStorage(),await this.migrateWorkflowHistoryFromChromeStorage(),await IndexedDBManager.migrateOutputTemplatesFromChromeStorage(),await this.loadFromIndexedDB(),await this.createUIWithRetry(),this.createEditModal(),this.setupEventListeners(),this.setupMenuObserver(),this.state.isInitialized=!0}catch(e){}},loadFromIndexedDB:async function(){try{const e=await IndexedDBManager.getProjects();this.state.projects=e||[];const t=await IndexedDBManager.getAllWorkflows();this.state.projectWorkflows={};for(const e of t)this.state.projectWorkflows[e.projectId]||(this.state.projectWorkflows[e.projectId]=[]),this.state.projectWorkflows[e.projectId].push(e)}catch(e){this.state.projects=[],this.state.projectWorkflows={}}},saveToIndexedDB:async function(){try{for(const e of this.state.projects)await IndexedDBManager.saveProject(e);let e=0;for(const[t,n]of Object.entries(this.state.projectWorkflows))for(const o of n){const n={...o,projectId:t};await IndexedDBManager.saveWorkflow(n),e++}}catch(e){}},migrateFromChromeStorage:async function(){try{const e=await IndexedDBManager.getProjects();if(e&&e.length>0)return;const t=await chrome.storage.local.get([this.config.storageKey,this.config.workflowsStorageKey]),n=t[this.config.storageKey],o=t[this.config.workflowsStorageKey];if(!n||!Array.isArray(n)||0===n.length)return;let r=0;for(const e of n)try{const t={id:e.id||`migrated_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:e.name||"Unnamed Project",color:e.color||this.config.defaultColors[0],expanded:void 0===e.expanded||e.expanded,createdAt:e.createdAt||Date.now()};await IndexedDBManager.saveProject(t),r++}catch(e){}let a=0;if(o&&"object"==typeof o)for(const[e,t]of Object.entries(o))if(Array.isArray(t))for(const n of t)try{const t={id:n.id||`migrated_wf_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:n.name||"Unnamed Workflow",url:n.url||`${window.location.origin}/workflow/${n.id}`,projectId:e};await IndexedDBManager.saveWorkflow(t),a++}catch(e){}if(r>0||a>0)try{await chrome.storage.local.remove([this.config.storageKey,this.config.workflowsStorageKey])}catch(e){}}catch(e){}},migrateWorkflowHistoryFromChromeStorage:async function(){try{const e=await chrome.storage.local.get(null),t=Object.keys(e).filter((e=>e.startsWith("workflow_history_")));if(0===t.length)return;let n=0,o=0;for(const r of t)try{const t=r.replace("workflow_history_",""),a=e[r];if(!Array.isArray(a)||0===a.length)continue;for(const e of a)try{const o={timestamp:e.timestamp||Date.now(),workflow:e.workflow||{},nodeCount:e.nodeCount||0,source:e.source||"migrated",id:e.id||e.timestamp?.toString()||Date.now().toString()};await IndexedDBManager.saveWorkflowHistory(t,o),n++}catch(e){if(e.message&&e.message.includes("object store not found"))break}if(n>0)try{await IndexedDBManager.limitWorkflowHistory(t,100),o++}catch(e){o++}}catch(e){}if(n>0)try{await chrome.storage.local.remove(t)}catch(e){}}catch(e){}},findStableMenuContainer:function(){const e=[()=>document.querySelector(".menu-container"),()=>document.querySelector("#side-menu"),()=>document.querySelector(".side-menu"),()=>{const e=document.querySelector('[data-test-id="project-home-menu-item"]');if(e){let t=e.parentElement,n=0;for(;t&&t!==document.body&&n<10;){const e=t.classList.toString().toLowerCase(),o=t.id.toLowerCase();if(e.includes("menu")&&!e.includes("item")||o.includes("side")||o.includes("menu"))return t;t=t.parentElement,n++}}return null},()=>{const e=document.querySelectorAll('[class*="menu"], [id*="menu"], [id*="side"]');for(const t of e)if("n8n-app"!==t.id&&(t.querySelector('[data-test-id*="menu-item"]')||t.querySelector(".el-menu-item")))return t;return null}];for(let t=0;t<e.length;t++)try{const n=e[t]();if(n)return n}catch(e){}return null},findOverviewSection:function(){const e=[()=>document.querySelector('[data-test-id="project-home-menu-item"]'),()=>document.querySelector('li[id="home"]'),()=>document.querySelector('[id="home"]'),()=>{const e=document.querySelectorAll('.el-menu-item, [class*="menu-item"]');for(const t of e)if(t.textContent&&t.textContent.toLowerCase().includes("overview"))return t;return null},()=>document.querySelector('[data-test-id*="home"]')];for(let t=0;t<e.length;t++)try{const n=e[t]();if(n)return n}catch(e){}return null},createUIWithRetry:async function(){for(let e=1;e<=5;e++){if(this.createUI())return!0;e<5&&await new Promise((e=>setTimeout(e,1e3)))}return!1},createUI:function(){if(!this.findStableMenuContainer())return!1;const e=this.findOverviewSection();if(!e)return!1;const t=document.createElement("div");t.id="local-projects-container",t.style.cssText="\n      margin-top: 12px;\n      padding: 8px 0;\n      border-top: 1px solid #333;\n    ";const n=document.createElement("div");n.id="projects-list";const o=document.createElement("button");o.id="add-project-btn",o.innerHTML=window.I18nManager?window.I18nManager.getMessage("newProjectButton"):"📁 + Add project",o.style.cssText="\n      width: 100%;\n      padding: 8px 12px;\n      background: #2a2a2a;\n      border: 1px solid #444;\n      border-radius: 6px;\n      color: #ccc;\n      font-size: 12px;\n      cursor: pointer;\n      display: flex;\n      align-items: center;\n      gap: 6px;\n      transition: all 0.2s ease;\n    ",o.addEventListener("mouseover",(()=>{o.style.background="#333",o.style.borderColor="#555"})),o.addEventListener("mouseout",(()=>{o.style.background="#2a2a2a",o.style.borderColor="#444"})),o.addEventListener("click",(()=>{this.showAddProjectForm()}));const r=document.createElement("div");return r.id="workflow-delete-zone",r.innerHTML=window.I18nManager?window.I18nManager.getMessage("deleteZone"):"🗑️ Delete",r.style.cssText="\n      display: none;\n      margin-top: 8px;\n      padding: 8px 12px;\n      background: #dc3545;\n      border: 2px dashed #fff;\n      border-radius: 6px;\n      color: #fff;\n      font-size: 12px;\n      text-align: center;\n      font-weight: 600;\n      transition: all 0.2s ease;\n    ",t.appendChild(n),t.appendChild(o),t.appendChild(r),e.parentNode.insertBefore(t,e.nextSibling),this.renderProjects(),!0},renderProjects:function(){const e=document.getElementById("projects-list");if(!e)return;const t=document.getElementById("local-projects-container");t&&"none"===t.style.display||(e.innerHTML="",Array.isArray(this.state.projects)?this.state.projects.forEach((t=>{this.state.projectWorkflows[t.id];const n=this.createProjectElement(t);e.appendChild(n)})):this.state.projects=[])},createProjectElement:function(e){const t=document.createElement("div");t.className="local-project",t.dataset.projectId=e.id,t.style.cssText="\n      margin-bottom: 4px;\n    ";const n=document.createElement("div");n.className="project-header",n.style.cssText="\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      padding: 6px 8px;\n      background: #2a2a2a;\n      border-radius: 4px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n    ";const o=document.createElement("span");o.className="project-color-icon",o.innerHTML=e.expanded?"📂":"📁",o.style.cssText=`\n      font-size: 14px;\n      cursor: pointer;\n      filter: hue-rotate(${this.getHueRotationForColor(e.color)}deg);\n    `;const r=document.createElement("span");r.className="project-name";const a=e.name.length>this.config.maxProjectDisplayLength?e.name.substring(0,this.config.maxProjectDisplayLength)+"...":e.name;r.textContent=a,r.title=e.name,r.dataset.projectId=e.id,r.style.cssText="\n      flex: 1;\n      color: #ccc;\n      font-size: 12px;\n      font-weight: 500;\n      cursor: pointer;\n      user-select: none;\n    ";const s=this.state.projectWorkflows[e.id]?.length||0,i=document.createElement("span");i.className="workflows-count",i.textContent=s.toString(),i.style.cssText=`\n      background: ${e.color};\n      color: #fff;\n      font-size: 10px;\n      font-weight: 600;\n      padding: 2px 6px;\n      border-radius: 10px;\n      min-width: 16px;\n      text-align: center;\n    `,n.appendChild(o),n.appendChild(r),n.appendChild(i);const d=document.createElement("div");return d.className="project-workflows",d.style.cssText=`\n      display: ${e.expanded?"block":"none"};\n      margin-left: 16px;\n      margin-top: 4px;\n    `,e.expanded&&this.renderProjectWorkflows(d,e.id),t.appendChild(n),t.appendChild(d),n.addEventListener("click",(t=>{t.target===o?this.showColorPicker(e):t.target===r&&r.querySelector("input")||this.toggleProject(e.id)})),r.addEventListener("dblclick",(t=>{t.stopPropagation(),this.openEditModal(e.id)})),n.addEventListener("mouseover",(()=>{n.style.background="#333"})),n.addEventListener("mouseout",(()=>{n.style.background="#2a2a2a"})),t},renderProjectWorkflows:function(e,t){e.innerHTML="";(this.state.projectWorkflows[t]||[]).forEach((n=>{const o=this.createWorkflowElement(n,t);e.appendChild(o)}));const n=document.createElement("div");n.className="add-workflow-btn",n.innerHTML=window.I18nManager?window.I18nManager.getMessage("addWorkflow"):"+ Add",n.style.cssText="\n      padding: 4px 8px;\n      color: #888;\n      font-size: 11px;\n      cursor: pointer;\n      border-radius: 3px;\n      transition: all 0.2s ease;\n    ",n.addEventListener("click",(()=>{this.showWorkflowSelector(t)})),n.addEventListener("mouseover",(()=>{n.style.background="#333",n.style.color="#ccc"})),n.addEventListener("mouseout",(()=>{n.style.background="transparent",n.style.color="#888"})),e.appendChild(n)},createWorkflowElement:function(e,t){const n=document.createElement("div");n.className="project-workflow",n.dataset.workflowId=e.id,n.dataset.projectId=t,n.draggable=!0;const o=this.getCurrentWorkflowId(),r=o&&o===e.id,a=e.name.length>this.config.maxWorkflowNameLength?e.name.substring(0,this.config.maxWorkflowNameLength)+"...":e.name;if(r){n.innerHTML=`<b>${a}</b>`;const t=window.I18nManager?window.I18nManager.getMessage("currentlyOpen"):"(currently open)";n.title=`${e.name} ${t}`}else n.innerHTML=a,n.title=e.name;const s=this.state.projects.find((e=>e.id===t))?.color||"#666",i=r?"#2d4a2d":"#1e1e1e",d=r?"#90ee90":"#aaa";return n.style.cssText=`\n      padding: 4px 8px;\n      margin-bottom: 2px;\n      background: ${i};\n      border-radius: 3px;\n      color: ${d};\n      font-size: 11px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      border-left: 3px solid ${s};\n    `,n.addEventListener("click",(()=>{this.openWorkflow(e)})),n.addEventListener("mouseover",(()=>{n.style.background=r?"#3d5a3d":"#333",n.style.color="#fff"})),n.addEventListener("mouseout",(()=>{n.style.background=i,n.style.color=d})),n.addEventListener("dragstart",(o=>{this.state.draggedWorkflow={workflow:e,fromProjectId:t},this.state.isDragging=!0,this.showDeleteZone(),n.style.opacity="0.5"})),n.addEventListener("dragend",(()=>{setTimeout((()=>{this.state.draggedWorkflow=null,this.state.isDragging=!1,this.hideDeleteZone(),n.style.opacity="1"}),100)})),n},setupEventListeners:function(){const e=document.getElementById("workflow-delete-zone");e&&(e.addEventListener("dragover",(t=>{t.preventDefault(),e.style.background="#dc3545",e.style.transform="scale(1.02)"})),e.addEventListener("dragleave",(()=>{e.style.background="#dc3545",e.style.transform="scale(1)"})),e.addEventListener("drop",(async t=>{t.preventDefault(),this.state.draggedWorkflow&&await this.removeWorkflowFromProject(this.state.draggedWorkflow.fromProjectId,this.state.draggedWorkflow.workflow.id),e.style.transform="scale(1)",e.style.background="#dc3545"}))),document.addEventListener("dragover",(e=>{if(!this.state.isDragging)return;const t=e.target.closest(".project-header");t&&this.state.draggedWorkflow&&(e.preventDefault(),t.style.background="#444")})),document.addEventListener("drop",(e=>{if(!this.state.isDragging)return;const t=e.target.closest(".project-header");if(t&&this.state.draggedWorkflow){e.preventDefault();const n=t.closest(".local-project"),o=n?.dataset.projectId;o&&o!==this.state.draggedWorkflow.fromProjectId&&this.moveWorkflowToProject(this.state.draggedWorkflow.workflow,this.state.draggedWorkflow.fromProjectId,o),t.style.background="#2a2a2a"}})),document.addEventListener("dragleave",(e=>{const t=e.target.closest(".project-header");t&&(t.style.background="#2a2a2a")}))},showAddProjectForm:function(){const e=document.getElementById("add-project-btn");if(!e)return;if(document.getElementById("add-project-form"))return;const t=document.createElement("div");t.id="add-project-form",t.style.cssText="\n      margin-top: 8px;\n      padding: 8px;\n      background: #333;\n      border-radius: 6px;\n      border: 1px solid #555;\n    ";const n=document.createElement("input");n.type="text",n.placeholder=window.I18nManager?window.I18nManager.getMessage("projectNamePlaceholder"):"Project name...",n.maxLength=this.config.maxProjectNameLength,n.style.cssText="\n      width: 100%;\n      padding: 6px 8px;\n      background: #2a2a2a;\n      border: 1px solid #444;\n      border-radius: 4px;\n      color: #fff;\n      font-size: 12px;\n      margin-bottom: 8px;\n      box-sizing: border-box;\n    ";const o=document.createElement("div");o.style.cssText="\n      display: flex;\n      gap: 6px;\n    ";const r=document.createElement("button");r.textContent=window.I18nManager?window.I18nManager.getMessage("save"):"Save",r.style.cssText="\n      flex: 1;\n      padding: 4px 8px;\n      background: #28a745;\n      border: none;\n      border-radius: 4px;\n      color: #fff;\n      font-size: 11px;\n      cursor: pointer;\n    ";const a=document.createElement("button");a.textContent=window.I18nManager?window.I18nManager.getMessage("cancel"):"Cancel",a.style.cssText="\n      flex: 1;\n      padding: 4px 8px;\n      background: #6c757d;\n      border: none;\n      border-radius: 4px;\n      color: #fff;\n      font-size: 11px;\n      cursor: pointer;\n    ",o.appendChild(r),o.appendChild(a),t.appendChild(n),t.appendChild(o),e.parentNode.insertBefore(t,e.nextSibling),e.style.display="none",n.focus(),r.addEventListener("click",(()=>{const e=n.value.trim();e&&this.createProject(e),this.hideAddProjectForm()})),a.addEventListener("click",(()=>{this.hideAddProjectForm()})),n.addEventListener("keydown",(e=>{if("Enter"===e.key){const e=n.value.trim();e&&this.createProject(e),this.hideAddProjectForm()}else"Escape"===e.key&&this.hideAddProjectForm()}))},hideAddProjectForm:function(){const e=document.getElementById("add-project-form"),t=document.getElementById("add-project-btn");e&&e.remove(),t&&(t.style.display="flex")},createProject:function(e){const t={id:this.generateId(),name:e,color:this.config.defaultColors[Math.floor(Math.random()*this.config.defaultColors.length)],expanded:!1,createdAt:Date.now()};this.state.projects.push(t),this.state.projectWorkflows[t.id]=[],this.saveToIndexedDB(),this.renderProjects()},createEditModal:function(){const e=document.getElementById("project-name-modal");e&&e.remove();const t=document.createElement("div");t.id="project-name-modal",t.style.cssText="\n      display: none;\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: rgba(0, 0, 0, 0.5);\n      z-index: 10000;\n      justify-content: center;\n      align-items: center;\n    ";const n=document.createElement("div");n.style.cssText="\n      background: rgb(42, 42, 42);\n      border-radius: 8px;\n      padding: 24px;\n      box-shadow: rgba(0, 0, 0, 0.5) 0px 4px 20px;\n      min-width: 400px;\n      max-width: 500px;\n      border: 1px solid rgb(68, 68, 68);\n    ",n.innerHTML=`\n      <h3 style="margin: 0px 0px 16px; color: rgb(255, 255, 255); font-size: 18px;">${window.I18nManager?window.I18nManager.getMessage("editProjectName"):"Edit Project Name"}</h3>\n      <input type="text" id="project-name-input" placeholder="${window.I18nManager?window.I18nManager.getMessage("enterProjectName"):"Enter project name"}" style="\n        width: 100%;\n        padding: 12px;\n        border: 1px solid rgb(85, 85, 85);\n        border-radius: 4px;\n        font-size: 14px;\n        margin-bottom: 16px;\n        box-sizing: border-box;\n        background: rgb(51, 51, 51);\n        color: rgb(255, 255, 255);\n      " maxlength="100">\n      <div style="display: flex; gap: 12px; justify-content: space-between; align-items: center;">\n        <button id="modal-delete-btn" style="\n          padding: 8px 12px;\n          border: 1px solid rgb(220, 53, 69);\n          border-radius: 4px;\n          background: rgb(220, 53, 69);\n          color: white;\n          cursor: pointer;\n          font-size: 14px;\n          display: flex;\n          align-items: center;\n          gap: 6px;\n        ">❌ ${window.I18nManager?window.I18nManager.getMessage("delete"):"Delete"}</button>\n        <div style="display: flex; gap: 12px;">\n          <button id="modal-cancel-btn" style="\n            padding: 8px 16px;\n            border: 1px solid rgb(85, 85, 85);\n            border-radius: 4px;\n            background: rgb(68, 68, 68);\n            color: rgb(204, 204, 204);\n            cursor: pointer;\n            font-size: 14px;\n          ">${window.I18nManager?window.I18nManager.getMessage("cancel"):"Cancel"}</button>\n          <button id="modal-save-btn" style="\n            padding: 8px 16px;\n            border: 1px solid rgb(0, 122, 204);\n            border-radius: 4px;\n            background: rgb(0, 122, 204);\n            color: white;\n          cursor: pointer;\n          font-size: 14px;\n        ">${window.I18nManager?window.I18nManager.getMessage("save"):"Save"}</button>\n        </div>\n      </div>\n    `,t.appendChild(n),document.body.appendChild(t);const o=t.querySelector("#project-name-input"),r=t.querySelector("#modal-cancel-btn"),a=t.querySelector("#modal-save-btn"),s=t.querySelector("#modal-delete-btn");t.addEventListener("click",(e=>{e.target===t&&this.closeEditModal()})),r.addEventListener("click",(()=>{this.closeEditModal()})),a.addEventListener("click",(()=>{this.saveProjectNameFromModal()})),s.addEventListener("click",(()=>{this.deleteProjectFromModal()})),o.addEventListener("keydown",(e=>{"Enter"===e.key?(e.preventDefault(),this.saveProjectNameFromModal()):"Escape"===e.key&&(e.preventDefault(),this.closeEditModal())}))},openEditModal:function(e){const t=document.getElementById("project-name-modal"),n=t.querySelector("#project-name-input"),o=this.state.projects.find((t=>t.id===e));o&&(this.state.currentEditingProject=e,n.value=o.name,t.style.display="flex",setTimeout((()=>{n.focus(),n.select()}),100))},closeEditModal:function(){document.getElementById("project-name-modal").style.display="none",this.state.currentEditingProject=null},saveProjectNameFromModal:async function(){const e=document.getElementById("project-name-modal").querySelector("#project-name-input"),t=e.value.trim();if(!t)return alert(window.I18nManager?window.I18nManager.getMessage("projectNameCannotBeEmpty"):"Project name cannot be empty"),void e.focus();if(this.state.projects.find((e=>e.id!==this.state.currentEditingProject&&e.name.toLowerCase()===t.toLowerCase())))return alert(window.I18nManager?window.I18nManager.getMessage("projectNameAlreadyExists"):"A project with this name already exists"),e.focus(),void e.select();try{const e=this.state.projects.find((e=>e.id===this.state.currentEditingProject));e.name;e.name=t,await IndexedDBManager.saveProject(e),this.closeEditModal(),this.renderProjects()}catch(e){alert(window.I18nManager?window.I18nManager.getMessage("errorSavingProjectName"):"Error saving project name")}},deleteProjectFromModal:async function(){const e=this.state.projects.find((e=>e.id===this.state.currentEditingProject));if(!e)return;const t=window.I18nManager?window.I18nManager.getMessage("confirmDeleteProject").replace("{projectName}",e.name):`Are you sure you want to delete project "${e.name}"? This action cannot be undone.`;if(confirm(t))try{await this.deleteProject(e.id),this.closeEditModal()}catch(e){alert(window.I18nManager?window.I18nManager.getMessage("errorDeletingProject"):"Error deleting project")}},deleteProject:async function(e){if(!this.state.projects.find((t=>t.id===e)))throw new Error("Project not found");const t=this.state.projectWorkflows[e]||[];try{for(const e of t)await IndexedDBManager.deleteWorkflowHistory(e.id),await IndexedDBManager.deleteWorkflow(e.id);await IndexedDBManager.deleteProject(e),this.state.projects=this.state.projects.filter((t=>t.id!==e)),delete this.state.projectWorkflows[e],this.renderProjects()}catch(e){throw e}},toggleProject:function(e){const t=this.state.projects.find((t=>t.id===e));t&&(t.expanded=!t.expanded,this.saveToIndexedDB(),this.renderProjects())},generateId:function(){return"proj_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)},getHueRotationForColor:function(e){return{"#ff4757":0,"#ff6b7a":15,"#ff8a94":30,"#ffa726":45,"#ffcc02":60,"#a4de6c":120,"#52c41a":140,"#13c2c2":180,"#1890ff":220,"#722ed1":270,"#eb2f96":320,"#f5222d":350}[e]||0},show:function(){const e=document.getElementById("local-projects-container");if(e){if(e.style.display="block",!this.state?.isInitialized)return void this.init().then((()=>{this.renderProjects()})).catch((e=>{}));this.renderProjects()}},hide:function(){const e=document.getElementById("local-projects-container");e&&(e.style.display="none")},removeUI:function(){const e=document.getElementById("local-projects-container");e&&e.remove()},reinitializeUI:async function(){this.removeUI(),this.state.isInitialized=!1,await this.init()},setupMenuObserver:function(){const e=document.querySelector(this.config.selectors.menuContainer);if(!e)return;this.checkMenuCollapse(e);new MutationObserver((e=>{e.forEach((e=>{"attributes"===e.type&&"class"===e.attributeName&&this.checkMenuCollapse(e.target)}))})).observe(e,{attributes:!0,attributeFilter:["class"]})},checkMenuCollapse:function(e){const t=e.className||"",n=t.includes("menuCollapsed")||t.includes("Collapsed")||t.includes("collapsed");n!==this.state.isMenuCollapsed&&(this.state.isMenuCollapsed=n,n?this.hide():this.show())},showDeleteZone:function(){const e=document.getElementById("workflow-delete-zone");e&&(e.style.display="block")},hideDeleteZone:function(){const e=document.getElementById("workflow-delete-zone");e&&(e.style.display="none")},showColorPicker:function(e){const t=document.createElement("div");t.id="color-picker-modal",t.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: rgba(0,0,0,0.7);\n      z-index: 10000;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    ";const n=document.createElement("div");n.style.cssText="\n      background: #2a2a2a;\n      border: 1px solid #444;\n      border-radius: 8px;\n      padding: 20px;\n      min-width: 300px;\n      max-width: 400px;\n    ";const o=document.createElement("h3"),r=window.I18nManager?window.I18nManager.getMessage("chooseColorFor"):"Choose color for";o.textContent=`${r} "${e.name}"`,o.style.cssText="\n      color: #fff;\n      margin: 0 0 16px 0;\n      font-size: 16px;\n      font-weight: 600;\n    ";const a=document.createElement("div");a.style.cssText="\n      display: grid;\n      grid-template-columns: repeat(4, 1fr);\n      gap: 8px;\n      margin-bottom: 16px;\n    ",this.config.defaultColors.forEach((n=>{const o=document.createElement("button");o.style.cssText=`\n        width: 40px;\n        height: 40px;\n        background: ${n};\n        border: 2px solid ${e.color===n?"#fff":"#555"};\n        border-radius: 6px;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        position: relative;\n      `,e.color===n&&(o.innerHTML="✓",o.style.color="#fff",o.style.fontSize="18px",o.style.fontWeight="bold"),o.addEventListener("click",(()=>{this.updateProjectColor(e.id,n),t.remove()})),o.addEventListener("mouseover",(()=>{o.style.transform="scale(1.1)",o.style.boxShadow="0 4px 12px rgba(0,0,0,0.3)"})),o.addEventListener("mouseout",(()=>{o.style.transform="scale(1)",o.style.boxShadow="none"})),a.appendChild(o)}));const s=document.createElement("button");s.textContent=window.I18nManager?window.I18nManager.getMessage("cancel"):"Cancel",s.style.cssText="\n      width: 100%;\n      padding: 8px 16px;\n      background: #444;\n      border: 1px solid #666;\n      border-radius: 4px;\n      color: #fff;\n      cursor: pointer;\n      font-size: 14px;\n    ",s.addEventListener("click",(()=>{t.remove()})),n.appendChild(o),n.appendChild(a),n.appendChild(s),t.appendChild(n),t.addEventListener("click",(e=>{e.target===t&&t.remove()})),document.body.appendChild(t)},updateProjectColor:function(e,t){const n=this.state.projects.find((t=>t.id===e));n&&(n.color=t,this.saveToIndexedDB(),this.renderProjects())},showWorkflowSelector:async function(e){const t=await chrome.storage.local.get(["n8nApiKey"]);if(!t.n8nApiKey){const e=window.I18nManager?window.I18nManager.getMessage("n8nApiKeyNotConfigured"):"N8N API key not configured. Please configure it in the extension settings to import workflows from your N8N instance.\n\nYou can still create projects and manage them manually.";alert(e)}const n=document.createElement("div");n.id="workflow-selector-modal",n.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: rgba(0,0,0,0.7);\n      z-index: 10000;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    ";const o=document.createElement("div");o.style.cssText="\n      background: #2a2a2a;\n      border: 1px solid #444;\n      border-radius: 8px;\n      padding: 20px;\n      width: 500px;\n      max-width: 90vw;\n      max-height: 80vh;\n      display: flex;\n      flex-direction: column;\n    ";const r=document.createElement("h3");r.textContent=window.I18nManager?window.I18nManager.getMessage("selectWorkflowsToAdd"):"Select Workflows to Add",r.style.cssText="\n      color: #fff;\n      margin: 0 0 16px 0;\n      font-size: 16px;\n      font-weight: 600;\n    ";const a=document.createElement("div"),s=window.I18nManager?window.I18nManager.getMessage("addedWorkflows"):"Added:",i=window.I18nManager?window.I18nManager.getMessage("workflows"):"workflows";a.textContent=`${s} 0 ${i}`,a.style.cssText="\n      color: #28a745;\n      font-size: 14px;\n      margin-bottom: 16px;\n      font-weight: 500;\n    ";const d=document.createElement("input");d.type="text",d.placeholder=window.I18nManager?window.I18nManager.getMessage("searchWorkflows"):"Search workflows...",d.style.cssText="\n      width: 100%;\n      padding: 8px 12px;\n      background: #1e1e1e;\n      border: 1px solid #444;\n      border-radius: 4px;\n      color: #fff;\n      font-size: 14px;\n      margin-bottom: 16px;\n      box-sizing: border-box;\n    ";const c=document.createElement("div");c.textContent=window.I18nManager?window.I18nManager.getMessage("loadingWorkflows"):"Loading workflows...",c.style.cssText="\n      color: #888;\n      text-align: center;\n      padding: 20px;\n      font-style: italic;\n    ";const l=document.createElement("div");l.style.cssText="\n      flex: 1;\n      overflow-y: auto;\n      border: 1px solid #444;\n      border-radius: 4px;\n      background: #1e1e1e;\n      margin-bottom: 16px;\n      max-height: 300px;\n    ";const g=document.createElement("button");g.textContent=window.I18nManager?window.I18nManager.getMessage("done"):"Done",g.style.cssText="\n      padding: 8px 16px;\n      background: #007acc;\n      border: 1px solid #007acc;\n      border-radius: 4px;\n      color: #fff;\n      cursor: pointer;\n      font-size: 14px;\n    ",g.addEventListener("click",(()=>{n.remove()})),o.appendChild(r),o.appendChild(a),o.appendChild(d),o.appendChild(c),o.appendChild(l),o.appendChild(g),n.appendChild(o),n.addEventListener("click",(e=>{e.target===n&&n.remove()})),document.body.appendChild(n);try{if(await this.loadFromIndexedDB(),c.remove(),!t.n8nApiKey){const e=window.I18nManager?window.I18nManager.getMessage("noApiKeyForImport"):"To import workflows from your N8N instance, please configure your N8N API key in the extension settings.\n\nYou can still create and manage projects manually.";return void(l.innerHTML=`\n          <div style="padding: 20px; text-align: center; color: #ffa726;">\n            <div style="font-size: 24px; margin-bottom: 12px;">🔑</div>\n            <div style="margin-bottom: 12px; font-weight: 500;">API Key Required for Import</div>\n            <div style="font-size: 12px; line-height: 1.4;">${e}</div>\n          </div>\n        `)}const n=(await this.loadWorkflowsFromAPI(t.n8nApiKey)).filter((e=>!this.isWorkflowInAnyProject(e.id)));if(0===n.length){const e=window.I18nManager?window.I18nManager.getMessage("noAvailableWorkflows"):"No available workflows found. All workflows are already in projects.";return void(l.innerHTML=`\n          <div style="padding: 20px; text-align: center; color: #888;">\n            ${e}\n          </div>\n        `)}this.renderWorkflowsList(l,n,e,d,a)}catch(e){c.textContent=window.I18nManager?window.I18nManager.getMessage("failedToLoadWorkflows"):"Failed to load workflows. Please check your API key.",c.style.color="#ff6b6b"}},loadWorkflowsFromAPI:async function(e){const t=`${window.location.origin}/api/v1/workflows`,n=await fetch(t,{method:"GET",headers:{"X-N8N-API-KEY":e,"Content-Type":"application/json"}});if(!n.ok)throw new Error(`API request failed: ${n.status} ${n.statusText}`);const o=await n.json();return o.data||o},isWorkflowInAnyProject:function(e){for(const t in this.state.projectWorkflows){if(this.state.projectWorkflows[t].some((t=>t.id===e)))return!0}return!1},getCurrentWorkflowId:function(){const e=window.location.href.match(/\/workflow\/([^\/\?#]+)/);return e?e[1]:null},renderWorkflowsList:function(e,t,n,o,r){let a=0;const s=(i="")=>{const d=t.filter((e=>e.name.toLowerCase().includes(i.toLowerCase())));if(e.innerHTML="",0!==d.length)d.forEach((i=>{const d=document.createElement("div");d.style.cssText="\n          padding: 12px 16px;\n          border-bottom: 1px solid #333;\n          cursor: pointer;\n          transition: background 0.2s ease;\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n        ";const c=document.createElement("div");c.style.cssText="\n          flex: 1;\n        ";const l=document.createElement("div");l.textContent=i.name,l.style.cssText="\n          color: #fff;\n          font-weight: 500;\n          margin-bottom: 4px;\n        ";const g=document.createElement("div");g.textContent=`ID: ${i.id}`,g.style.cssText="\n          color: #888;\n          font-size: 12px;\n        ";const f=document.createElement("button");f.textContent=window.I18nManager?window.I18nManager.getMessage("add"):"Add",f.style.cssText="\n          padding: 4px 12px;\n          background: #28a745;\n          border: none;\n          border-radius: 4px;\n          color: #fff;\n          font-size: 12px;\n          cursor: pointer;\n        ",f.addEventListener("click",(e=>{e.stopPropagation(),this.addWorkflowToProject(n,i);const d=t.findIndex((e=>e.id===i.id));-1!==d&&t.splice(d,1),a++;const c=window.I18nManager?window.I18nManager.getMessage("addedWorkflows"):"Added:",l=1===a?window.I18nManager?window.I18nManager.getMessage("workflow"):"workflow":window.I18nManager?window.I18nManager.getMessage("workflows"):"workflows";r.textContent=`${c} ${a} ${l}`,s(o.value);const g=document.createElement("div"),f=window.I18nManager?window.I18nManager.getMessage("workflowAddedToProject"):"added to project";g.textContent=`✅ "${i.name}" ${f}`,g.style.cssText="\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            background: #28a745;\n            color: white;\n            padding: 8px 16px;\n            border-radius: 4px;\n            z-index: 10001;\n            font-size: 14px;\n          ",document.body.appendChild(g),setTimeout((()=>{g.parentNode&&g.remove()}),2e3)})),c.appendChild(l),c.appendChild(g),d.appendChild(c),d.appendChild(f),d.addEventListener("mouseover",(()=>{d.style.background="#333"})),d.addEventListener("mouseout",(()=>{d.style.background="transparent"})),e.appendChild(d)}));else{const t=window.I18nManager?window.I18nManager.getMessage("noWorkflowsMatchSearch"):"No workflows match your search.";e.innerHTML=`\n          <div style="padding: 20px; text-align: center; color: #888;">\n            ${t}\n          </div>\n        `}};s(),o.addEventListener("input",(e=>{s(e.target.value)}))},addWorkflowToProject:function(e,t){this.state.projectWorkflows[e]||(this.state.projectWorkflows[e]=[]);if(this.state.projectWorkflows[e].find((e=>e.id===t.id)))return void alert(window.I18nManager?window.I18nManager.getMessage("workflowAlreadyExists"):"Workflow already exists in this project.");const n={id:t.id,name:t.name,url:`${window.location.origin}/workflow/${t.id}`};this.state.projectWorkflows[e].push(n),this.saveToIndexedDB(),this.renderProjects()},openWorkflow:function(e){window.location.href=e.url},moveWorkflowToProject:function(e,t,n){t!==n&&(this.state.projectWorkflows[t]&&(this.state.projectWorkflows[t]=this.state.projectWorkflows[t].filter((t=>t.id!==e.id))),this.state.projectWorkflows[n]||(this.state.projectWorkflows[n]=[]),this.state.projectWorkflows[n].push(e),this.saveToIndexedDB(),this.renderProjects())},removeWorkflowFromProject:async function(e,t){if(this.state.projectWorkflows[e]){this.state.projectWorkflows[e].find((e=>e.id===t)),this.state.projectWorkflows[e].length;this.state.projectWorkflows[e]=this.state.projectWorkflows[e].filter((e=>e.id!==t));this.state.projectWorkflows[e].length;try{await IndexedDBManager.deleteWorkflow(t)}catch(e){}this.saveToIndexedDB(),setTimeout((()=>{this.renderProjects()}),50)}},updateLocalization:function(){const e=document.getElementById("add-project-btn");e&&(e.innerHTML=window.I18nManager?window.I18nManager.getMessage("newProjectButton"):"📁 + Add project");const t=document.getElementById("workflow-delete-zone");t&&(t.innerHTML=window.I18nManager?window.I18nManager.getMessage("deleteZone"):"🗑️ Delete");document.querySelectorAll(".add-workflow-btn").forEach((e=>{e.innerHTML=window.I18nManager?window.I18nManager.getMessage("addWorkflow"):"+ Add"}))}};LocalProjectsManager.debug={createTestProject:function(){LocalProjectsManager.createProject("Test Project")},createProjectWithWorkflows:function(){const e={id:"test_"+Date.now(),name:"Demo Project",color:"#ff4757",expanded:!0,createdAt:Date.now()};LocalProjectsManager.state.projects.push(e),LocalProjectsManager.state.projectWorkflows[e.id]=[{id:"workflow_1",name:"Demo Workflow 1",url:"/workflow/workflow_1"},{id:"workflow_2",name:"Demo Workflow 2 with Very Long Name That Should Be Truncated",url:"/workflow/workflow_2"}],LocalProjectsManager.saveToIndexedDB(),LocalProjectsManager.renderProjects()},clearAllProjects:function(){LocalProjectsManager.state.projects=[],LocalProjectsManager.state.projectWorkflows={},LocalProjectsManager.saveToIndexedDB(),LocalProjectsManager.renderProjects()},showState:function(){},migrateFromChromeStorage:async function(){await LocalProjectsManager.migrateFromChromeStorage(),await LocalProjectsManager.loadFromIndexedDB(),LocalProjectsManager.renderProjects()},checkChromeStorageData:async function(){try{return await chrome.storage.local.get([LocalProjectsManager.config.storageKey,LocalProjectsManager.config.workflowsStorageKey])}catch(e){}},checkWorkflowHistoryInChromeStorage:async function(){try{const e=await chrome.storage.local.get(null),t=Object.keys(e).filter((e=>e.startsWith("workflow_history_")));for(const n of t){n.replace("workflow_history_",""),e[n]}return{historyKeys:t,totalWorkflows:t.length}}catch(e){}},checkWorkflowHistoryInIndexedDB:async function(){try{const e=await IndexedDBManager.getAllWorkflowHistoryKeys();for(const t of e){await IndexedDBManager.getWorkflowHistory(t)}return{workflowIds:e,totalWorkflows:e.length}}catch(e){}},migrateWorkflowHistory:async function(){await LocalProjectsManager.migrateWorkflowHistoryFromChromeStorage()},testLocalization:function(){if(!window.I18nManager)return{success:!1,error:"I18nManager not available"};const e=window.I18nManager.getCurrentLanguage(),t=["newProjectButton","addWorkflow","save","cancel","projectNamePlaceholder","loadingWorkflows","searchWorkflows","workflowAddedToProject","chooseColorFor","done"],n={};let o=0;t.forEach((e=>{const t=window.I18nManager.getMessage(e);n[e]=t,t&&t!==e&&o++}));const r={addProjectBtn:document.getElementById("add-project-btn"),deleteZone:document.getElementById("workflow-delete-zone"),addWorkflowBtns:document.querySelectorAll(".add-workflow-btn").length};return{success:!0,language:e,translationsFound:o,totalKeys:t.length,translations:n,uiElements:r,timestamp:(new Date).toISOString()}}},"undefined"!=typeof window&&(window.LocalProjectsManager=LocalProjectsManager,window.IndexedDBManager=IndexedDBManager,window.testLocalProjectsLocalization=function(){return LocalProjectsManager.debug.testLocalization()});