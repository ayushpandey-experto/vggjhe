const LocalVariablesManager={config:{dbName:"N8NMaster",dbVersion:1,storeName:"variables"},db:null,isEnabled:!1,originalVariablesLink:null,variablesBlock:null,monitoringInterval:null,sidebarObserver:null,processedLink:null,clickHandler:null,replacedIcon:null,variablesCount:0,edgeCompatibility:{lastProcessedLinkHref:null,linkStateCache:new Map,observerRetryCount:0,maxRetryCount:5,stateCheckInterval:null,isEdgeBrowser:!1},async init(){this.edgeCompatibility.isEdgeBrowser=this.detectEdgeBrowser(),this.edgeCompatibility.isEdgeBrowser;try{await this.initDatabase(),await this.loadSettings(),await this.updateVariablesCount(),this.setupEventListeners(),this.isN8nPage()&&(this.startVariablesLinkMonitoring(),this.edgeCompatibility.isEdgeBrowser&&this.startEdgeStateMonitoring())}catch(e){}},detectEdgeBrowser(){const e=navigator.userAgent;return e.includes("Edg/")||e.includes("Edge/")},startEdgeStateMonitoring(){this.edgeCompatibility.stateCheckInterval&&clearInterval(this.edgeCompatibility.stateCheckInterval),this.edgeCompatibility.stateCheckInterval=setInterval((()=>{this.checkEdgeStateConsistency()}),2e3),document.addEventListener("visibilitychange",(()=>{!document.hidden&&this.edgeCompatibility.isEdgeBrowser&&setTimeout((()=>{this.checkEdgeStateConsistency()}),500)}))},checkEdgeStateConsistency(){if(!this.isEnabled||!this.isN8nPage())return;const e=this.findVariablesLink();if(!e)return;const t=e.getAttribute("href"),n="true"===e.dataset.n8nMasterProcessed,a=e.querySelector('img[src*="icon16.png"]'),i=this.isEnabled,s=n&&("javascript:void(0)"===t||!t.includes("/variables"))&&a;i&&!s&&(delete e.dataset.n8nMasterProcessed,this.processedLink=null,this.originalVariablesLink=null,this.replacedIcon=null,this.checkAndApplyVariablesOverride())},findVariablesLink:()=>document.querySelector('a[href="/variables"]')||document.querySelector('a[href*="/variables"]')||document.querySelector('[data-test-id*="variables"]')||Array.from(document.querySelectorAll("a")).find((e=>e.textContent&&e.textContent.toLowerCase().includes("variables"))),async initDatabase(){try{await UnifiedDatabaseManager.init(),this.db=UnifiedDatabaseManager.db}catch(e){throw e}},async loadSettings(){try{const e=await chrome.storage.local.get(["localVariables"]);this.isEnabled=e.localVariables||!1}catch(e){this.isEnabled=!1}},async saveSettings(){try{await chrome.storage.local.set({localVariables:this.isEnabled})}catch(e){}},isN8nPage(){const e=window.location.hostname;return e.includes("n8n.cloud")||e.includes("n8n")||null!==document.querySelector('[data-test-id="menu-item"]')},setupEventListeners(){chrome.runtime.onMessage.addListener(((e,t,n)=>{"updateLocalVariables"===e.action&&(this.isEnabled=e.enabled,this.checkAndApplyVariablesOverride(),n({success:!0}))}));let e=location.href;new MutationObserver((()=>{const t=location.href;t!==e&&(e=t,setTimeout((()=>{this.startVariablesLinkMonitoring(),this.edgeCompatibility.isEdgeBrowser&&setTimeout((()=>this.checkEdgeStateConsistency()),1e3)}),1e3))})).observe(document,{subtree:!0,childList:!0}),document.addEventListener("keydown",(e=>{e.ctrlKey&&e.shiftKey&&"V"===e.key&&(e.preventDefault(),e.stopPropagation(),this.isEnabled&&this.isN8nPage()&&this.handleVariablesClick(e))}))},startVariablesLinkMonitoring(){this.monitoringInterval&&clearInterval(this.monitoringInterval),this.checkAndApplyVariablesOverride();const e=this.edgeCompatibility.isEdgeBrowser?2e3:1e3;this.monitoringInterval=setInterval((()=>{this.checkAndApplyVariablesOverride()}),e),this.sidebarObserver&&this.sidebarObserver.disconnect();let t=null,n=0;this.sidebarObserver=new MutationObserver((e=>{const a=Date.now();if(a-n<1e3)return t&&clearTimeout(t),void(t=setTimeout((()=>{this.processMutations(e),n=Date.now()}),1e3));n=a,this.processMutations(e)})),this.sidebarObserver.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["href","class"]}),window.addEventListener("load",(()=>{setTimeout((()=>this.checkAndApplyVariablesOverride()),100)})),document.addEventListener("visibilitychange",(()=>{document.hidden||setTimeout((()=>this.checkAndApplyVariablesOverride()),100)}))},processMutations(e){let t=!1,n=0;e.forEach((e=>{if("childList"===e.type&&e.addedNodes.length>3&&(n++,t=!0),"attributes"===e.type&&"class"===e.attributeName){const a=e.target.className;if(a&&"string"==typeof a)(a.includes("menu")||a.includes("sidebar")||a.includes("nav"))&&(a.includes("collapsed")||a.includes("expanded")||a.includes("open")||a.includes("closed"))&&(n++,t=!0);else if(a&&"object"==typeof a&&a.baseVal){const e=a.baseVal||"";(e.includes("menu")||e.includes("sidebar")||e.includes("nav"))&&(e.includes("collapsed")||e.includes("expanded")||e.includes("open")||e.includes("closed"))&&(n++,t=!0)}}})),t&&n>0&&(this.resetProcessedLinks(),this.checkAndApplyVariablesOverride())},resetProcessedLinks(){const e=document.querySelectorAll('a[data-n8n-master-processed="true"]');(0!==e.length||this.processedLink||this.originalVariablesLink)&&(e.forEach((e=>{delete e.dataset.n8nMasterProcessed})),this.processedLink=null,this.originalVariablesLink=null,this.edgeCompatibility.isEdgeBrowser&&(this.edgeCompatibility.lastProcessedLinkHref=null,this.edgeCompatibility.linkStateCache.clear()))},checkAndApplyVariablesOverride(){if(!this.isN8nPage())return;const e=this.findVariablesLink();if(e){if(this.edgeCompatibility.isEdgeBrowser){const t=e.getAttribute("href");this.edgeCompatibility.lastProcessedLinkHref&&this.edgeCompatibility.lastProcessedLinkHref!==t&&this.resetProcessedLinks(),this.edgeCompatibility.lastProcessedLinkHref=t}"true"!==e.dataset.n8nMasterProcessed&&(e.dataset.n8nMasterProcessed="true",this.processedLink=e,this.isEnabled?this.enableVariablesOverride(e):this.disableVariablesOverride(e))}},enableVariablesOverride(e){if(this.originalVariablesLink)return;this.originalVariablesLink=e.cloneNode(!0),this.updateVariablesLinkText();const t=e.querySelector('svg[data-icon="variable"]')||e.querySelector('[data-icon="variable"]')||e.querySelector("svg");if(t){const e=document.createElement("img");e.src=chrome.runtime.getURL("icons/icon16.png"),e.style.cssText="\n        width: 16px;\n        height: 16px;\n        display: inline-block;\n        vertical-align: middle;\n        opacity: 0.9;\n        filter: brightness(1.2);\n      ",e.title=window.I18nManager?window.I18nManager.getMessage("n8nMasterLocalVariables"):"N8N Master - Local Variables",this.edgeCompatibility.isEdgeBrowser&&e.setAttribute("data-n8n-master-icon","true"),t.parentNode.replaceChild(e,t),this.replacedIcon={parent:e.parentNode,extensionIcon:e,originalIcon:t}}this.clickHandler=this.handleVariablesClick.bind(this),e.addEventListener("click",this.clickHandler,!0),this.edgeCompatibility.isEdgeBrowser&&e.addEventListener("click",this.clickHandler,!1),e.removeAttribute("href"),e.setAttribute("href","javascript:void(0)"),this.edgeCompatibility.isEdgeBrowser&&this.edgeCompatibility.linkStateCache.set(e,{overridden:!0,timestamp:Date.now()})},disableVariablesOverride(e){this.originalVariablesLink&&(this.clickHandler&&(e.removeEventListener("click",this.clickHandler,!0),this.edgeCompatibility.isEdgeBrowser&&e.removeEventListener("click",this.clickHandler,!1),this.clickHandler=null),this.replacedIcon&&(this.replacedIcon.parent.replaceChild(this.replacedIcon.originalIcon,this.replacedIcon.extensionIcon),this.replacedIcon=null),e.setAttribute("href","/variables"),delete e.dataset.n8nMasterProcessed,this.edgeCompatibility.isEdgeBrowser&&this.edgeCompatibility.linkStateCache.delete(e),this.originalVariablesLink=null,this.processedLink=null,this.hideVariablesBlock())},handleVariablesClick(e){return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),this.variablesBlock?this.hideVariablesBlock():this.showVariablesBlock(),!1},showVariablesBlock(){if(this.variablesBlock)return;const e=document.querySelector('[data-test-id="main-sidebar"]')||document.querySelector(".el-aside")||document.querySelector('[class*="sidebar"]')||document.querySelector("nav");this.variablesBlock=document.createElement("div"),this.variablesBlock.id="local-variables-block",this.variablesBlock.innerHTML=this.createVariablesBlockHTML();let t="20px";if(e){t=e.getBoundingClientRect().right+10+"px"}this.variablesBlock.style.cssText=`\n      position: fixed;\n      bottom: 60px;\n      left: ${t};\n      width: 300px;\n      max-height: 300px;\n      background: #1a1a1a;\n      border: 1px solid #444444;\n      border-radius: 6px;\n      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);\n      z-index: 9999;\n      color: #cccccc;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      overflow: hidden;\n      font-size: 13px;\n      display: flex;\n      flex-direction: column;\n    `,document.body.appendChild(this.variablesBlock),this.applyCustomScrollbarStyles(),this.setupVariablesBlockEvents(),requestAnimationFrame((()=>{this.loadAndDisplayVariables()}))},createVariablesBlockHTML:()=>`\n      <div style="padding: 12px; border-bottom: 1px solid #444444; display: flex; justify-content: space-between; align-items: center; background: #2a2a2a; flex-shrink: 0;">\n        <h3 style="margin: 0; color: #ffffff; font-size: 14px; font-weight: 600;">${window.I18nManager?window.I18nManager.getMessage("localVariables"):"Local Variables"}</h3>\n        <div style="display: flex; gap: 6px; align-items: center;">\n          <button id="add-variable-btn" style="\n            background: #ff4757;\n            color: white;\n            border: none;\n            padding: 4px 8px;\n            border-radius: 4px;\n            cursor: pointer;\n            font-size: 12px;\n            font-weight: 500;\n            transition: background 0.2s;\n          ">+ Add</button>\n          <button id="close-variables-btn" style="\n            background: transparent;\n            color: #cccccc;\n            border: 1px solid #666666;\n            padding: 4px 8px;\n            border-radius: 4px;\n            cursor: pointer;\n            font-size: 12px;\n            transition: all 0.2s;\n          ">✕</button>\n        </div>\n      </div>\n      \n      <div style="padding: 10px; flex: 1; display: flex; flex-direction: column; min-height: 0;">\n        \x3c!-- Search --\x3e\n        <div style="margin-bottom: 10px; flex-shrink: 0;">\n          <input\n            type="text"\n            id="variables-search"\n            placeholder="${window.I18nManager?window.I18nManager.getMessage("search"):"Search..."}"\n            style="\n              width: 100%;\n              padding: 6px 8px;\n              background: #2a2a2a;\n              border: 1px solid #444444;\n              border-radius: 4px;\n              color: #cccccc;\n              font-size: 12px;\n              box-sizing: border-box;\n            "\n          />\n        </div>\n        \n        \x3c!-- Variables List with Custom Scrollbar --\x3e\n        <div id="variables-list" style="\n          flex: 1;\n          overflow-y: auto;\n          border: 1px solid #444444;\n          border-radius: 4px;\n          background: #2a2a2a;\n          min-height: 0;\n          /* Custom scrollbar styles */\n          scrollbar-width: thin;\n          scrollbar-color: #666666 #2a2a2a;\n        ">\n          <div id="variables-loading" style="\n            padding: 20px;\n            text-align: center;\n            color: #888888;\n            font-size: 12px;\n          ">${window.I18nManager?window.I18nManager.getMessage("loading"):"Loading..."}</div>\n        </div>\n      </div>\n    `,applyCustomScrollbarStyles(){if(document.getElementById("local-variables-scrollbar-styles"))return;const e=document.createElement("style");e.id="local-variables-scrollbar-styles",e.textContent="\n      #variables-list::-webkit-scrollbar {\n        width: 8px;\n      }\n      \n      #variables-list::-webkit-scrollbar-track {\n        background: #2a2a2a;\n        border-radius: 4px;\n      }\n      \n      #variables-list::-webkit-scrollbar-thumb {\n        background: transparent;\n        border-radius: 4px;\n        transition: background 0.2s ease;\n      }\n      \n      #variables-list:hover::-webkit-scrollbar-thumb {\n        background: #666666;\n      }\n      \n      #variables-list::-webkit-scrollbar-thumb:hover {\n        background: #888888 !important;\n      }\n      \n      #variables-list::-webkit-scrollbar-thumb:active {\n        background: #ff4757 !important;\n      }\n      \n      /* For Firefox */\n      #variables-list {\n        scrollbar-width: thin;\n        scrollbar-color: #666666 #2a2a2a;\n      }\n    ",document.head.appendChild(e)},setupVariablesBlockEvents(){const e=document.getElementById("close-variables-btn");e&&e.addEventListener("click",(()=>{this.hideVariablesBlock()}));const t=document.getElementById("add-variable-btn");t&&t.addEventListener("click",(()=>{this.showAddVariableModal()}));const n=document.getElementById("variables-search");n&&n.addEventListener("input",(e=>{this.filterVariables(e.target.value)}))},hideVariablesBlock(){this.variablesBlock&&(this.variablesBlock.remove(),this.variablesBlock=null);const e=document.getElementById("local-variables-scrollbar-styles");e&&e.remove()},stopVariablesLinkMonitoring(){this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null),this.sidebarObserver&&(this.sidebarObserver.disconnect(),this.sidebarObserver=null),this.edgeCompatibility.isEdgeBrowser&&this.edgeCompatibility.stateCheckInterval&&(clearInterval(this.edgeCompatibility.stateCheckInterval),this.edgeCompatibility.stateCheckInterval=null,this.edgeCompatibility.linkStateCache.clear())},async loadAndDisplayVariables(){try{const e=await this.getAllVariables();this.displayVariables(e)}catch(e){const t=document.getElementById("variables-loading");t&&(t.textContent=window.I18nManager?window.I18nManager.getMessage("errorLoadingVariables"):"Error loading variables")}},displayVariables(e,t=""){const n=document.getElementById("variables-list"),a=document.getElementById("variables-loading");if(!n)return;if(a&&a.remove(),0===e.length){const e=t?window.I18nManager?window.I18nManager.getMessage("noVariablesFound"):"No variables found matching your search.":window.I18nManager?window.I18nManager.getMessage("noVariablesYet"):'No variables yet. Click "+ Add variable" to create your first one.';return void(n.innerHTML=`\n        <div style="padding: 40px; text-align: center; color: #888888;">\n          ${e}\n        </div>\n      `)}const i=t?e.filter((e=>e.name.toLowerCase().includes(t.toLowerCase()))):e;if(0===i.length){const e=window.I18nManager?window.I18nManager.getMessage("noVariablesMatchingSearch").replace("{{searchTerm}}",t):`No variables found matching "${t}".`;return void(n.innerHTML=`\n        <div style="padding: 40px; text-align: center; color: #888888;">\n          ${e}\n        </div>\n      `)}const s=window.I18nManager?window.I18nManager.getMessage("clickToCopy"):"Click to copy",r=i.map((e=>`\n      <div class="variable-item" data-variable-id="${e.id}" title="${s}" style="\n        padding: 8px 10px;\n        border-bottom: 1px solid #444444;\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        cursor: pointer;\n        transition: background 0.2s;\n      ">\n        <div style="flex: 1; min-width: 0;">\n          <div style="font-weight: 600; color: #ffffff; margin-bottom: 2px; word-break: break-word; font-size: 12px;">\n            ${this.escapeHtml(e.name)}\n          </div>\n          <div style="color: #888888; font-size: 11px; word-break: break-word; max-height: 30px; overflow: hidden;">\n            ${this.escapeHtml(e.value.substring(0,35))}${e.value.length>35?"...":""}\n          </div>\n        </div>\n        <button class="delete-variable-btn" data-variable-id="${e.id}" style="\n          background: #dc3545;\n          color: white;\n          border: none;\n          padding: 3px 6px;\n          border-radius: 3px;\n          cursor: pointer;\n          font-size: 10px;\n          margin-left: 8px;\n          transition: background 0.2s;\n          opacity: 0.7;\n        ">×</button>\n      </div>\n    `)).join("");n.innerHTML=r,document.querySelectorAll(".variable-item").forEach((e=>{e.addEventListener("click",(t=>{if(t.target.classList.contains("delete-variable-btn"))return;const n=e.dataset.variableId,a=i.find((e=>e.id==n));a&&this.copyVariableToClipboard(a)})),e.addEventListener("mouseenter",(()=>{e.style.backgroundColor="rgba(255, 71, 87, 0.1)",e.style.borderColor="#ff4757"})),e.addEventListener("mouseleave",(()=>{e.style.backgroundColor="transparent",e.style.borderColor="#444444"}))})),document.querySelectorAll(".delete-variable-btn").forEach((e=>{e.addEventListener("click",(t=>{t.stopPropagation();const n=e.dataset.variableId;this.confirmDeleteVariable(n)}))}))},filterVariables(e){this.getAllVariables().then((t=>{this.displayVariables(t,e)}))},showAddVariableModal(){const e=document.createElement("div");e.id="add-variable-modal",e.innerHTML=this.createAddVariableModalHTML(),e.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: rgba(0, 0, 0, 0.7);\n      z-index: 10001;\n      display: flex;\n      justify-content: center;\n      align-items: center;\n    ",document.body.appendChild(e),this.setupAddVariableModalEvents(e),setTimeout((()=>{document.getElementById("variable-name-input").focus()}),100)},createAddVariableModalHTML(){const e=window.I18nManager?window.I18nManager.getMessage("addVariableTitle"):"Add Variable",t=window.I18nManager?window.I18nManager.getMessage("variableName"):"Name",n=window.I18nManager?window.I18nManager.getMessage("variableValue"):"Value";return`\n      <div style="\n        background: #1a1a1a;\n        border: 1px solid #444444;\n        border-radius: 8px;\n        padding: 24px;\n        width: 400px;\n        max-width: 90vw;\n        color: #cccccc;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      ">\n        <h3 style="margin: 0 0 20px 0; color: #ffffff; font-size: 18px; font-weight: 600;">${e}</h3>\n        \n        <div style="margin-bottom: 16px;">\n          <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #cccccc;">${t}</label>\n          <input\n            type="text"\n            id="variable-name-input"\n            placeholder="${window.I18nManager?window.I18nManager.getMessage("enterVariableName"):"Enter variable name..."}"\n            style="\n              width: 100%;\n              padding: 10px 12px;\n              background: #2a2a2a;\n              border: 1px solid #444444;\n              border-radius: 6px;\n              color: #cccccc;\n              font-size: 14px;\n              box-sizing: border-box;\n            "\n          />\n        </div>\n        \n        <div style="margin-bottom: 24px;">\n          <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #cccccc;">${n}</label>\n          <textarea\n            id="variable-value-input"\n            placeholder="${window.I18nManager?window.I18nManager.getMessage("enterVariableValue"):"Enter variable value..."}"\n            rows="4"\n            style="\n              width: 100%;\n              padding: 10px 12px;\n              background: #2a2a2a;\n              border: 1px solid #444444;\n              border-radius: 6px;\n              color: #cccccc;\n              font-size: 14px;\n              font-family: 'Consolas', 'Monaco', monospace;\n              resize: vertical;\n              box-sizing: border-box;\n            "\n          ></textarea>\n        </div>\n        \n        <div style="display: flex; gap: 12px; justify-content: flex-end;">\n          <button id="cancel-variable-btn" style="\n            background: transparent;\n            color: #cccccc;\n            border: 1px solid #666666;\n            padding: 10px 20px;\n            border-radius: 6px;\n            cursor: pointer;\n            font-size: 14px;\n            transition: all 0.2s;\n          ">${window.I18nManager?window.I18nManager.getMessage("cancel"):"Cancel"}</button>\n          <button id="save-variable-btn" disabled style="\n            background: #6c757d;\n            color: white;\n            border: none;\n            padding: 10px 20px;\n            border-radius: 6px;\n            cursor: not-allowed;\n            font-size: 14px;\n            font-weight: 500;\n            transition: background 0.2s;\n          ">${window.I18nManager?window.I18nManager.getMessage("save"):"Save"}</button>\n        </div>\n      </div>\n    `},setupAddVariableModalEvents(e){const t=document.getElementById("variable-name-input"),n=document.getElementById("variable-value-input"),a=document.getElementById("save-variable-btn"),i=document.getElementById("cancel-variable-btn"),s=()=>{const e=t.value.trim().length>0,i=n.value.trim().length>0;e&&i?(a.disabled=!1,a.style.background="#ff4757",a.style.cursor="pointer"):(a.disabled=!0,a.style.background="#6c757d",a.style.cursor="not-allowed")};t.addEventListener("input",s),n.addEventListener("input",s),a.addEventListener("click",(async()=>{if(a.disabled)return;const i=t.value.trim(),s=n.value.trim();try{await this.saveVariable(i,s),e.remove(),this.loadAndDisplayVariables();const t=window.I18nManager?window.I18nManager.getMessage("variableSavedSuccessfully"):"Variable saved successfully!";this.showNotification(t,"success")}catch(e){const t=window.I18nManager?window.I18nManager.getMessage("failedToSaveVariable"):"Failed to save variable:";this.showNotification(t+" "+e.message,"error")}})),i.addEventListener("click",(()=>{e.remove()})),e.addEventListener("click",(t=>{t.target===e&&e.remove()})),document.addEventListener("keydown",(t=>{"Escape"===t.key&&e.remove()})),document.addEventListener("keydown",(e=>{e.ctrlKey&&"Enter"===e.key&&!a.disabled&&a.click()}))},async copyVariableToClipboard(e){try{await navigator.clipboard.writeText(e.value);const t=window.I18nManager?window.I18nManager.getMessage("variableCopiedToClipboard"):"The parameter was copied to the clipboard. Press Ctrl + V to paste it to the desired location.";this.showNotification(t,"success")}catch(e){const t=window.I18nManager?window.I18nManager.getMessage("failedToCopyToClipboard"):"Failed to copy to clipboard";this.showNotification(t,"error")}},confirmDeleteVariable(e){const t=window.I18nManager?window.I18nManager.getMessage("deleteVariable"):"Delete Variable",n=window.I18nManager?window.I18nManager.getMessage("deleteVariableConfirm"):"Are you sure you want to delete this variable? This action cannot be undone.",a=window.I18nManager?window.I18nManager.getMessage("cancel"):"Cancel",i=window.I18nManager?window.I18nManager.getMessage("delete"):"Delete",s=document.createElement("div");s.innerHTML=`\n      <div style="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.7);\n        z-index: 10002;\n        display: flex;\n        justify-content: center;\n        align-items: center;\n      ">\n        <div style="\n          background: #1a1a1a;\n          border: 1px solid #444444;\n          border-radius: 8px;\n          padding: 24px;\n          width: 350px;\n          max-width: 90vw;\n          color: #cccccc;\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n        ">\n          <h3 style="margin: 0 0 16px 0; color: #ffffff; font-size: 18px; font-weight: 600;">${t}</h3>\n          <p style="margin: 0 0 24px 0; color: #cccccc; line-height: 1.5;">\n            ${n}\n          </p>\n          \n          <div style="display: flex; gap: 12px; justify-content: flex-end;">\n            <button class="cancel-delete-btn" style="\n              background: transparent;\n              color: #cccccc;\n              border: 1px solid #666666;\n              padding: 10px 20px;\n              border-radius: 6px;\n              cursor: pointer;\n              font-size: 14px;\n              transition: all 0.2s;\n            ">${a}</button>\n            <button class="confirm-delete-btn" style="\n              background: #dc3545;\n              color: white;\n              border: none;\n              padding: 10px 20px;\n              border-radius: 6px;\n              cursor: pointer;\n              font-size: 14px;\n              font-weight: 500;\n              transition: background 0.2s;\n            ">${i}</button>\n          </div>\n        </div>\n      </div>\n    `,document.body.appendChild(s),s.querySelector(".cancel-delete-btn").addEventListener("click",(()=>{s.remove()})),s.querySelector(".confirm-delete-btn").addEventListener("click",(async()=>{try{await this.deleteVariable(e),s.remove(),this.loadAndDisplayVariables();const t=window.I18nManager?window.I18nManager.getMessage("variableDeletedSuccessfully"):"Variable deleted successfully!";this.showNotification(t,"success")}catch(e){const t=window.I18nManager?window.I18nManager.getMessage("failedToDeleteVariable"):"Failed to delete variable:";this.showNotification(t+" "+e.message,"error")}})),s.addEventListener("click",(e=>{e.target===s&&s.remove()}))},async saveVariable(e,t){try{const n={name:e,value:t,created:(new Date).toISOString(),updated:(new Date).toISOString()},a=await UnifiedDatabaseManager.saveVariable(n);return await this.updateVariablesCount(),a}catch(e){throw e}},async getAllVariables(){try{return(await UnifiedDatabaseManager.getAllVariables()).sort(((e,t)=>new Date(t.created)-new Date(e.created)))}catch(e){throw e}},async deleteVariable(e){try{await UnifiedDatabaseManager.deleteVariable(Number(e)),await this.updateVariablesCount()}catch(e){throw e}},escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML},showNotification(e,t="info"){const n=document.getElementById("n8n-master-notification");n&&n.remove();const a=document.createElement("div");a.id="n8n-master-notification",a.style.cssText="\n      position: fixed;\n      bottom: 30%;\n      left: 50%;\n      transform: translateX(-50%);\n      padding: 12px 20px;\n      border-radius: 8px;\n      color: white;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      font-size: 14px;\n      font-weight: 500;\n      z-index: 99999;\n      box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n      max-width: 400px;\n      text-align: center;\n      transition: all 0.3s ease;\n    ";const i={success:"#28a745",error:"#dc3545",info:"#17a2b8"};a.style.backgroundColor=i[t]||i.info,a.textContent=e,document.body.appendChild(a),setTimeout((()=>{a.parentNode&&(a.style.opacity="0",a.style.transform="translateX(-50%) translateY(20px)",setTimeout((()=>a.remove()),300))}),3e3)},updateLocalization:function(){if(this.updateVariablesLinkText(),this.variablesBlock){const e=document.getElementById("variables-search"),t=e?e.value:"";if(this.variablesBlock.innerHTML=this.createVariablesBlockHTML(),this.setupVariablesBlockEvents(),t){const e=document.getElementById("variables-search");e&&(e.value=t)}this.loadAndDisplayVariables().then((()=>{t&&this.filterVariables(t)}))}if(this.replacedIcon&&this.replacedIcon.extensionIcon){const e=window.I18nManager?window.I18nManager.getMessage("n8nMasterLocalVariables"):"N8N Master - Local Variables";this.replacedIcon.extensionIcon.title=e}this.edgeCompatibility.isEdgeBrowser&&setTimeout((()=>{this.checkEdgeStateConsistency()}),500)},async toggleEnabled(){if(this.isEnabled=!this.isEnabled,await this.saveSettings(),this.checkAndApplyVariablesOverride(),"undefined"!=typeof chrome&&chrome.tabs)try{const e=await chrome.tabs.query({active:!0,currentWindow:!0});e[0]&&chrome.tabs.sendMessage(e[0].id,{action:"updateLocalVariables",enabled:this.isEnabled})}catch(e){}return this.isEnabled},testLocalization:function(){if(!window.I18nManager)return{success:!1,error:"I18nManager not available"};const e=window.I18nManager.getCurrentLanguage(),t=["localVariables","addVariable","addVariableTitle","variableName","variableValue","enterVariableName","enterVariableValue","clickToCopy","deleteVariable","deleteVariableConfirm","variableSavedSuccessfully","variableDeletedSuccessfully","variableCopiedToClipboard"],n={};let a=0;t.forEach((e=>{const t=window.I18nManager.getMessage(e);n[e]=t,t&&t!==e&&a++}));const i={isEnabled:this.isEnabled,variablesBlockVisible:!!this.variablesBlock,hasReplacedIcon:!!this.replacedIcon,isMonitoring:!!this.monitoringInterval};return{success:!0,language:e,translationsFound:a,totalKeys:t.length,translations:n,uiState:i,timestamp:(new Date).toISOString()}},async updateVariablesCount(){try{const e=await this.getAllVariables();this.variablesCount=e.length,this.updateVariablesLinkText()}catch(e){this.variablesCount=0}},updateVariablesLinkText(){if(!this.processedLink)return;const e=this.getTextNodes(this.processedLink).find((e=>e.textContent&&e.textContent.toLowerCase().includes("variables")));if(e){const t="Variables",n=window.I18nManager&&(window.I18nManager.getMessage("Variables")||window.I18nManager.getMessage("variables"))||t,a=n.charAt(0).toUpperCase()+n.slice(1);this.variablesCount>0?e.textContent=`${a} (${this.variablesCount})`:e.textContent=a}},getTextNodes(e){const t=[],n=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1);let a;for(;a=n.nextNode();)t.push(a);return t}};"undefined"!=typeof window&&window.location&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>{LocalVariablesManager.init()})):LocalVariablesManager.init()),"undefined"!=typeof window&&(window.LocalVariablesManager=LocalVariablesManager,window.testLocalVariablesLocalization=function(){return LocalVariablesManager.testLocalization()}),"undefined"!=typeof module&&module.exports&&(module.exports=LocalVariablesManager);