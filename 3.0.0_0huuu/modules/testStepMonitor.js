const TestStepMonitor={observer:null,isMonitoring:!1,activeNodeTests:new Map,init:function(){this.startMonitoring()},startMonitoring:function(){this.isMonitoring||(this.isMonitoring=!0,this.observer=new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.forEach((e=>{e.nodeType===Node.ELEMENT_NODE&&this.checkForTestStepButtons(e)}))}))})),this.observer.observe(document.body,{childList:!0,subtree:!0}),this.checkForTestStepButtons(document.body))},checkForTestStepButtons:function(e){(e.querySelectorAll?e.querySelectorAll('[data-test-id="node-execute-button"]'):[]).forEach((e=>{e.dataset.testStepMonitored||this.addTestStepListener(e)}))},addTestStepListener:function(e){e.dataset.testStepMonitored="true",e.addEventListener("click",(t=>{this.handleTestStepClick(t,e)}))},handleTestStepClick:function(e,t){const n=t.closest('.ndv-wrapper, .node-settings, [data-test-id="node-parameters"]');if(!n)return;const o=n.textContent?.toLowerCase()||"";let s=null,r=!1;chrome.storage.local.get(["autoPinHttp","autoPinAi"],(e=>{o.includes("http request")||o.includes("http")&&o.includes("request")?(s="http",r=e.autoPinHttp):(o.includes("ai agent")||o.includes("openai")||o.includes("anthropic")||o.includes("claude")||o.includes("gpt")||o.includes("chat model"))&&(s="ai",r=e.autoPinAi),s&&r&&this.startNodeExecutionTracking(n,s,t)}))},startNodeExecutionTracking:function(e,t,n){const o=Date.now()+"_"+Math.random().toString(36).substr(2,9);this.activeNodeTests.set(o,{nodeType:t,button:n,nodeContainer:e,startTime:Date.now(),status:"executing"}),this.watchTestStepButtonState(o,n,t),this.findCanvasNodeAndWatch(o,t,e),setTimeout((()=>{this.activeNodeTests.has(o)&&this.activeNodeTests.delete(o)}),6e4)},watchTestStepButtonState:function(e,t,n){let o={text:t.textContent?.trim(),disabled:t.disabled,classList:Array.from(t.classList),style:t.style.cssText};const s=new MutationObserver((n=>{let r=!1;if(n.forEach((e=>{"attributes"!==e.type&&"childList"!==e.type||(r=!0)})),r){const n={text:t.textContent?.trim(),disabled:t.disabled,classList:Array.from(t.classList),style:t.style.cssText};this.isButtonBackToNormalState(o,n)&&setTimeout((()=>{const t=this.activeNodeTests.get(e);t&&(this.applyAutoPinAfterExecution(t.nodeType,e),this.activeNodeTests.delete(e)),s.disconnect()}),1e3)}}));s.observe(t,{attributes:!0,childList:!0,subtree:!0,attributeFilter:["class","disabled","style","aria-busy","data-loading"]});const r=t.closest(".node-execute-button, .ndv-wrapper, .node-settings");r&&r!==t&&s.observe(r,{attributes:!0,childList:!0,subtree:!1,attributeFilter:["class","style","data-execution-status"]});const i=this.activeNodeTests.get(e);i&&(i.buttonObserver=s)},isButtonBackToNormalState:function(e,t){try{const n=t.text===e.text||"Test step"===e.text&&"Test step"===t.text||e.text?.includes("Test")&&t.text?.includes("Test")&&!t.text.includes("...")&&!t.text.includes("Running"),o=!t.disabled,s=!t.classList.some((e=>e.includes("loading")||e.includes("executing")||e.includes("running")||e.includes("busy"))),r=!t.style.includes("opacity")||t.style.includes("opacity: 1");e.classList.some((e=>e.includes("executing")))||e.text?.includes("...")||e.disabled,!t.classList.some((e=>e.includes("executing")))&&!t.text?.includes("...")&&t.disabled;return n&&o&&s&&r}catch(e){return!1}},applyAutoPinAfterExecution:function(e,t){try{const e=document.querySelector('[data-test-id="ndv-pin-data"]');if(e&&null!==e.offsetParent)return void e.click();const t=['[data-test-id*="pin"]','button[title*="pin"]','button[title*="Pin"]',".ndv-pin-data",'[aria-label*="pin"]','[aria-label*="Pin"]'];for(const e of t){const t=document.querySelector(e);if(t&&null!==t.offsetParent)return void t.click()}const n=new KeyboardEvent("keydown",{key:"p",code:"KeyP",bubbles:!0,cancelable:!0});document.dispatchEvent(n)}catch(e){}},findCanvasNodeAndWatch:function(e,t,n){const o=document.querySelectorAll('[data-test-id="canvas-node"]');let s=null;for(const e of o){const n=e.textContent?.toLowerCase()||"";if("http"===t&&n.includes("http request")){s=e;break}if("ai"===t&&(n.includes("ai agent")||n.includes("openai")||n.includes("chat model"))){s=e;break}}s?this.watchNodeExecution(e,s):this.watchAllNodesOfType(e,t)},watchNodeExecution:function(e,t){const n=new MutationObserver((o=>{o.forEach((o=>{if((o.target===t||t.contains(o.target))&&this.isNodeExecutionSuccessful(t)){const o=this.activeNodeTests.get(e);o&&(this.applyAutoPinToNode(t,o.nodeType),this.activeNodeTests.delete(e)),n.disconnect()}}))}));n.observe(t,{attributes:!0,childList:!0,subtree:!0,attributeFilter:["class","style","data-execution-status"]});const o=this.activeNodeTests.get(e);o&&(o.observer=n)},watchAllNodesOfType:function(e,t){const n=document.querySelectorAll('[data-test-id="canvas-node"]'),o=[];for(const e of n){const n=e.textContent?.toLowerCase()||"";("http"===t&&n.includes("http request")||"ai"===t&&(n.includes("ai agent")||n.includes("openai")||n.includes("chat model")))&&o.push(e)}o.forEach(((t,n)=>{setTimeout((()=>{this.watchNodeExecution(`${e}_${n}`,t)}),100*n)}))},isNodeExecutionSuccessful:function(e){try{return[()=>"true"===e.getAttribute("data-temp-success"),()=>e.classList.contains("temp-success"),()=>e.querySelector(".fa-check"),()=>e.querySelector('[class*="success"]'),()=>e.querySelector('[data-test-id*="success"]'),()=>e.querySelector('[data-test-id*="execution"]'),()=>e.querySelector('svg[fill*="green"]'),()=>{const t=window.getComputedStyle(e);return t.borderColor.includes("green")||t.backgroundColor.includes("green")||t.borderColor.includes("#22c55e")||t.borderColor.includes("rgb(34, 197, 94)")},()=>{const t=e.className||"";return t.includes("success")||t.includes("completed")||t.includes("executed")||t.includes("finished")},()=>{const t=e.textContent?.toLowerCase()||"";return["success","completed","finished","executed"].some((e=>t.includes(e)&&t.length<200))}].some((e=>{try{return e()}catch{return!1}}))}catch(e){return!1}},applyAutoPinToNode:function(e,t){try{const t=document.querySelector('[data-test-id="ndv-pin-data"]');if(t)return void t.click();e.click(),setTimeout((()=>{const e=document.querySelector('[data-test-id="ndv-pin-data"]');if(e)e.click();else{const e=new KeyboardEvent("keydown",{key:"p",code:"KeyP",bubbles:!0,cancelable:!0});document.dispatchEvent(e)}setTimeout((()=>{const e=document.querySelector('.workflow-canvas, [data-test-id="canvas"]');if(e){const t=e.getBoundingClientRect(),n=new MouseEvent("click",{bubbles:!0,clientX:t.right-50,clientY:t.bottom-50});e.dispatchEvent(n)}}),200)}),500)}catch(e){}},stopMonitoring:function(){this.observer&&(this.observer.disconnect(),this.observer=null),this.activeNodeTests.forEach((e=>{e.observer&&e.observer.disconnect(),e.buttonObserver&&e.buttonObserver.disconnect()})),this.activeNodeTests.clear(),this.isMonitoring=!1},getStatus:function(){return{isMonitoring:this.isMonitoring,activeTests:this.activeNodeTests.size,observer:!!this.observer}}};window.testStepMonitor=TestStepMonitor,setTimeout((()=>{(window.location.href.includes("n8n")||window.location.hostname.includes("n8n")||document.querySelector('[data-test-id="canvas-node"]'))&&TestStepMonitor.init()}),3e3),window.testTestStepMonitoring=function(){const e=TestStepMonitor.getStatus(),t=document.querySelectorAll('[data-test-id="node-execute-button"]');t.forEach(((e,t)=>{}));const n=document.querySelectorAll('[data-test-id="canvas-node"]');let o=0,s=0;return n.forEach((e=>{const t=e.textContent?.toLowerCase()||"";t.includes("http request")&&o++,(t.includes("ai agent")||t.includes("openai"))&&s++})),chrome.storage.local.get(["autoPinHttp","autoPinAi"],(e=>{})),{status:e,testStepButtons:t.length,canvasNodes:n.length,httpNodes:o,aiNodes:s}},window.testPinButton=function(){const e=document.querySelector('[data-test-id="ndv-pin-data"]');if(e)return e.click(),{found:!0,clicked:!0};{const e=document.querySelectorAll("button"),t=Array.from(e).filter((e=>e.textContent?.toLowerCase().includes("pin")||e.getAttribute("data-test-id")?.includes("pin")||e.className?.includes("pin")));return t.forEach(((e,t)=>{e.textContent?.trim(),e.getAttribute("data-test-id"),e.className})),{found:!1,clicked:!1,allButtons:e.length,pinButtons:t.length}}};const ErrorAnalyzer={isEnabled:!1,errorObserver:null,licenseValid:!1,init:async function(){await this.checkFeatureStatus(),this.isEnabled&&this.licenseValid&&this.startErrorMonitoring()},checkFeatureStatus:async function(){try{const e=await new Promise((e=>{chrome.storage.local.get(["aiErrorTrigger","licenseActivated"],e)}));this.isEnabled=e.aiErrorTrigger||!1,this.licenseValid=e.licenseActivated||!1}catch(e){}},startErrorMonitoring:function(){this.errorObserver&&this.errorObserver.disconnect(),this.errorObserver=new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.forEach((e=>{e.nodeType===Node.ELEMENT_NODE&&this.checkForErrorMessages(e)}))}))})),this.errorObserver.observe(document.body,{childList:!0,subtree:!0}),this.checkForErrorMessages(document.body)},checkForErrorMessages:function(e){['[data-test-id="node-error-message"]',".node-error-view__header-message",".el-alert--error",".has-issues",'[data-test-id="execution-error"]',".node-execution-error"].forEach((t=>{(e.querySelectorAll?e.querySelectorAll(t):[]).forEach((e=>{e.dataset.errorAnalyzed||this.analyzeError(e)}))}))},analyzeError:async function(e){e.dataset.errorAnalyzed="true";try{const t=await this.collectErrorContext(e);t&&t.error&&await this.sendErrorToAI(t)}catch(t){try{const t={error:{message:e.textContent?.trim()||"Unknown error",location:"Error Analysis Failed",html:e.outerHTML},nodeSettings:null,inputData:null,workflowContext:{workflowName:"Unknown Workflow",nodeCount:0,url:window.location.href},timestamp:(new Date).toISOString()};await this.sendErrorToAI(t)}catch(e){}}},collectErrorContext:async function(e){const t={error:null,nodeSettings:null,inputData:null,workflowContext:null,timestamp:(new Date).toISOString()};if(t.error=this.extractErrorMessage(e),window.NodeContextAnalyzer)try{const e=window.NodeContextAnalyzer.getCurrentNodeContext();e&&e.isOpen&&e.nodeName&&"Unknown Node"!==e.nodeName&&(t.nodeSettings={nodeName:e.nodeName,nodeType:e.nodeType,parameters:e.parameters,activeTab:e.activeTab,reason:e.reason})}catch(e){}return t.inputData=this.extractInputData(),t.workflowContext=this.extractWorkflowContext(),t},extractErrorMessage:function(e){try{let t="";if(e.textContent&&(t=e.textContent.trim()),!t){const n=e.querySelector(".error-content, .error-message, .el-alert__content");n&&(t=n.textContent.trim())}if(!t){const n=e.closest(".error-container, .node-error-view, .execution-error");n&&(t=n.textContent.trim())}return{message:t,html:e.outerHTML,location:this.getErrorLocation(e)}}catch(t){return{message:"Could not extract error message",html:e.outerHTML,location:"unknown"}}},getErrorLocation:function(e){const t=[];return e.closest('.ndv-wrapper, [data-test-id="ndv"]')&&t.push("Node Details View"),e.closest('[data-test-id="ndv-output-panel"], .ndv-output')&&t.push("Output Panel"),e.closest(".execution-card, .execution-list")&&t.push("Execution Panel"),t.length>0?t.join(", "):"Unknown Location"},extractInputData:function(){try{const e={};return document.querySelectorAll('[data-test-id="ndv-input-panel"], .ndv-input-panel').forEach(((t,n)=>{const o=t.textContent?.trim();o&&o.length>0&&o.length<1e4&&(e[`input_${n+1}`]=o.substring(0,2e3))})),Object.keys(e).length>0?e:null}catch(e){return null}},extractWorkflowContext:function(){try{const e=document.querySelector('[data-test-id="workflow-name-input"], .workflow-name')?.textContent?.trim();return{workflowName:e||"Unnamed Workflow",nodeCount:document.querySelectorAll('[data-test-id="canvas-node"]').length,url:window.location.href}}catch(e){return null}},sendErrorToAI:async function(e){try{this.showAnalyzingMessage();const t=this.createErrorAnalysisPrompt(e);chrome.runtime.sendMessage({action:"chatWithAI",prompt:t,isAutomatic:!0,source:"errorAnalyzer"},(e=>{chrome.runtime.lastError?this.handleAIError("Communication error with AI service"):e&&e.success?e.response&&this.handleAIResponse(e.response):this.handleAIError(e?.error||"AI analysis failed")}))}catch(e){this.handleAIError("Failed to send error for analysis")}},createErrorAnalysisPrompt:function(e){let t="🚨 **AUTOMATIC ERROR ANALYSIS REQUEST**\n\n";if(e.error&&(t+="**ERROR DETAILS:**\n",t+=`Message: ${e.error.message}\n`,t+=`Location: ${e.error.location}\n\n`),e.nodeSettings&&window.NodeContextAnalyzer)try{const n=window.NodeContextAnalyzer.getCurrentNodeContext(),o=window.NodeContextAnalyzer.formatContextForAI(n);o?t+=`**DETAILED NODE CONTEXT:**\n${o}\n\n`:(t+="**CURRENT NODE (Basic Info):**\n",t+=`Node Type: ${e.nodeSettings.nodeName}\n`,t+=`Node Category: ${e.nodeSettings.nodeType}\n`,e.nodeSettings.parameters&&(t+=`Parameters Summary: ${Object.keys(e.nodeSettings.parameters).length} parameters configured\n`),t+="\n")}catch(n){t+="**CURRENT NODE (Fallback):**\n",t+=`Node Type: ${e.nodeSettings.nodeName}\n`,e.nodeSettings.parameters&&(t+=`Parameters: ${JSON.stringify(e.nodeSettings.parameters,null,2)}\n`),t+="\n"}else e.nodeSettings&&(t+="**CURRENT NODE:**\n",t+=`Node Type: ${e.nodeSettings.nodeName}\n`,e.nodeSettings.parameters&&(t+=`Parameters: ${JSON.stringify(e.nodeSettings.parameters,null,2)}\n`),t+="\n");e.inputData&&(t+="**INPUT DATA:**\n",Object.entries(e.inputData).forEach((([e,n])=>{t+=`${e}: ${n}\n`})),t+="\n"),e.workflowContext&&(t+="**WORKFLOW CONTEXT:**\n",t+=`Name: ${e.workflowContext.workflowName}\n`,t+=`Total Nodes: ${e.workflowContext.nodeCount}\n\n`),t+="**REQUEST:**\n",t+="Please analyze this error and provide:\n",t+="1. Root cause explanation\n",t+="2. Step-by-step solution\n",t+="3. Prevention tips\n",t+="4. Alternative approaches if applicable\n\n",t+="Focus on practical, actionable solutions for n8n workflows.\n\n";const n=this.getUserLanguagePreference();return t+=`**IMPORTANT: Please respond in ${n} language.**`,t},getUserLanguagePreference:function(){try{if(window.I18nManager&&"function"==typeof window.I18nManager.getCurrentLanguage){const e=window.I18nManager.getCurrentLanguage();return{en:"English",ru:"Russian",es:"Spanish"}[e]||"English"}const e=navigator.language.split("-")[0];return{en:"English",ru:"Russian",es:"Spanish"}[e]||"English"}catch(e){return"English"}},showAnalyzingMessage:function(){try{"function"==typeof window.showChatWidget?window.showChatWidget().then((()=>{this.addAnalyzingMessageToChat()})).catch((()=>{this.addAnalyzingMessageToChat()})):this.addAnalyzingMessageToChat()}catch(e){}},addAnalyzingMessageToChat:function(){const e=`🔍 ${window.I18nManager?window.I18nManager.getMessage("chatAnalyzingError"):"Analyzing error"}<span class="loading-dots"></span>`;"function"==typeof window.addMessageToChat?this.loadingMessageId=window.addMessageToChat("assistant",e,!0):"function"==typeof addMessageToChat?this.loadingMessageId=addMessageToChat("assistant",e,!0):document.dispatchEvent(new CustomEvent("n8nMasterShowAnalyzing",{detail:{sender:"assistant",message:e,isLoading:!0}}))},handleAIResponse:function(e){try{this.loadingMessageId&&"function"==typeof window.removeMessageFromChat&&window.removeMessageFromChat(this.loadingMessageId),"function"==typeof window.addMessageToChat?window.addMessageToChat("assistant",e):document.dispatchEvent(new CustomEvent("n8nMasterAIResponse",{detail:{sender:"assistant",message:e}}))}catch(e){}},handleAIError:function(e){try{this.loadingMessageId&&"function"==typeof window.removeMessageFromChat&&window.removeMessageFromChat(this.loadingMessageId);const t=`❌ **Error Analysis Failed**\n\n${e}\n\nPlease try asking about this error manually in the chat.`;"function"==typeof window.addMessageToChat?window.addMessageToChat("assistant",t):document.dispatchEvent(new CustomEvent("n8nMasterAIResponse",{detail:{sender:"assistant",message:t}}))}catch(e){}},stop:function(){this.errorObserver&&(this.errorObserver.disconnect(),this.errorObserver=null)}};if(TestStepMonitor){TestStepMonitor.ErrorAnalyzer=ErrorAnalyzer;const e=TestStepMonitor.init;TestStepMonitor.init=function(){e.call(this),setTimeout((()=>{ErrorAnalyzer.init()}),1e3)}}window.TestStepMonitor=TestStepMonitor,setTimeout((()=>{"undefined"!=typeof window&&window.location&&(window.location.href.includes("n8n.cloud")||window.location.href.includes("localhost")||document.querySelector('[data-test-id="workflow-canvas"]'))&&TestStepMonitor.init()}),2e3);