async function initializeI18n(){try{await I18nManager.init();setTimeout((()=>{updatePopupLocalization()}),100)}catch(e){}}async function initializePopup(){try{const e=await chrome.storage.local.get(["aiProvider","apiKeys"]);if(e.aiProvider){const t=document.querySelector(`input[name="aiProvider"][value="${e.aiProvider}"]`);t&&(t.checked=!0,updateProviderDisplay(e.aiProvider))}else updateProviderDisplay("chatgpt");e.apiKeys&&(e.apiKeys.chatgpt&&(document.getElementById("chatgpt-key").value=e.apiKeys.chatgpt),e.apiKeys.anthropic&&(document.getElementById("anthropic-key").value=e.apiKeys.anthropic),e.apiKeys.gemini&&(document.getElementById("gemini-key").value=e.apiKeys.gemini),e.apiKeys.openrouter&&(document.getElementById("openrouter-key").value=e.apiKeys.openrouter));await checkPageStatus();await loadAndDisplaySelectedModels()}catch(e){showError("Failed to load settings: "+e.message)}}async function loadTranslations(e){try{const t=await fetch(`/_locales/${e}/messages.json`);if(!t.ok){const t=await getLocalizedText("errorFailedToLoadTranslations","Failed to load translations for language:");throw new Error(`${t} ${e}`)}return await t.json()}catch(e){return null}}function getManualTranslation(e,t){return e&&e[t]?e[t].message:null}async function getLocalizedText(e,t){try{const n=I18nManager.getCurrentLanguage();return getManualTranslation(await loadTranslations(n),e)||t}catch(e){return t}}async function initializeDynamicText(){const e=document.getElementById("n8n-host-info");if(e){const t=await getLocalizedText("checking","Checking...");e.textContent=t}}async function updateStatusMessage(){const e=document.querySelector(".status-text");if(e&&e.hasAttribute("data-i18n")){const t=e.getAttribute("data-i18n"),n=await getLocalizedText(t,e.textContent);e.textContent=n}}async function updatePopupLocalization(){try{if(!window.I18nManager||!I18nManager.getMessage)return;const e=I18nManager.getCurrentLanguage(),t=await loadTranslations(e);if(!t)return;let n=0;document.querySelectorAll("[data-i18n]").forEach(((e,a)=>{const o=e.getAttribute("data-i18n");if(o){const a=e.textContent,i=getManualTranslation(t,o);i&&i!==o&&i!==a&&(e.textContent=i,n++)}}));document.querySelectorAll("[data-i18n-placeholder]").forEach((e=>{const a=e.getAttribute("data-i18n-placeholder");if(a){const o=e.placeholder,i=getManualTranslation(t,a);i&&i!==a&&i!==o&&(e.placeholder=i,n++)}}));document.querySelectorAll("[data-i18n-title]").forEach((e=>{const a=e.getAttribute("data-i18n-title");if(a){const o=e.title,i=getManualTranslation(t,a);i&&i!==a&&i!==o&&(e.title=i,n++)}})),await updateStatusMessage()}catch(e){}}function setupEventListeners(){document.querySelectorAll('input[name="aiProvider"]').forEach((e=>{e.addEventListener("change",(e=>{updateProviderDisplay(e.target.value),saveSettings()}))})),document.getElementById("test-chatgpt").addEventListener("click",(()=>testApiKey("chatgpt"))),document.getElementById("test-anthropic").addEventListener("click",(()=>testApiKey("anthropic"))),document.getElementById("test-gemini").addEventListener("click",(()=>testApiKey("gemini"))),document.getElementById("test-openrouter").addEventListener("click",(()=>testApiKey("openrouter"))),document.getElementById("chatgpt-key").addEventListener("input",saveSettings),document.getElementById("anthropic-key").addEventListener("input",saveSettings),document.getElementById("gemini-key").addEventListener("input",saveSettings),document.getElementById("openrouter-key").addEventListener("input",saveSettings);document.getElementById("activate-btn").addEventListener("click",activateN8nMaster)}function updateProviderDisplay(e){const t=document.getElementById("chatgpt-group"),n=document.getElementById("anthropic-group"),a=document.getElementById("gemini-group"),o=document.getElementById("openrouter-group");t.style.display="none",n.style.display="none",a.style.display="none",o.style.display="none","chatgpt"===e?t.style.display="block":"anthropic"===e?n.style.display="block":"gemini"===e?a.style.display="block":"openrouter"===e&&(o.style.display="block")}async function saveSettings(){try{const e=document.querySelector('input[name="aiProvider"]:checked').value,t=document.getElementById("chatgpt-key").value.trim(),n=document.getElementById("anthropic-key").value.trim(),a=document.getElementById("gemini-key").value.trim(),o=document.getElementById("openrouter-key").value.trim(),T={aiProvider:e,apiKeys:{chatgpt:t,anthropic:n,gemini:a,openrouter:o}};await chrome.storage.local.set(T)}catch(e){showError("Failed to save settings: "+e.message)}}async function testApiKey(e){const t=document.getElementById(`${e}-key`),n=document.getElementById(`${e}-status`),a=document.getElementById(`test-${e}`),o=t.value.trim();if(!o){return void showApiStatus(n,"error",await getLocalizedText("pleaseEnterApiKey","Please enter an API key"))}a.disabled=!0;const i=await getLocalizedText("apiKeyTesting","Testing...");a.innerHTML=`<span class="spinner"></span> ${i}`;showApiStatus(n,"loading",await getLocalizedText("testingApiKey","Testing API key..."));try{const t=await new Promise(((t,n)=>{chrome.runtime.sendMessage({action:"testApiKey",provider:e,apiKey:o},(e=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):t(e)}))}));if(t&&t.success){showApiStatus(n,"success",`✅ ${await getLocalizedText("apiKeyValid","API key is valid and working!")}`),await saveSettings(),await showNotification("success","settingsChanged",!0)}else{showApiStatus(n,"error",`❌ ${t?t.error:"Unknown error occurred"}`)}}catch(e){showApiStatus(n,"error",`❌ ${await getLocalizedText("failedToValidateApiKey","Failed to validate API key")}: ${e.message}`)}finally{a.disabled=!1;const e=await getLocalizedText("testButton","Test");a.textContent=e}}function showApiStatus(e,t,n){e&&(e.className=`api-status ${t}`,e.textContent=n,"success"===t&&setTimeout((()=>{e&&(e.style.display="none")}),3e3))}async function checkPageStatus(){try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e){return void updatePageStatus("error",await getLocalizedText("noActiveTab","No active tab found"),!1)}const t=checkN8nUrl(e.url),n=isN8nButNotWorkflow(e.url);if(t){const t=await chrome.storage.local.get(["activatedSites"]),n=new URL(e.url).origin,a=t.activatedSites?.includes(n);if(a){updatePageStatus("success",await getLocalizedText("n8nMasterIsActive","N8N Master is active on this page"),!1)}else{updatePageStatus("warning",await getLocalizedText("n8nWorkflowDetected","N8N workflow page detected - ready to activate"),!0)}}else if(n){updatePageStatus("warning",await getLocalizedText("n8nMasterNotWorking","N8N Master is not working on this page"),!1)}else try{const t=await chrome.tabs.sendMessage(e.id,{action:"checkN8nPage"});if(t&&t.success)if(t.isN8nPage)if(t.isActivated){updatePageStatus("success",await getLocalizedText("n8nMasterIsActive","N8N Master is active on this page"),!1)}else{updatePageStatus("warning",await getLocalizedText("n8nWorkflowDetected","N8N workflow page detected - ready to activate"),!0)}else{updatePageStatus("error",await getLocalizedText("notN8nPageError","This is not an n8n page"),!1)}else{updatePageStatus("error",await getLocalizedText("notN8nPageError","This is not an n8n page"),!1)}}catch(e){updatePageStatus("error",await getLocalizedText("notN8nPageError","This is not an n8n page"),!1)}}catch(e){updatePageStatus("error",await getLocalizedText("unableToCheck","Unable to check page status"),!1)}}function checkN8nUrl(e){if(!e)return!1;const t=isN8nWebsite(e),n=e.includes("/workflow/");return t&&n}function isN8nButNotWorkflow(e){if(!e)return!1;const t=isN8nWebsite(e),n=e.includes("/workflow/");return t&&!n}async function isLikelyN8nSite(e){if(!e)return!1;try{const{activatedSites:t=[]}=await chrome.storage.local.get("activatedSites"),n=new URL(e).origin;if(t.includes(n))return!0;if(isN8nWebsite(e))return!0;return!!(e.includes("/workflow/")||e.includes("/execution/"))}catch(e){return!1}}function isN8nWebsite(e){if(!e)return!1;try{const t=new URL(e),n=t.hostname.toLowerCase(),a=t.pathname.toLowerCase(),o=e.toLowerCase(),i=[/\.n8n\.cloud$/,/\.n8n\.io$/,/^localhost$/,/^127\.0\.0\.1$/,/^0\.0\.0\.0$/].some((e=>e.test(n))),c=["/home/workflows","/home/executions","/home/credentials","/home/variables","/workflow/","/executions/","/credentials/","/variables/","/settings/","/templates/"].some((e=>a.includes(e))),s=/n8n/i.test(o),r="5678"===t.port;return i||c||s&&(t.port||"/"!==a)||r}catch(t){return/n8n/i.test(e)}}function updatePageStatus(e,t,n){const a=document.querySelector(".status-dot"),o=document.querySelector(".status-text"),i=document.getElementById("activate-btn");if(!a||!o||!i)return;a.className=`status-dot ${e}`,o.textContent=t,i.style.display=n?"block":"none";let c=document.getElementById("disconnect-btn");if("success"===e&&(t.includes("N8N Master is active")||t.includes("N8N Master активен")||t.includes("N8N Master está activo"))){if(!c){c=document.createElement("button"),c.id="disconnect-btn",c.className="btn btn-secondary",getLocalizedText("disconnect","DISCONNECT").then((e=>{c.textContent=e})),c.style.cssText="\n        margin-top: 8px;\n        width: 100%;\n        background: #444444;\n        color: #ffffff;\n        border: 1px solid #666666;\n      ",c.addEventListener("click",disconnectN8nMaster);const e=document.querySelector(".status-card");e&&e.appendChild(c)}c&&(c.style.display="block")}else c&&(c.style.display="none")}async function activateN8nMaster(){const e=document.getElementById("activate-btn");if(e)try{e.disabled=!0;const t=await getLocalizedText("activating","Activating...");e.innerHTML=`<span class="spinner"></span> ${t}`;const[n]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!n){const e=await getLocalizedText("errorNoActiveTab","No active tab found");throw new Error(e)}const a=await chrome.storage.local.get(["aiProvider","apiKeys"]);if(!a.apiKeys||!a.apiKeys[a.aiProvider]){const e=await getLocalizedText("errorConfigureApiKey","Please configure your API key first");throw new Error(e)}const o=new URL(n.url).origin,{activatedSites:i=[]}=await chrome.storage.local.get("activatedSites");i.includes(o)||(i.push(o),await chrome.storage.local.set({activatedSites:i}));try{const e=await chrome.tabs.sendMessage(n.id,{action:"activateN8nMaster"});if(e&&e.success){updatePageStatus("success",await getLocalizedText("n8nMasterActivated","N8N Master activated successfully!"),!1),await showNotification("success","n8nMasterActiveOnPage",!0)}else{updatePageStatus("success",await getLocalizedText("n8nMasterActivated","N8N Master activated (refresh page to see chat)"),!1),await showNotification("success","n8nMasterActivatedRefresh",!0)}}catch(e){updatePageStatus("success",await getLocalizedText("n8nMasterActivated","N8N Master activated (refresh page to see chat)"),!1),await showNotification("success","n8nMasterActivatedRefresh",!0)}}catch(e){showNotification("error",e.message);updatePageStatus("error",await getLocalizedText("activationFailed","Activation failed"),!0)}finally{e&&(e.disabled=!1,e.textContent="АКТИВИРОВАТЬ")}else showNotification("error","UI element not found")}async function showNotification(e,t,n=!1){try{let n;n=await getLocalizedText(t,t);const a=document.createElement("div");a.className=`notification ${e}`,a.style.cssText="\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      padding: 12px 16px;\n      border-radius: 6px;\n      color: white;\n      font-size: 14px;\n      font-weight: 500;\n      z-index: 10000;\n      max-width: 300px;\n      box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n      animation: slideInRight 0.3s ease-out;\n    ","success"===e?a.style.background="#28a745":"error"===e?a.style.background="#dc3545":"warning"===e&&(a.style.background="#ff8c00"),a.textContent=n,document.body.appendChild(a),setTimeout((()=>{a.style.animation="slideOutRight 0.3s ease-out",setTimeout((()=>a.remove()),300)}),3e3)}catch(n){const a=document.createElement("div");a.className=`notification ${e}`,a.style.cssText="\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      padding: 12px 16px;\n      border-radius: 6px;\n      color: white;\n      font-size: 14px;\n      font-weight: 500;\n      z-index: 10000;\n      max-width: 300px;\n      box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n      animation: slideInRight 0.3s ease-out;\n    ","success"===e?a.style.background="#28a745":"error"===e?a.style.background="#dc3545":"warning"===e&&(a.style.background="#ff8c00"),a.textContent=t,document.body.appendChild(a),setTimeout((()=>{a.style.animation="slideOutRight 0.3s ease-out",setTimeout((()=>a.remove()),300)}),3e3)}}function showError(e){showNotification("error",e)}document.addEventListener("DOMContentLoaded",(async()=>{await initializeI18n(),await initializePopup(),setupEventListeners()})),window.testPopupLocalization=async function(){await updatePopupLocalization()},window.testI18nManager=function(){if(window.I18nManager){const e=I18nManager.getCurrentLanguage();if(["autoSave","popup_settings","features","lang_ru","lang_en"].forEach((e=>{I18nManager.getMessage(e),chrome.i18n.getMessage(e)})),"ru"===e){chrome.i18n.getMessage("autoSave"),chrome.i18n.getMessage("popup_settings")}}},window.testManualTranslations=async function(){const e=I18nManager.getCurrentLanguage(),t=await loadTranslations(e);if(t){["autoSave","popup_settings","features"].forEach((e=>{getManualTranslation(t,e)}))}},window.testN8nStatus=async function(){await updateN8nStatus()},window.testModelDisplay=async function(){await chrome.storage.local.get(["selectedModels"]);["chatgpt-model-label","anthropic-model-label","openrouter-model-label"].forEach((e=>{document.getElementById(e)})),await loadAndDisplaySelectedModels()};const style=document.createElement("style");async function disconnectN8nMaster(){const e=document.getElementById("disconnect-btn");try{e.disabled=!0,e.innerHTML='<span class="spinner"></span> Disconnecting...';const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!t){const e=await getLocalizedText("errorNoActiveTab","No active tab found");throw new Error(e)}const n=new URL(t.url).origin,{activatedSites:a=[]}=await chrome.storage.local.get("activatedSites"),o=a.filter((e=>e!==n));await chrome.storage.local.set({activatedSites:o});try{await chrome.tabs.sendMessage(t.id,{action:"deactivateN8nMaster"})}catch(e){}updatePageStatus("warning",await getLocalizedText("n8nPageDetectedReady","N8N page detected - ready to activate"),!0),await showNotification("success","n8nMasterDisconnected",!0)}catch(e){showNotification("error","Failed to disconnect: "+e.message)}finally{e.disabled=!1,getLocalizedText("disconnect","DISCONNECT").then((t=>{e.textContent=t}))}}async function loadAndDisplaySelectedModels(){try{const e=(await chrome.storage.local.get(["selectedModels"])).selectedModels||{},t={"gpt-4o":"GPT-4o","gpt-4o-mini":"GPT-4o Mini","gpt-4-turbo":"GPT-4 Turbo","gpt-4":"GPT-4","gpt-3.5-turbo":"GPT-3.5 Turbo","claude-3-5-sonnet-20241022":"Claude 3.5 Sonnet","claude-3-opus-20240229":"Claude 3 Opus","claude-3-sonnet-20240229":"Claude 3 Sonnet","claude-3-haiku-20240307":"Claude 3 Haiku","claude-sonnet-4-20250514":"Claude 4 Sonnet","claude-opus-4-20250514":"Claude 4 Opus","x-ai/grok-3-beta":"Grok 3 beta","x-ai/grok-2":"Grok 2","x-ai/grok-1":"Grok 1","anthropic/claude-3.5-sonnet":"Claude 3.5 Sonnet","openai/gpt-4o":"GPT-4o","google/gemini-2.0-flash-exp":"Gemini 2.0 Flash"},n={openai:"OpenAI",anthropic:"Anthropic",openrouter:"Openrouter"};for(const[a,o]of Object.entries(e)){const e="openai"===a?"chatgpt-model-label":"openrouter"===a?"openrouter-model-label":`${a}-model-label`,i=document.getElementById(e);if(i&&o){const e=n[a]||a,c=`${e} (${t[o]||o})`;i.textContent=c}}}catch(e){}}style.textContent="\n  @keyframes slideInRight {\n    from {\n      opacity: 0;\n      transform: translateX(100%);\n    }\n    to {\n      opacity: 1;\n      transform: translateX(0);\n    }\n  }\n  \n  @keyframes slideOutRight {\n    from {\n      opacity: 1;\n      transform: translateX(0);\n    }\n    to {\n      opacity: 0;\n      transform: translateX(100%);\n    }\n  }\n",document.head.appendChild(style);